<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visitas Naturgy</title>

<script>
function compareVersions(version1, version2) {
  const parts1 = version1.split('.').map(Number);
  const parts2 = version2.split('.').map(Number);
  const maxLength = Math.max(parts1.length, parts2.length);
  for (let i = 0; i < maxLength; i++) {
    const part1 = parts1[i] || 0;
    const part2 = parts2[i] || 0;
    if (part1 > part2) return 1;
    if (part1 < part2) return -1;
  }
  return 0;
}

const currentVersion = "1.0"; 
const updateUrl = "https://aldairsierra-pruebas.github.io/APKWEBVIEWHTML/update.json?nocache=" + Date.now();

fetch(updateUrl)
  .then(response => {
    if (!response.ok) throw new Error('No se pudo cargar el archivo de actualizaci√≥n.');
    return response.json();
  })
  .then(data => {
    if (compareVersions(data.version, currentVersion) > 0) {
      const overlay = document.createElement("div");
      overlay.id = "update-overlay";
      overlay.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); color: white; display: flex;
        flex-direction: column; align-items: center; justify-content: center;
        text-align: center; padding: 20px; z-index: 9999; font-family: Arial, sans-serif;
      `;
      overlay.innerHTML = `
        <h2 style="margin-bottom: 15px; font-size: 24px;">${data.message}</h2>
        <p style="margin-bottom: 25px; font-size: 16px;">Tu versi√≥n: ${currentVersion} | Nueva versi√≥n: ${data.version}</p>
        <a href="${data.url}"
           style="background: #28a745; color: #fff; text-decoration: none;
                  padding: 12px 24px; border-radius: 8px; font-size: 18px;
                  transition: background-color 0.3s ease;">
           Descargar actualizaci√≥n
        </a>
      `;
      document.body.appendChild(overlay);
    }
  })
  .catch(error => console.warn("No se pudo verificar la versi√≥n:", error));
</script>



  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #map { height: 100vh; transition: height 0.3s ease; }
    #listPanel {
      height: 40vh;
      overflow-y: auto;
      border-top: 2px solid #ccc;
      background: #fff;
      position: fixed;
      bottom: 0;
      width: 100%;
      transition: transform 0.3s ease;
      z-index: 900;
    }
    #listPanel.hidden {
      transform: translateY(100%);
    }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th, td { padding:6px; border:1px solid #ddd; text-align:left; }
    th { background:#f4f4f4; position: sticky; top: 0; cursor: pointer; }
    tr:hover { background:#f0f8ff; cursor:pointer; }

    /* Botones flotantes */
    #locateBtn, #refreshBtn, #toggleBtn {
      position: absolute;
      right: 10px;
      z-index: 1000;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      color: white;
    }
    #locateBtn { top: 10px; background: #007bff; }
    #refreshBtn { top: 60px; background: #17a2b8; }
    #toggleBtn { top: 110px; background: #6f42c1; }

    /* Leyenda */
    #legend {
      padding: 5px;
      font-size: 13px;
      background: #fff;
      border-bottom: 2px solid #ccc;
      position: sticky;
      top: 0;
      z-index: 900;
    }
    .legend-item {
      display: inline-flex;
      align-items: center;
      margin-right: 12px;
    }
    .legend-color {
      width: 14px;
      height: 14px;
      display: inline-block;
      margin-right: 4px;
      border: 1px solid #333;
    }
  </style>
</head>
<body>
  <div id="map">
    <button id="locateBtn">üìç</button>
    <button id="refreshBtn">üîÑ</button>
    <button id="toggleBtn">üìã</button>
  </div>

  <div id="listPanel">
    <div id="legend"></div>
    <table>
      <thead>
        <tr><th>P√≥liza</th><th>Nombre</th><th>Direcci√≥n</th></tr>
      </thead>
      <tbody id="dataTableBody"></tbody>
    </table>
  </div>

<script>
const map = L.map('map').setView([25.6866, -100.3161], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

// Colores pastel por calle
const pastelColors = ['#FFB3BA', '#BAE1FF', '#BAFFC9', '#FFFFBA', '#FFDFBA', '#E3BAFF', '#B5EAD7'];
const streetColors = {};
let currentData = []; // Guardar√° los datos cargados
let markers = [];

// Obtener color para cada calle
function getColorForStreet(street) {
  if (!streetColors[street]) {
    const color = pastelColors[Object.keys(streetColors).length % pastelColors.length];
    streetColors[street] = color;
    // Agregar a leyenda
    const legendItem = document.createElement("div");
    legendItem.className = "legend-item";
    legendItem.innerHTML = `<span class="legend-color" style="background:${color}"></span>${street}`;
    document.getElementById("legend").appendChild(legendItem);
  }
  return streetColors[street];
}

function escapeHtml(text) {
  return text.replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','\"':'&quot;'}[c]));
}

// Cargar datos desde Google Sheets
function loadData() {
  document.getElementById("dataTableBody").innerHTML = '';
  clearMarkers();
  currentData = [];

  Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vQVe0kdrmOnk1W4hL1NwKhC7-2TROeMi-VXaGUtSKlvBlsljjo1KvgfUcdZA8kvADuZBYWJbIsIaqq-/pub?gid=1312490361&single=true&output=csv", {
    download: true,
    header: true,
    complete: function(results) {
      results.data.forEach(row => {
        if (!row.lat || !row.lng) return;
        const lat = parseFloat(row.lat);
        const lng = parseFloat(row.lng);
        if (isNaN(lat) || isNaN(lng)) return;

        currentData.push(row);
      });
      renderTableAndMarkers();
    }
  });
}

// Renderizar tabla y marcadores numerados
function renderTableAndMarkers() {
  const tbody = document.getElementById("dataTableBody");
  tbody.innerHTML = '';
  clearMarkers();

  currentData.forEach((row, index) => {
    const street = row["calle"] || "Sin calle";
    const color = getColorForStreet(street);
    const lat = parseFloat(row.lat);
    const lng = parseFloat(row.lng);

    // Crear √≠cono numerado
    const num = index + 1;
    const colorHex = color.replace('#','');
    const iconUrl = `https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=${num}|${colorHex}|000000`;
    const icon = L.icon({ iconUrl, iconSize: [30, 45], iconAnchor: [15, 45] });
    const marker = L.marker([lat, lng], { icon }).addTo(map);

    const popupHtml = `
      <strong>Colonia:</strong> ${row["Colonia"] || ''}<br/>
      <strong>P√≥liza:</strong> ${row["P√≥liza"] || ''}<br/>
      <strong>Direcci√≥n:</strong> ${row["calle"]||''} ${row["N√∫mero finca"]||''}<br/>
      <strong>Contratante:</strong> ${row["Nombre Contratante"]||''}<br/>
      <strong>Inspector:</strong> ${row["Inspector"]||''}<br/>
      <button onclick="openRoute(${lat},${lng})" style="margin-top:6px;padding:4px 8px;border:1px solid #ccc;border-radius:4px;background:#28a745;color:#fff;cursor:pointer">
        üöó Ver Ruta
      </button>`;
    marker.bindPopup(popupHtml);
    markers.push(marker);

    // Crear fila de tabla
    const tr = document.createElement('tr');
    tr.style.backgroundColor = color;
    tr.dataset.lat = lat;
    tr.dataset.lng = lng;
    tr.dataset.calle = street;
    tr.innerHTML = `
      <td>${escapeHtml(row["P√≥liza"]||'')}</td>
      <td>${escapeHtml(row["Nombre Contratante"]||'')}</td>
      <td>${escapeHtml((row["calle"]||'') + ' ' + (row["N√∫mero finca"]||''))}</td>`;
    tr.addEventListener('click', () => {
      marker.openPopup();
      map.setView([lat, lng], 17);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    tbody.appendChild(tr);
  });
}

// Limpiar marcadores
function clearMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];
}

// Abrir ruta en Google Maps
function openRoute(lat, lng) {
  const gmaps = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
  window.open(gmaps, "_blank");
}

// Ubicaci√≥n actual
document.getElementById("locateBtn").addEventListener("click", () => {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      map.setView([lat, lng], 15);
      L.marker([lat, lng]).addTo(map).bindPopup("üìç Est√°s aqu√≠").openPopup();
    }, () => { alert("No se pudo obtener la ubicaci√≥n."); });
  } else { alert("Geolocalizaci√≥n no soportada en este dispositivo."); }
});

// Refrescar datos
document.getElementById("refreshBtn").addEventListener("click", loadData);

// Mostrar / ocultar tabla
document.getElementById("toggleBtn").addEventListener("click", () => {
  const panel = document.getElementById("listPanel");
  panel.classList.toggle("hidden");
});

// --- ORDENAMIENTO ---
document.querySelectorAll("th").forEach((header, index) => {
  header.addEventListener("click", () => sortTableByColumn(index));
});

let currentSort = { column: null, asc: true };

function sortTableByColumn(columnIndex) {
  const headers = document.querySelectorAll("th");
  const keyNames = ["P√≥liza", "Nombre Contratante", "calle"];

  const key = keyNames[columnIndex];
  const asc = currentSort.column === columnIndex ? !currentSort.asc : true;
  currentSort = { column: columnIndex, asc };

  currentData.sort((a, b) => {
    const valA = (a[key] || '').toString().toLowerCase();
    const valB = (b[key] || '').toString().toLowerCase();
    return asc ? valA.localeCompare(valB, 'es') : valB.localeCompare(valA, 'es');
  });

  // Actualizar indicador
  headers.forEach(th => th.textContent = th.textContent.replace(/[‚ñ≤‚ñº]/g, ""));
  const arrow = asc ? " ‚ñ≤" : " ‚ñº";
  headers[columnIndex].textContent += arrow;

  renderTableAndMarkers();
}

// Cargar datos iniciales
loadData();
</script>
</body>
</html>
