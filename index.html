<!DOCTYPE html>    
<html lang="es">    
<head>    
  <meta charset="UTF-8">    
  <title>Visitas Naturgy</title>      
  <!-- Comprobaci√≥n de versi√≥n -->      
  <script>    
    function compareVersions(v1, v2) {    
      const a = v1.split('.').map(Number), b = v2.split('.').map(Number);    
      for (let i = 0; i < Math.max(a.length, b.length); i++) {    
        const diff = (a[i] || 0) - (b[i] || 0);    
        if (diff) return diff > 0 ? 1 : -1;    
      }    
      return 0;    
    }    
    const currentVersion = "2.0";    
    function checkUpdate() {    
      fetch("https://aldairsierra-pruebas.github.io/APKWEBVIEWHTML/update.json?nocache=" + Date.now())    
        .then(r => { if (!r.ok) throw new Error(); return r.json(); })    
        .then(data => {    
          if (!data || !data.version) return;    
          if (compareVersions(data.version, currentVersion) > 0) {    
            const overlay = document.createElement('div');    
            overlay.id = 'update-overlay';    
            overlay.style.cssText = `    
              position: fixed; top:0; left:0; width:100%; height:100%;    
              background: rgba(0,0,0,0.8); color:#fff; display:flex;    
              align-items:center; justify-content:center; flex-direction:column;    
              text-align:center; padding:20px; z-index:99999; font-family: Arial;    
            `;    
            overlay.innerHTML = `    
              <h2 style="margin-bottom:12px;">${data.message || 'Actualizaci√≥n disponible'}</h2>    
              <p style="margin-bottom:18px;">Versi√≥n actual: ${currentVersion} ‚Äî Nueva: ${data.version}</p>    
              <a href="${data.url}" style="background:#28a745;color:#fff;padding:10px 18px;border-radius:8px;text-decoration:none;font-weight:700;">    
                Descargar actualizaci√≥n    
              </a>    
            `;    
            document.body.appendChild(overlay);    
          }    
        })    
        .catch(()=> console.warn('No se pudo verificar la versi√≥n'));    
    }    
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', checkUpdate); else checkUpdate();    
  </script>      
  
  <!-- MapLibre GL (compatible estilo Mapbox, sin token necesario para demo tiles) -->  
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />  
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>  

  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>      
  
  <style>    
    body { margin:0; font-family: Arial, sans-serif; }    
    #map { height: 100vh; transition: height 0.3s ease; position:relative; }    
    #listPanel {    
      height: 40vh; overflow-y: auto; border-top: 2px solid #ccc; background: #fff;    
      position: fixed; bottom: 0; width: 100%; transition: transform 0.3s ease; z-index: 900;    
    }    
    #listPanel.hidden { transform: translateY(100%); }    
    table { width:100%; border-collapse: collapse; font-size:14px; }    
    th, td { padding:6px; border:1px solid #ddd; text-align:left; }    
    th { background:#f4f4f4; position: sticky; top: 0; cursor: pointer; }    
    tr:hover { background:#f0f8ff; cursor:pointer; }    
  
    #locateBtn, #refreshBtn, #toggleBtn {    
      position: absolute; right: 10px; z-index: 1000;    
      border:none; border-radius:50%; width:40px; height:40px; font-size:18px; cursor:pointer; color:white;    
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);    
    }    
    #locateBtn { top:10px; background:#007bff; }    
    #refreshBtn { top:60px; background:#17a2b8; }    
    #toggleBtn { top:110px; background:#6f42c1; }    

    /* Control br√∫jula (se inserta en el mapa) */  
    .map-compass { position: absolute; top: 10px; left: 10px; z-index: 1100; background: rgba(255,255,255,0.95); border-radius: 8px; padding:8px; box-shadow: 0 1px 6px rgba(0,0,0,.25); width:72px; text-align:center; font-family:Arial; }  
    .compass-rose { width:44px; height:44px; margin:0 auto 6px; background: url('data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">\
        <g transform=\"translate(50,50)\">\
          <circle cx=\"0\" cy=\"0\" r=\"48\" fill=\"none\" stroke=\"#444\" stroke-width=\"2\"/>\
          <polygon points=\"0,-40 7,4 -7,4\" fill=\"#d33\" stroke=\"#800\" stroke-width=\"0.5\"/>\
          <polygon transform=\"rotate(180)\" points=\"0,-40 7,4 -7,4\" fill=\"#444\" opacity=\"0.9\"/>\
        </g>\
      </svg>') no-repeat center/contain; transition: transform .2s ease-out; transform-origin: center center; }  
    .compass-controls { display:flex; gap:4px; justify-content:center; }  
    .compass-btn { font-size:12px; padding:4px 6px; border-radius:4px; border:none; background:#f1f1f1; cursor:pointer; }  
    .compass-status { font-size:12px; color:#333; }  

    /* Marcador usuario */  
    .user-marker { width:18px; height:18px; border-radius:50%; background:#007bff; border:3px solid #fff; box-shadow:0 1px 3px rgba(0,0,0,.4); }  

    .legend-item {    
      display:inline-flex; align-items:center; gap:6px; padding:4px 8px;    
      background:#f7f7f7; border:1px solid #ddd; border-radius:6px; cursor:pointer;    
    }    
    .legend-color { width:14px; height:14px; border:1px solid #333; border-radius:3px; }    
    .legend-item.active { outline:2px solid #007bff; }    
    
    /* estilos del bot√≥n de voz (se usan inline tambi√©n en el popup) */  
    .voice-btn {  
      display:inline-flex; align-items:center; justify-content:center;  
      border:none; cursor:pointer; border-radius:8px; padding:6px 10px; font-size:18px;  
      color:#fff;  
    }  

    /* asegurar que popups sobre el mapa est√©n por encima del panel inferior cuando se abre */
    .mapboxgl-popup { z-index:1200; }  
  </style>    
</head>    
  
<body>    
  <div id="map">    
    <button id="locateBtn">üìç</button>    
    <button id="refreshBtn">üîÑ</button>    
    <button id="toggleBtn">üìã</button>    
    <!-- Contenedor br√∫jula (MapLibre) -->  
    <div id="mapCompass" class="map-compass" aria-hidden="false">  
      <div id="compassRose" class="compass-rose" title="Rotar mapa"></div>  
      <div id="compassLabel" class="compass-status">N: 0¬∞</div>  
      <div class="compass-controls" style="margin-top:6px;">  
        <button id="rotLeft" class="compass-btn" title="Girar -15¬∞">‚ü≤</button>  
        <button id="rotReset" class="compass-btn" title="Reset">‚éå</button>  
        <button id="rotRight" class="compass-btn" title="Girar +15¬∞">‚ü≥</button>  
      </div>  
      <div style="margin-top:6px;">  
        <button id="gyroToggle" class="compass-btn" title="Activar orientaci√≥n por giroscopio" style="width:100%;">üß≠</button>  
      </div>  
    </div>  
  </div>      
  
  <div id="listPanel">    
    <div id="legend"></div>    
    <table>    
      <thead><tr><th>P√≥liza</th><th>Nombre</th><th>Direcci√≥n</th></tr></thead>    
      <tbody id="dataTableBody"></tbody>    
    </table>    
  </div>    
  
  <script>    

  /***** MAPLIBRE (sustituye a Leaflet) *****/
  // Usa el estilo de demo p√∫blico de MapLibre. Para producci√≥n puedes cambiar a otro style JSON (Maptiler / Mapbox con token).
  const map = new maplibregl.Map({
    container: 'map',
    style: 'https://demotiles.maplibre.org/style.json',
    center: [-100.3161, 25.6866], // [lng, lat] (Monterrey / ejemplo)
    zoom: 12,
    bearing: 0,
    pitch: 0
  });

  // quitamos el comp√°s nativo para usar el nuestro
  map.addControl(new maplibregl.NavigationControl({ showCompass: false, showZoom: true }), 'top-left');

  // Datos y estructuras (mantengo nombres de variables)
  const vividColors = ['#ff4d4d','#4d79ff','#33cc33','#ffcc00','#ff66cc','#33cccc','#9933ff','#ff9966'];    
  const streetColors = {};    
  let currentData = [], markers = [], filteredStreet = null, userMarker = null;    
  let currentSort = { column: null, asc: true };

  function ensureColor(street) {    
    if (!streetColors[street]) {    
      streetColors[street] = vividColors[Object.keys(streetColors).length % vividColors.length];    
    }    
    return streetColors[street];    
  }    

  function buildLegend() {    
    const legend = document.getElementById('legend');    
    legend.innerHTML = '';    
    const streets = Array.from(new Set(currentData.map(r => (r["calle"]||'Sin calle')))).sort();    
    streets.forEach(s => {    
      const color = ensureColor(s);    
      const item = document.createElement('div');    
      item.className = 'legend-item';    
      item.innerHTML = `<span class="legend-color" style="background:${color}"></span>${s}`;    
      item.addEventListener('click', () => toggleFilter(s, item));    
      if (filteredStreet === s) item.classList.add('active');    
      legend.appendChild(item);    
    });    
  }    

  // crear SVG marker (retornamos string para element.innerHTML)
  function createMarkerSVG(number, color) {
    return `
      <svg xmlns="http://www.w3.org/2000/svg" width="46" height="62" viewBox="0 0 46 62">
        <path d="M23 62s-18-22-18-34A18 18 0 1 1 41 28c0 12-18 34-18 34z"
          fill="${color}" stroke="#222" stroke-width="2"/>
        <text x="23" y="30" font-family="Arial, Helvetica, sans-serif" font-size="18" font-weight="700" fill="#fff" text-anchor="middle">${number}</text>
      </svg>`;
  }

  function escapeHtml(text) {    
    return (text||'').toString().replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','"':'&quot;'}[c]));    
  }    

  function loadData() {    
    document.getElementById('dataTableBody').innerHTML = '';    
    document.getElementById('legend').innerHTML = '';    
    for (const k in streetColors) delete streetColors[k];    
    // eliminar marcadores antiguos del mapa
    markers.forEach(obj => {
      try { obj.marker.remove(); } catch(e) {}
      if (obj.popup) try { obj.popup.remove(); } catch(e) {}
    });
    markers = [];
    currentData = [];    

    Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vQVe0kdrmOnk1W4hL1NwKhC7-2TROeMi-VXaGUtSKlvBlsljjo1KvgfUcdZA8kvADuZBYWJbIsIaqq-/pub?gid=1312490361&single=true&output=csv", {    
      download: true, header: true,    
      complete: function(results) {    
        results.data.forEach(r => {    
          if (!r || (!r.lat && !r.lng)) return;    
          const lat = parseFloat(r.lat), lng = parseFloat(r.lng);    
          if (isNaN(lat) || isNaN(lng)) return;    
          currentData.push(r);    
        });    
        buildLegend();    
        if (currentSort.column !== null) applySort();    
        renderAll();    
      }    
    });    
  }    

  function renderAll() {    
    const tbody = document.getElementById('dataTableBody');    
    tbody.innerHTML = '';    
    // Eliminar anteriores
    markers.forEach(obj => { try { obj.marker.remove(); } catch(e){} });
    markers = [];

    const list = currentData.filter(r => !filteredStreet || (r["calle"]||'Sin calle') === filteredStreet);    
  
    list.forEach((row, i) => {    
      const street = row["calle"] || 'Sin calle';    
      const color = ensureColor(street);    
      const svg = createMarkerSVG(i+1, color);    
      const lat = parseFloat(row.lat), lng = parseFloat(row.lng);    

      // Crear elemento DOM para marker
      const el = document.createElement('div');
      el.className = 'custom-marker';
      el.style.width = '38px';
      el.style.height = '56px';
      el.style.cursor = 'pointer';
      el.innerHTML = svg;

      // Popup HTML (con IDs √∫nicos)
      const popupIdNext = `next-${i}-${Date.now()}`;
      const popupIdVoice = `voice-${i}-${Date.now()}`;
      const popupHtml = `
        <div style="font-family:Arial,Helvetica,sans-serif;line-height:1.25; position: relative; max-width:220px;">
          <strong>Colonia:</strong> ${escapeHtml(row["Colonia"]||'')}<br/>
          <strong>P√≥liza:</strong> ${escapeHtml(row["P√≥liza"]||'')}<br/>
          <strong>Direcci√≥n:</strong> ${escapeHtml(row["calle"]||'')} ${escapeHtml(row["N√∫mero finca"]||'')}<br/>
          <strong>Contratante:</strong> ${escapeHtml(row["Nombre Contratante"]||'')}<br/>
          <strong>Inspector:</strong> ${escapeHtml(row["Inspector"]||'')}<br/>
          <strong>Estatus:</strong> ${escapeHtml(row["Estatus"]||'')}<br/>
          <div style="margin-top:8px; display:flex; gap:6px;">
            <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank"
               style="background:#007bff;color:#fff;padding:6px 8px;border-radius:6px;text-decoration:none;font-size:13px;">üöó Google</a>
            <a href="https://waze.com/ul?ll=${lat},${lng}&navigate=yes" target="_blank"
               style="background:#ff6600;color:#fff;padding:6px 8px;border-radius:6px;text-decoration:none;font-size:13px;">üß≠ Waze</a>

            <button id="${popupIdVoice}" class="voice-btn" title="Reproducir/Pausar voz" style="background:#28a745;">
              üîà
            </button>
          </div>

          <button id="${popupIdNext}" style="
            position:absolute; bottom:6px; right:6px; padding:4px 8px;
            font-size:12px; background:#28a745; color:#fff; border:none; border-radius:4px; cursor:pointer;">
            Next
          </button>
        </div>`;

      const popup = new maplibregl.Popup({ offset: 18, maxWidth: '260px' }).setHTML(popupHtml);

      const marker = new maplibregl.Marker({ element: el, anchor: 'bottom' })
        .setLngLat([lng, lat])
        .setPopup(popup)
        .addTo(map);

      // Guardar referencia con datos
      markers.push({ marker, data: row, popupIdNext, popupIdVoice, lat, lng });

      // Agregar fila en la tabla
      const tr = document.createElement('tr');    
      tr.style.background = color + '22';    
      tr.innerHTML = `    
        <td>${escapeHtml(row["P√≥liza"]||'')}</td>    
        <td>${escapeHtml(row["Nombre Contratante"]||'')}</td>    
        <td>${escapeHtml((row["calle"]||'') + ' ' + (row["N√∫mero finca"]||''))}</td>`;    
      tr.addEventListener('click', () => { 
        map.flyTo({ center: [lng, lat], zoom: 17, essential: true }); 
        // abrir popup
        marker.togglePopup();
      });    
      tbody.appendChild(tr);

      // Cuando el popup se abre, enlazamos botones Next y Voice
      popup.on('open', () => {
        // Esperar un tick para que el HTML est√© en DOM
        setTimeout(() => {
          try {
            const nextBtn = document.getElementById(popupIdNext);
            const voiceBtn = document.getElementById(popupIdVoice);

            if (nextBtn) {
              nextBtn.onclick = () => {
                // obtener visibles: markers cuyo punto est√© dentro de los bounds actuales
                const bounds = map.getBounds();
                const visibles = markers.filter(m => bounds.contains([m.lng, m.lat]));
                if (visibles.length === 0) {
                  // fallback: todos
                  const all = markers;
                  const idx = all.findIndex(m => m.marker === marker);
                  const next = all[(idx + 1) % all.length];
                  map.flyTo({ center: [next.lng, next.lat], zoom: 17, essential: true });
                  next.marker.togglePopup();
                  return;
                }
                let idx = visibles.findIndex(m => m.marker === marker);
                idx = (idx + 1) % visibles.length;
                const nextMarkerObj = visibles[idx];
                map.flyTo({ center: [nextMarkerObj.lng, nextMarkerObj.lat], zoom: 17, essential: true });
                nextMarkerObj.marker.togglePopup();
              };
            }

            if (voiceBtn) {
              voiceBtn.onclick = () => {
                const markerData = row;
                const pol = markerData["P√≥liza"] || '';
                const nombre = markerData["Nombre Contratante"] || '';
                speakPolizaAndNombre(pol, nombre, voiceBtn);
              };
            }
          } catch (err) {
            console.warn('Error al enlazar botones del popup', err);
          }
        }, 0);
      });

    }); // end forEach
  } // end renderAll

  function toggleFilter(street, itemElement) {    
    const items = document.querySelectorAll('.legend-item');    
    if (filteredStreet === street) {    
      filteredStreet = null;    
      items.forEach(it => it.classList.remove('active'));    
    } else {    
      filteredStreet = street;    
      items.forEach(it => it.classList.toggle('active', it === itemElement));    
    }    
    renderAll();    
  }    

  function applySort() {    
    const col = currentSort.column;    
    const asc = currentSort.asc;    
    if (col === 0) {    
      currentData.sort((a,b) => {    
        const na = parseFloat((a['P√≥liza']||'').toString().replace(/[^\d.-]/g,'')) || 0;    
        const nb = parseFloat((b['P√≥liza']||'').toString().replace(/[^\d.-]/g,'')) || 0;    
        return asc ? na - nb : nb - na;    
      });    
    } else if (col === 1) {    
      currentData.sort((a,b) => {    
        const sa = (a['Nombre Contratante']||'').toLowerCase();    
        const sb = (b['Nombre Contratante']||'').toLowerCase();    
        return asc ? sa.localeCompare(sb,'es') : sb.localeCompare(sa,'es');    
      });    
    } else if (col === 2) {    
      currentData.sort((a,b) => {    
        const ca = (a['calle']||'').toLowerCase();    
        const cb = (b['calle']||'').toLowerCase();    
        if (ca !== cb) return asc ? ca.localeCompare(cb,'es') : cb.localeCompare(ca,'es');    
        const na = parseInt(a['N√∫mero finca']||'') || 0;    
        const nb = parseInt(b['N√∫mero finca']||'') || 0;    
        return asc ? na - nb : nb - na;    
      });    
    }    
  }    

  document.querySelectorAll('th').forEach((th, idx) => {    
    th.addEventListener('click', () => {    
      currentSort.asc = (currentSort.column === idx) ? !currentSort.asc : true;    
      currentSort.column = idx;    
      applySort();    
      document.querySelectorAll('th').forEach(h => h.textContent = h.textContent.replace(/[‚ñ≤‚ñº]/g,''));    
      th.textContent += currentSort.asc ? ' ‚ñ≤' : ' ‚ñº';    
      renderAll();    
    });    
  });    

  // Botones principales    
  document.getElementById('locateBtn').addEventListener('click', () => {    
    if (!navigator.geolocation) return alert('Geolocalizaci√≥n no soportada');    
    navigator.geolocation.getCurrentPosition(pos=>{    
      const lat = pos.coords.latitude, lng = pos.coords.longitude;    
      map.flyTo({ center: [lng, lat], zoom: 15, essential: true });    
      if (userMarker) try { userMarker.remove(); } catch(e){};    
      const el = document.createElement('div'); el.className = 'user-marker';
      userMarker = new maplibregl.Marker({ element: el, anchor: 'center' })
        .setLngLat([lng, lat])
        .setPopup(new maplibregl.Popup({ offset: 12 }).setText('üìç Est√°s aqu√≠'))
        .addTo(map);
      userMarker.getPopup().addTo(map);
    }, ()=>alert('No se pudo obtener la ubicaci√≥n.'));    
  });    

  document.getElementById('refreshBtn').addEventListener('click', loadData);    
  document.getElementById('toggleBtn').addEventListener('click', ()=>document.getElementById('listPanel').classList.toggle('hidden'));    

  // -- Funciones de voz a√±adidas (no tocan el resto de la l√≥gica) --  
  let voiceCanceled = false;  

  function stopSpeech() {  
    voiceCanceled = true;  
    try { window.speechSynthesis.cancel(); } catch (e) { /* ignore */ }  
  }  

  function restoreAllVoiceButtons() {  
    const btns = document.querySelectorAll('.voice-btn');  
    btns.forEach(b => {  
      b.textContent = 'üîà';  
      b.style.background = '#28a745';  
    });  
  }  

  function delay(ms) { return new Promise(res => setTimeout(res, ms)); }  

  async function speakPolizaAndNombre(polizaRaw, nombreRaw, btn) {  
    if (!('speechSynthesis' in window)) { alert('Tu navegador no soporta s√≠ntesis de voz.'); return; }  

    // toggle: si ya est√° hablando -> cancelar  
    if (speechSynthesis.speaking || speechSynthesis.pending) {  
      stopSpeech();  
      restoreAllVoiceButtons();  
      return;  
    }  

    // preparar  
    voiceCanceled = false;  
    btn.textContent = 'üîä';  
    btn.style.background = '#dc3545';  

    // POLIZA: leer d√≠gito por d√≠gito con 1s entre d√≠gitos  
    const poliza = (polizaRaw||'').toString().trim();  
    let digits = poliza.replace(/\D/g,'').split('');  
    if (digits.length === 0 && poliza.length > 0) digits = poliza.split('');  

    for (let d of digits) {  
      if (voiceCanceled) break;  
      const utter = new SpeechSynthesisUtterance(d.toString());  
      utter.lang = 'es-MX';  
      utter.rate = 0.95;  
      const p = new Promise(resolve => { utter.onend = resolve; utter.onerror = resolve; });  
      speechSynthesis.speak(utter);  
      await p;  
      if (voiceCanceled) break;  
      await delay(1000);  
    }  

    if (!voiceCanceled && nombreRaw && nombreRaw.toString().trim().length > 0) {  
      await delay(400);  
      const words = nombreRaw.toString().trim().split(/\s+/).filter(Boolean);  
      for (let w of words) {  
        if (voiceCanceled) break;  
        const utter = new SpeechSynthesisUtterance(w);  
        utter.lang = 'es-MX';  
        utter.rate = 0.95;  
        const p = new Promise(resolve => { utter.onend = resolve; utter.onerror = resolve; });  
        speechSynthesis.speak(utter);  
        await p;  
        if (voiceCanceled) break;  
        await delay(3000); // 3 segundos entre palabras  
      }  
    }  

    stopSpeech();  
    restoreAllVoiceButtons();  
  }  

  // Si cierran popup o cambian de pesta√±a, detenemos la voz  
  map.on('popupclose', () => {  
    stopSpeech();  
    restoreAllVoiceButtons();  
  });  
  document.addEventListener('visibilitychange', () => {  
    if (document.hidden) {  
      stopSpeech();  
      restoreAllVoiceButtons();  
    }  
  });  

  // CARGA INICIAL
  loadData();

  /***** CONTROL BR√öJULA Y GIROSCOPIO *****/
  const rotLeft = document.getElementById('rotLeft');
  const rotRight = document.getElementById('rotRight');
  const rotReset = document.getElementById('rotReset');
  const compassRose = document.getElementById('compassRose');
  const compassLabel = document.getElementById('compassLabel');
  const gyroToggle = document.getElementById('gyroToggle');

  function applyBearing(bearing) {
    // normalizar 0..360
    bearing = ((bearing % 360) + 360) % 360;
    // map.rotateTo usa bearing (grados).
    map.rotateTo(bearing, { duration: 300 });
    // rotar la rosa visual (MapLibre usa coordenadas de web mercator; esta rotaci√≥n es solo visual)
    compassRose.style.transform = `rotate(${bearing}deg)`;
    compassLabel.textContent = `N: ${Math.round(bearing)}¬∞`;
  }

  rotLeft.addEventListener('click', () => {
    const current = map.getBearing() || 0;
    applyBearing(current - 15);
  });
  rotRight.addEventListener('click', () => {
    const current = map.getBearing() || 0;
    applyBearing(current + 15);
  });
  rotReset.addEventListener('click', () => applyBearing(0));

  // Sincronizar rosa al arrastrar/rotar el mapa con mouse/touch
  map.on('rotate', () => {
    const b = map.getBearing() || 0;
    compassRose.style.transform = `rotate(${b}deg)`;
    compassLabel.textContent = `N: ${Math.round(((b%360)+360)%360)}¬∞`;
  });

  // Giroscopio (DeviceOrientation)
  let gyroEnabled = false;
  let smoothing = 0.12; // cu√°nto suavizar (0-1), menor = m√°s suave
  let lastHeading = 0;

  async function enableGyroOrientation() {
    // Permiso en iOS 13+ requiere DeviceOrientationEvent.requestPermission()
    if (typeof DeviceOrientationEvent !== 'undefined' &&
        typeof DeviceOrientationEvent.requestPermission === 'function') {
      try {
        const resp = await DeviceOrientationEvent.requestPermission();
        if (resp !== 'granted') { alert('Permiso de orientaci√≥n denegado'); return false; }
      } catch (e) {
        console.warn('Solicitud de permiso fall√≥', e);
        alert('No fue posible solicitar permiso de orientaci√≥n.');
        return false;
      }
    }
    // Handler
    function handle(event) {
      // event.absolute puede ser true/false; usamos event.alpha (0..360) - rotaci√≥n z
      let alpha = event.alpha;
      if (alpha === null || alpha === undefined) return;
      // Map rotation: alphas se miden relativo al dispositivo; usar 360 - alpha para convertir a bearing aprox.
      let heading = 360 - alpha;
      // Suavizado (filtro exponencial)
      heading = lastHeading * (1 - smoothing) + heading * smoothing;
      lastHeading = heading;
      applyBearing(heading);
    }
    window.addEventListener('deviceorientation', handle, true);
    // Guardamos referencia para poder desactivar (usamos property)
    window._gyroHandler = handle;
    return true;
  }

  function disableGyroOrientation() {
    if (window._gyroHandler) {
      window.removeEventListener('deviceorientation', window._gyroHandler, true);
      window._gyroHandler = null;
    }
  }

  gyroToggle.addEventListener('click', async () => {
    if (!gyroEnabled) {
      const ok = await enableGyroOrientation();
      if (ok) {
        gyroEnabled = true;
        gyroToggle.style.background = '#28a745';
        gyroToggle.textContent = 'üß≠ On';
      }
    } else {
      disableGyroOrientation();
      gyroEnabled = false;
      gyroToggle.style.background = '';
      gyroToggle.textContent = 'üß≠';
    }
  });

  // Si se rota el mapa por APIs externas (ej: flyTo), sincronizar la rosa tambi√©n
  map.on('moveend', () => {
    const b = map.getBearing() || 0;
    compassRose.style.transform = `rotate(${b}deg)`;
    compassLabel.textContent = `N: ${Math.round(((b%360)+360)%360)}¬∞`;
  });

  </script>    
</body>    
</html>