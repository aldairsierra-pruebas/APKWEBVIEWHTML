<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visitas Naturgy</title>

  <!-- Comprobaci√≥n de versi√≥n -->
  <script>
    function compareVersions(v1, v2) {
      const a = v1.split('.').map(Number), b = v2.split('.').map(Number);
      for (let i = 0; i < Math.max(a.length, b.length); i++) {
        const diff = (a[i] || 0) - (b[i] || 0);
        if (diff) return diff > 0 ? 1 : -1;
      }
      return 0;
    }
    const currentVersion = "2.0";
    function checkUpdate() {
      fetch("https://aldairsierra-pruebas.github.io/APKWEBVIEWHTML/update.json?nocache=" + Date.now())
        .then(r => { if (!r.ok) throw new Error(); return r.json(); })
        .then(data => {
          if (!data || !data.version) return;
          if (compareVersions(data.version, currentVersion) > 0) {
            const overlay = document.createElement('div');
            overlay.id = 'update-overlay';
            overlay.style.cssText = `
              position: fixed; top:0; left:0; width:100%; height:100%;
              background: rgba(0,0,0,0.8); color:#fff; display:flex;
              align-items:center; justify-content:center; flex-direction:column;
              text-align:center; padding:20px; z-index:99999; font-family: Arial;
            `;
            overlay.innerHTML = `
              <h2 style="margin-bottom:12px;">${data.message || 'Actualizaci√≥n disponible'}</h2>
              <p style="margin-bottom:18px;">Versi√≥n actual: ${currentVersion} ‚Äî Nueva: ${data.version}</p>
              <a href="${data.url}" style="background:#28a745;color:#fff;padding:10px 18px;border-radius:8px;text-decoration:none;font-weight:700;">
                Descargar actualizaci√≥n
              </a>
            `;
            document.body.appendChild(overlay);
          }
        })
        .catch(()=> console.warn('No se pudo verificar la versi√≥n'));
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', checkUpdate); else checkUpdate();
  </script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>

  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #map { height: 100vh; transition: height 0.3s ease; position: relative; }
    #listPanel {
      height: 40vh; overflow-y: auto; border-top: 2px solid #ccc; background: #fff;
      position: fixed; bottom: 0; width: 100%; transition: transform 0.3s ease; z-index: 900;
    }
    #listPanel.hidden { transform: translateY(100%); }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th, td { padding:6px; border:1px solid #ddd; text-align:left; }
    th { background:#f4f4f4; position: sticky; top: 0; cursor: pointer; }
    tr:hover { background:#f0f8ff; cursor:pointer; }

    #locateBtn, #refreshBtn, #toggleBtn {
      position: absolute; right: 10px; z-index: 1000;
      border:none; border-radius:50%; width:40px; height:40px; font-size:18px; cursor:pointer; color:white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    #locateBtn { top:10px; background:#007bff; }
    #refreshBtn { top:60px; background:#17a2b8; }
    #toggleBtn { top:110px; background:#6f42c1; }

    #legend {
      padding: 6px; font-size:13px; background:#fff; border-bottom:2px solid #ccc; position: sticky; top:0; z-index:900;
      display:flex; flex-wrap:wrap; gap:6px;
    }
    .legend-item {
      display:inline-flex; align-items:center; gap:6px; padding:4px 8px;
      background:#f7f7f7; border:1px solid #ddd; border-radius:6px; cursor:pointer;
    }
    .legend-color { width:14px; height:14px; border:1px solid #333; border-radius:3px; }
    .legend-item.active { outline:2px solid #007bff; }

    /* Estilos del bot√≥n de voz (se usan inline tambi√©n para facilidad dentro del popup) */
    .voice-btn {
      display:inline-flex; align-items:center; justify-content:center;
      border:none; cursor:pointer; border-radius:8px; padding:6px 10px; font-size:18px;
      color:#fff;
    }
  </style>
</head>
<body>
  <div id="map">
    <button id="locateBtn" title="Ubicar">üìç</button>
    <button id="refreshBtn" title="Refrescar">üîÑ</button>
    <button id="toggleBtn" title="Mostrar/ocultar lista">üìã</button>
  </div>

  <div id="listPanel">
    <div id="legend"></div>
    <table>
      <thead><tr><th>P√≥liza</th><th>Nombre</th><th>Direcci√≥n</th></tr></thead>
      <tbody id="dataTableBody"></tbody>
    </table>
  </div>

<script>
  const map = L.map('map').setView([25.6866, -100.3161], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  const vividColors = ['#ff4d4d','#4d79ff','#33cc33','#ffcc00','#ff66cc','#33cccc','#9933ff','#ff9966'];
  const streetColors = {};
  let currentData = [], markers = [], filteredStreet = null, userMarker = null;
  let currentSort = { column: null, asc: true };

  function ensureColor(street) {
    if (!streetColors[street]) {
      streetColors[street] = vividColors[Object.keys(streetColors).length % vividColors.length];
    }
    return streetColors[street];
  }

  function buildLegend() {
    const legend = document.getElementById('legend');
    legend.inner