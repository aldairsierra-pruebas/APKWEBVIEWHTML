<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visitas Naturgy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script>
    function compareVersions(v1, v2) {
      const a = v1.split('.').map(Number), b = v2.split('.').map(Number);
      for (let i = 0; i < Math.max(a.length, b.length); i++) {
        const diff = (a[i] || 0) - (b[i] || 0);
        if (diff) return diff > 0 ? 1 : -1;
      }
      return 0;
    }
    const currentVersion = "2.0";
    function checkUpdate() {
      fetch("https://aldairsierra-pruebas.github.io/APKWEBVIEWHTML/update.json?nocache=" + Date.now())
        .then(r => { if (!r.ok) throw new Error(); return r.json(); })
        .then(data => {
          if (!data || !data.version) return;
          if (compareVersions(data.version, currentVersion) > 0) {
            const overlay = document.createElement('div');
            overlay.id = 'update-overlay';
            overlay.style.cssText = `
              position: fixed; top:0; left:0; width:100%; height:100%;
              background: rgba(0,0,0,0.8); color:#fff; display:flex;
              align-items:center; justify-content:center; flex-direction:column;
              text-align:center; padding:20px; z-index:99999; font-family: Arial;
            `;
            overlay.innerHTML = `
              <h2 style="margin-bottom:12px;">${data.message || 'Actualizaci√≥n disponible'}</h2>
              <p style="margin-bottom:18px;">Versi√≥n actual: ${currentVersion} ‚Äî Nueva: ${data.version}</p>
              <a href="${data.url}" style="background:#28a745;color:#fff;padding:10px 18px;border-radius:8px;text-decoration:none;font-weight:700;">
                Descargar actualizaci√≥n
              </a>
            `;
            document.body.appendChild(overlay);
          }
        })
        .catch(()=> console.warn('No se pudo verificar la versi√≥n'));
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', checkUpdate); else checkUpdate();
  </script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>

  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #map { height: 100vh; transition: height 0.3s ease; }

    /* LIST PANEL (pantalla completa, deslizable) */
    #listPanel {
      position: fixed;
      inset: 0;
      background: #fff;
      z-index: 900;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
      box-shadow: 0 -6px 20px rgba(0,0,0,0.12);
    }
    #listPanel.active {
      transform: translateY(0);
    }

    /* handle para deslizar */
    #panelHandle {
      height: 26px;
      background: #f1f1f1;
      display: flex;
      justify-content: center;
      align-items: center;
      border-bottom: 1px solid #e6e6e6;
    }
    #panelHandle div {
      width: 42px;
      height: 5px;
      background: #999;
      border-radius: 3px;
    }

    /* controles (bot√≥n filtro + leyenda) */
    #controls {
      display:flex;
      gap:8px;
      align-items:center;
      padding: 8px;
      border-bottom: 1px solid #eee;
      flex-wrap:wrap;
    }
    #controls button {
      padding:6px 10px;
      border-radius:6px;
      border:1px solid #ddd;
      background:#fff;
      cursor:pointer;
    }

    #legend {
      padding: 6px; font-size:13px; background:#fff; display:flex; flex-wrap:wrap; gap:6px;
    }
    .legend-item {
      display:inline-flex; align-items:center; gap:6px; padding:4px 8px;
      background:#f7f7f7; border:1px solid #ddd; border-radius:6px; cursor:pointer;
    }
    .legend-item.active { outline:2px solid #007bff; }

    /* tabla */
    #tableWrapper {
      flex: 1;
      overflow-y: auto;
    }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th, td { padding:8px; border-bottom:1px solid #eee; text-align:left; vertical-align:top; }
    th { background:#fafafa; position: sticky; top: 0; z-index: 10; }
    tr:hover { background:#f7fbff; cursor:pointer; }

    .voice-btn {
      display:inline-flex; align-items:center; justify-content:center;
      border:none; cursor:pointer; border-radius:8px; padding:6px 10px; font-size:18px;
      color:#fff;
    }
    small.distance { display:block; margin-top:6px; color:#333; opacity:0.85; font-size:12px; }

    /* modal de calles */
    #streetModal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      z-index: 2000;
    }
    #streetModal .modal {
      background: #fff;
      margin: 10% auto;
      width: 92%;
      max-height: 70%;
      overflow-y: auto;
      border-radius: 10px;
      padding: 12px;
    }
    #streetModal ul { list-style: none; padding: 0; margin: 0; }
    #streetModal li { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }

    /* CORRECCI√ìN: evitar que reglas globales fuerzen posici√≥n absoluta de botones (provocaba encimamiento) */
    #locateBtn,
    #refreshBtn,
    #toggleBtn,
    #autoNarrarBtn {
      position: static;
      right: auto;
      z-index: auto;
    }
  </style>
</head>
<body>
  <div id="map">

  <!-- Contenedor superior derecho -->
  <div style="
    position:absolute;
    top:10px;
    right:10px;
    display:flex;
    flex-direction:column;
    gap:8px;
    z-index:9999; /* M√ÅS alto que el mapa */
  ">

    <button id="locateBtn" style="
      background:#0d6efd;
      color:white;
      border:none;
      border-radius:50%;
      width:40px;
      height:40px;
      font-size:18px;
      cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
    ">üìç</button>

    <button id="refreshBtn" style="
      background:#6c757d;
      color:white;
      border:none;
      border-radius:50%;
      width:40px;
      height:40px;
      font-size:18px;
      cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
    ">üîÑ</button>

    <button id="toggleBtn" style="
      background:#343a40;
      color:white;
      border:none;
      border-radius:50%;
      width:40px;
      height:40px;
      font-size:18px;
      cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
    ">üìã</button>

    <button id="autoNarrarBtn" style="
      background:#198754;
      color:white;
      border:none;
      border-radius:50%;
      width:40px;
      height:40px;
      font-size:18px;
      cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
    ">‚ñ∂Ô∏è</button>

  </div>
</div>

  <!-- PANEL LISTA (pantalla completa, deslizable) -->
  <div id="listPanel" aria-hidden="true">
    <div id="panelHandle"><div></div></div>

    <div id="controls">
      <button id="filterBtn">üìç Filtrar calle</button>
      <button id="hideBtn">‚¨áÔ∏è Ocultar</button>
      <div id="legend" style="flex:1;"></div>
    </div>

    <div id="tableWrapper">
      <table>
        <thead>
          <tr>
            <th data-label="P√≥liza">P√≥liza</th>
            <th data-label="Nombre">Nombre</th>
            <th data-label="Direcci√≥n">Direcci√≥n</th>
          </tr>
        </thead>
        <tbody id="dataTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal calles -->
  <div id="streetModal" aria-hidden="true">
    <div class="modal">
      <h3 style="margin-top:0">Selecciona calle</h3>
      <ul id="streetList"></ul>
    </div>
  </div>

  <script>
  // ---------- MAPA ----------
  const map = L.map('map').setView([25.6866, -100.3161], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  // ---------- ESTADO ----------
  const vividColors = ['#ff4d4d','#4d79ff','#33cc33','#ffcc00','#ff66cc','#33cccc','#9933ff','#ff9966'];
  const streetColors = {};
  let currentData = [], markers = [], filteredStreet = null, userMarker = null;
  let currentSort = { column: null, asc: true };

  // ---------- UTIL ----------
  function ensureColor(street) {
    if (!streetColors[street]) {
      streetColors[street] = vividColors[Object.keys(streetColors).length % vividColors.length];
    }
    return streetColors[street];
  }

  function escapeHtml(text) {
    return (text||'').toString().replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','"':'&quot;'}[c]));
  }

  function createIcon(number, color) {
    const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="46" height="62" viewBox="0 0 46 62">
        <path d="M23 62s-18-22-18-34A18 18 0 1 1 41 28c0 12-18 34-18 34z"
          fill="${color}" stroke="#222" stroke-width="2"/>
        <text x="23" y="30" font-family="Arial, Helvetica, sans-serif" font-size="18" font-weight="700" fill="#fff" text-anchor="middle">${number}</text>
      </svg>`;
    return L.icon({ iconUrl: "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg), iconSize: [38, 56], iconAnchor: [19, 56], popupAnchor: [0, -48] });
  }

  // --------------------------
  // Haversine - distancia en metros
  // --------------------------
  function distanceMeters(lat1, lng1, lat2, lng2) {
    const R = 6371000; // metros
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLng = toRad(lng2 - lng1);
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLng / 2) * Math.sin(dLng / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function clearHeaderSortMarks() {
    document.querySelectorAll('th').forEach(h => {
      const label = h.getAttribute('data-label');
      if (label) h.textContent = label;
      else h.textContent = h.textContent.replace(/[‚ñ≤‚ñº]/g,'');
    });
  }

  function sortByDistance(userLat, userLng) {
    currentData.forEach(r => {
      const lat = parseFloat(r.lat);
      const lng = parseFloat(r.lng);
      if (isNaN(lat) || isNaN(lng)) {
        r._distance = Infinity;
      } else {
        r._distance = distanceMeters(userLat, userLng, lat, lng);
      }
    });

    currentData.sort((a, b) => (a._distance || Infinity) - (b._distance || Infinity));

    // reset any visual sort marks
    currentSort.column = null;
    currentSort.asc = true;
    clearHeaderSortMarks();
  }

  // ---------- CARGAR DATOS ----------
  function loadData() {
    document.getElementById('dataTableBody').innerHTML = '';
    document.getElementById('legend').innerHTML = '';
    for (const k in streetColors) delete streetColors[k];
    markers.forEach(m => map.removeLayer(m)); markers = [];
    currentData = [];

    Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vQVe0kdrmOnk1W4hL1NwKhC7-2TROeMi-VXaGUtSKlvBlsljjo1KvgfUcdZA8kvADuZBYWJbIsIaqq-/pub?gid=1312490361&single=true&output=csv", {
      download: true, header: true,
      complete: function(results) {
        results.data.forEach(r => {
          if (!r || (!r.lat && !r.lng)) return;
          const lat = parseFloat(r.lat), lng = parseFloat(r.lng);
          if (isNaN(lat) || isNaN(lng)) return;
          currentData.push(r);
        });
        buildLegend();
        if (currentSort.column !== null) applySort();
        renderAll();
        // mostrar panel por defecto (si quieres ocultarlo, comenta esta l√≠nea)
        showTable();
      }
    });
  }

  // ---------- RENDER LISTA / MARCADORES ----------
  function buildLegend() {
    const legend = document.getElementById('legend');
    legend.innerHTML = '';
    const streets = Array.from(new Set(currentData.map(r => (r["calle"]||'Sin calle')))).sort();
    streets.forEach(s => {
      const color = ensureColor(s);
      const item = document.createElement('div');
      item.className = 'legend-item';
      item.innerHTML = `<span class="legend-color" style="background:${color}; width:12px; height:12px; display:inline-block; border-radius:2px;"></span> ${escapeHtml(s)}`;
      item.addEventListener('click', () => toggleFilter(s, item));
      if (filteredStreet === s) item.classList.add('active');
      legend.appendChild(item);
    });
  }

  function renderAll() {
    const tbody = document.getElementById('dataTableBody');
    tbody.innerHTML = '';
    markers.forEach(m => map.removeLayer(m)); markers = [];

    const list = currentData.filter(r => !filteredStreet || (r["calle"]||'Sin calle') === filteredStreet);

    list.forEach((row, i) => {
      const street = row["calle"] || 'Sin calle';
      const color = ensureColor(street);
      const icon = createIcon(i+1, color);
      const lat = parseFloat(row.lat), lng = parseFloat(row.lng);

      const marker = L.marker([lat, lng], { icon }).addTo(map);

      // popup
      const popupHtml = `
        <div style="font-family:Arial,Helvetica,sans-serif;line-height:1.25; position: relative;">
          <strong>Colonia:</strong> ${escapeHtml(row["Colonia"]||'')}<br/>
          <strong>P√≥liza:</strong> ${escapeHtml(row["P√≥liza"]||'')}<br/>
          <strong>Direcci√≥n:</strong> ${escapeHtml(row["calle"]||'')} ${escapeHtml(row["N√∫mero finca"]||'')}<br/>
          <strong>Contratante:</strong> ${escapeHtml(row["Nombre Contratante"]||'')}<br/>
          <strong>Inspector:</strong> ${escapeHtml(row["Inspector"]||'')}<br/>
          <strong>Estatus:</strong> ${escapeHtml(row["Estatus"]||'')}<br/><div style="margin-top:8px; display:flex; gap:6px;">

  <!-- Google Maps iOS -->
  <a href="comgooglemaps://?daddr=${lat},${lng}&directionsmode=driving"
     style="background:#007bff;color:#fff;padding:6px 8px;border-radius:6px;text-decoration:none;font-size:13px;">
     üöó Google
  </a>

  <!-- Waze iOS -->
  <a href="waze://?ll=${lat},${lng}&navigate=yes"
     style="background:#ff6600;color:#fff;padding:6px 8px;border-radius:6px;text-decoration:none;font-size:13px;">
     üß≠ Waze
  </a>

  </div>

            <!-- BOT√ìN DE VOZ: mismo bot√≥n ser√° toggle (reproducir / detener) -->
            <button class="voice-btn" title="Reproducir/Pausar voz" style="background:#28a745;">
              üîà
            </button>
          </div>

          <button class="popup-next-btn" style="
            position:absolute; bottom:6px; right:6px; padding:4px 8px;
            font-size:12px; background:#28a745; color:#fff; border:none; border-radius:4px; cursor:pointer;">
            Next
          </button>
        </div>`;

      marker.bindPopup(popupHtml);
      markers.push(marker);

      const distanciaText = (row._distance && isFinite(row._distance))
        ? (row._distance >= 1000 ? ( (row._distance/1000).toFixed(2) + ' km') : Math.round(row._distance) + ' m')
        : '';

      const tr = document.createElement('tr');
      tr.style.background = color + '22';
      tr.innerHTML = `
        <td>${escapeHtml(row["P√≥liza"]||'')}</td>
        <td>${escapeHtml(row["Nombre Contratante"]||'')}</td>
        <td>
          ${escapeHtml((row["calle"]||'') + ' ' + (row["N√∫mero finca"]||''))}
          ${distanciaText ? `<small class="distance">${escapeHtml(distanciaText)}</small>` : ''}
        </td>`;

      // Al hacer click en la fila: abrir popup, centrar y ocultar panel
      tr.addEventListener('click', () => {
        marker.openPopup();
        map.setView([lat, lng], 17);
        hideTable();
      });

      tbody.appendChild(tr);
    });
  }

  // Filtrado por calle (legend deja de ser √∫nico filtro; ahora modal)
  function toggleFilter(street, itemElement) {
    const items = document.querySelectorAll('.legend-item');
    if (filteredStreet === street) {
      filteredStreet = null;
      items.forEach(it => it.classList.remove('active'));
    } else {
      filteredStreet = street;
      items.forEach(it => it.classList.toggle('active', it === itemElement));
    }
    renderAll();
  }

  // Ordenamientos de columnas
  function applySort() {
    const col = currentSort.column;
    const asc = currentSort.asc;
    if (col === 0) {
      currentData.sort((a,b) => {
        const na = parseFloat((a['P√≥liza']||'').toString().replace(/[^\d.-]/g,'')) || 0;
        const nb = parseFloat((b['P√≥liza']||'').toString().replace(/[^\d.-]/g,'')) || 0;
        return asc ? na - nb : nb - na;
      });
    } else if (col === 1) {
      currentData.sort((a,b) => {
        const sa = (a['Nombre Contratante']||'').toLowerCase();
        const sb = (b['Nombre Contratante']||'').toLowerCase();
        return asc ? sa.localeCompare(sb,'es') : sb.localeCompare(sa,'es');
      });
    } else if (col === 2) {
      currentData.sort((a,b) => {
        const ca = (a['calle']||'').toLowerCase();
        const cb = (b['calle']||'').toLowerCase();
        if (ca !== cb) return asc ? ca.localeCompare(cb,'es') : cb.localeCompare(ca,'es');
        const na = parseInt(a['N√∫mero finca']||'') || 0;
        const nb = parseInt(b['N√∫mero finca']||'') || 0;
        return asc ? na - nb : nb - na;
      });
    }
    clearHeaderSortMarks();
  }

  document.querySelectorAll('th').forEach((th, idx) => {
    th.addEventListener('click', () => {
      currentSort.asc = (currentSort.column === idx) ? !currentSort.asc : true;
      currentSort.column = idx;
      applySort();
      document.querySelectorAll('th').forEach(h => h.textContent = h.getAttribute('data-label') || h.textContent.replace(/[‚ñ≤‚ñº]/g,''));
      th.textContent += currentSort.asc ? ' ‚ñ≤' : ' ‚ñº';
      renderAll();
    });
  });

  // ---------- BOTONES PRINCIPALES ----------
  // localizar y ordenar por distancia
  document.getElementById('locateBtn').addEventListener('click', () => {
    if (!navigator.geolocation) {
      alert('Geolocalizaci√≥n no soportada');
      return;
    }

    navigator.geolocation.getCurrentPosition(pos=>{
      const lat = pos.coords.latitude, lng = pos.coords.longitude;

      // Centrar mapa
      map.setView([lat,lng],15);

      // Marcador de usuario
      if (userMarker) map.removeLayer(userMarker);
      userMarker = L.marker([lat,lng]).addTo(map).bindPopup('üìç Est√°s aqu√≠').openPopup();

      // ORDENAR POR CERCAN√çA
      sortByDistance(lat, lng);

      // Re-render completa (tabla y marcadores)
      renderAll();

    }, ()=>alert('No se pudo obtener la ubicaci√≥n.'), {
      enableHighAccuracy: true,
      timeout: 10000
    });
  });

  document.getElementById('refreshBtn').addEventListener('click', loadData);

  // toggle panel con bot√≥n
  const listPanel = document.getElementById('listPanel');
  document.getElementById('toggleBtn').addEventListener('click', () => listPanel.classList.toggle('active'));

  // bot√≥n ocultar del panel
  document.getElementById('hideBtn').addEventListener('click', hideTable);

  // ---------- VOZ (MODIFICADA: separaci√≥n 1 d√≠gito sin pausas) ----------
  let voiceCanceled = false;
  function stopSpeech() {
    voiceCanceled = true;
    try { window.speechSynthesis.cancel(); } catch (e) { /* ignore */ }
  }
  function restoreAllVoiceButtons() {
    const btns = document.querySelectorAll('.voice-btn');
    btns.forEach(b => {
      b.textContent = 'üîà';
      b.style.background = '#28a745';
    });
  }
  function delay(ms) { return new Promise(res => setTimeout(res, ms)); }

  async function speakPolizaAndNombre(polizaRaw, nombreRaw, btn) {
    if (!('speechSynthesis' in window)) { alert('Tu navegador no soporta s√≠ntesis de voz.'); return; }

    if (speechSynthesis.speaking || speechSynthesis.pending) {
      stopSpeech();
      restoreAllVoiceButtons();
      return;
    }

    voiceCanceled = false;
    if (btn) { btn.textContent = 'üîä'; btn.style.background = '#dc3545'; }

    // --- Cambio: separar la p√≥liza en UN d√≠gito por vez y sin pausas adicionales ---
    let pol = (polizaRaw || '').toString().replace(/\D/g, '');
    if (pol && pol.length > 0) {
      for (let ch of pol) {
        if (voiceCanceled) break;
        if (/^\d$/.test(ch)) {
          const u = new SpeechSynthesisUtterance(ch);
          u.lang = 'es-MX';
          u.rate = 1.25;
          const p = new Promise(res => { u.onend = res; u.onerror = res; });
          speechSynthesis.speak(u);
          await p; // esperamos a que termine cada d√≠gito, sin pausas extra
        } else {
          const u = new SpeechSynthesisUtterance(ch);
          u.lang = 'es-MX';
          u.rate = 1.0;
          const p = new Promise(res => { u.onend = res; u.onerror = res; });
          speechSynthesis.speak(u);
          await p;
        }
      }
    }

    if (voiceCanceled) { stopSpeech(); if (btn) { restoreAllVoiceButtons(); } return; }

    await delay(500);

    if (nombreRaw && nombreRaw.toString().trim().length > 0) {
      const palabras = nombreRaw.toString().trim().split(/\s+/).filter(Boolean);
      for (let i = 0; i < palabras.length; i++) {
        if (voiceCanceled) break;
        const w = palabras[i];
        const u = new SpeechSynthesisUtterance(w);
        u.lang = 'es-MX';
        u.rate = 1.0;
        const p = new Promise(res => { u.onend = res; u.onerror = res; });
        speechSynthesis.speak(u);
        await p;
        if (voiceCanceled) break;
        const letras = w.length;
        const pausa = letras * 500;
        await delay(pausa);
      }
    }

    stopSpeech();
    restoreAllVoiceButtons();
  }

  // Modo autom√°tico narrador
  let autoModeActive = false;
  async function narrarAutomaticamente() {
    if (!('speechSynthesis' in window)) { alert('Tu navegador no soporta s√≠ntesis de voz.'); return; }

    if (autoModeActive) {
      autoModeActive = false;
      if (speechSynthesis.speaking) speechSynthesis.cancel();
      document.getElementById('autoNarrarBtn').textContent = '‚ñ∂Ô∏è';
      return;
    }

    autoModeActive = true;
    document.getElementById('autoNarrarBtn').textContent = '‚èπ';

    for (let i = 0; i < currentData.length && autoModeActive; i++) {
      const row = currentData[i];
      const marker = markers[i];
      if (!row || !marker) continue;
      map.setView(marker.getLatLng(), 17);
      marker.openPopup();
      await speakPolizaAndNombre(row['P√≥liza']||'', row['Nombre Contratante']||'', null);
      await delay(2000);
    }

    autoModeActive = false;
    document.getElementById('autoNarrarBtn').textContent = '‚ñ∂Ô∏è';
  }
  document.getElementById('autoNarrarBtn').addEventListener('click', narrarAutomaticamente);

  // popup open handlers (bot√≥n voz / next)
  map.on('popupopen', e => {
    const popupEl = e.popup.getElement();
    const nextBtn = popupEl.querySelector('.popup-next-btn');
    const voiceBtn = popupEl.querySelector('.voice-btn');

    if (nextBtn) {
      nextBtn.onclick = () => {
        const visibles = markers.filter(m => map.hasLayer(m));
        if (visibles.length === 0) return;
        let idx = visibles.findIndex(m => m === e.popup._source);
        idx = (idx + 1) % visibles.length;
        const nextMarker = visibles[idx];
        map.setView(nextMarker.getLatLng(), 17);
        nextMarker.openPopup();
      };
    }

    if (voiceBtn) {
      voiceBtn.onclick = null;
      const markerLat = e.popup._source.getLatLng().lat;
      const markerLng = e.popup._source.getLatLng().lng;
      const markerData = currentData.find(r =>
        parseFloat(r.lat) === markerLat && parseFloat(r.lng) === markerLng
      );
      if (markerData) {
        voiceBtn.onclick = () => {
          if (speechSynthesis.speaking || speechSynthesis.pending) { stopSpeech(); restoreAllVoiceButtons(); return; }
          speakPolizaAndNombre(markerData['P√≥liza']||'', markerData['Nombre Contratante']||'', voiceBtn);
        };
      }
    }
  });

  map.on('popupclose', () => {
    stopSpeech();
    restoreAllVoiceButtons();
  });

  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      stopSpeech();
      restoreAllVoiceButtons();
    }
  });

  // ---------- PANEL SHOW/HIDE y GESTOS ----------
  function showTable() {
    listPanel.classList.add('active');
    listPanel.setAttribute('aria-hidden','false');
  }
  function hideTable() {
    listPanel.classList.remove('active');
    listPanel.setAttribute('aria-hidden','true');
  }

  // swipe down to hide
  let startY = 0;
  listPanel.addEventListener('touchstart', e => {
    startY = e.touches[0].clientY;
  }, { passive:true });

  listPanel.addEventListener('touchend', e => {
    const endY = e.changedTouches[0].clientY;
    if (endY - startY > 80) hideTable();
  }, { passive:true });

  // allow dragging handle (tap on handle toggles)
  const handle = document.getElementById('panelHandle');
  handle.addEventListener('click', () => {
    if (listPanel.classList.contains('active')) hideTable(); else showTable();
  });

  // ---------- MODAL CALLES ----------
  function openStreetModal() {
    renderStreetModal();
    document.getElementById('streetModal').style.display = 'block';
    document.getElementById('streetModal').setAttribute('aria-hidden','false');
  }
  function closeStreetModal() {
    document.getElementById('streetModal').style.display = 'none';
    document.getElementById('streetModal').setAttribute('aria-hidden','true');
  }

  function renderStreetModal() {
    const ul = document.getElementById('streetList');
    ul.innerHTML = '';

    const streets = Array.from(
      new Set(currentData.map(r => (r["calle"]||'Sin calle')))
    ).sort((a,b) => a.localeCompare(b,'es'));

    const liAll = document.createElement('li');
    liAll.textContent = 'Todas';
    liAll.style.fontWeight = '700';
    liAll.onclick = () => {
      filteredStreet = null;
      renderAll();
      closeStreetModal();
    };
    ul.appendChild(liAll);

    streets.forEach(calle => {
      const li = document.createElement('li');
      li.textContent = calle;
      li.onclick = () => {
        filteredStreet = calle;
        renderAll();
        closeStreetModal();
      };
      ul.appendChild(li);
    });
  }

  document.getElementById('streetModal').onclick = e => {
    if (e.target.id === 'streetModal') closeStreetModal();
  };
  document.getElementById('filterBtn').addEventListener('click', openStreetModal);

  // ---------- INICIO ----------
  loadData();
  </script>

  <!-- placeholder (no tocar) -->
  <div state="voice" class="placeholder-icon" id="tts-placeholder-icon" title="Haga clic para mostrar el bot√≥n TTS" style="background-image: url(&quot;moz-extension://eb9243f3-1ee4-4026-ba28-209c2baea838/data/content_script/icons/voice.png&quot;);">
    <canvas width="36" height="36" class="loading-circle" id="text-to-speech-loader" style="display: none;"></canvas>
  </div>
</body>
</html>