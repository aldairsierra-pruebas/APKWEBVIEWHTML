<!DOCTYPE html>  
<html lang="es">  
<head>  
  <meta charset="UTF-8">  
  <title>Visitas Naturgy</title>    
  <!-- Comprobaci√≥n de versi√≥n -->    
  <script>  
    function compareVersions(v1, v2) {  
      const a = v1.split('.').map(Number), b = v2.split('.').map(Number);  
      for (let i = 0; i < Math.max(a.length, b.length); i++) {  
        const diff = (a[i] || 0) - (b[i] || 0);  
        if (diff) return diff > 0 ? 1 : -1;  
      }  
      return 0;  
    }  
    const currentVersion = "2.0";  
    function checkUpdate() {  
      fetch("https://aldairsierra-pruebas.github.io/APKWEBVIEWHTML/update.json?nocache=" + Date.now())  
        .then(r => { if (!r.ok) throw new Error(); return r.json(); })  
        .then(data => {  
          if (!data || !data.version) return;  
          if (compareVersions(data.version, currentVersion) > 0) {  
            const overlay = document.createElement('div');  
            overlay.id = 'update-overlay';  
            overlay.style.cssText = `  
              position: fixed; top:0; left:0; width:100%; height:100%;  
              background: rgba(0,0,0,0.8); color:#fff; display:flex;  
              align-items:center; justify-content:center; flex-direction:column;  
              text-align:center; padding:20px; z-index:99999; font-family: Arial;  
            `;  
            overlay.innerHTML = `  
              <h2 style="margin-bottom:12px;">${data.message || 'Actualizaci√≥n disponible'}</h2>  
              <p style="margin-bottom:18px;">Versi√≥n actual: ${currentVersion} ‚Äî Nueva: ${data.version}</p>  
              <a href="${data.url}" style="background:#28a745;color:#fff;padding:10px 18px;border-radius:8px;text-decoration:none;font-weight:700;">  
                Descargar actualizaci√≥n  
              </a>  
            `;  
            document.body.appendChild(overlay);  
          }  
        })  
        .catch(()=> console.warn('No se pudo verificar la versi√≥n'));  
    }  
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', checkUpdate); else checkUpdate();  
  </script>    

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />  
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>  
  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>    

  <style>  
    body { margin:0; font-family: Arial, sans-serif; }  
    #map { height: 100vh; transition: height 0.3s ease; }  
    #listPanel {  
      height: 40vh; overflow-y: auto; border-top: 2px solid #ccc; background: #fff;  
      position: fixed; bottom: 0; width: 100%; transition: transform 0.3s ease; z-index: 900;  
    }  
    #listPanel.hidden { transform: translateY(100%); }  
    table { width:100%; border-collapse: collapse; font-size:14px; }  
    th, td { padding:6px; border:1px solid #ddd; text-align:left; }  
    th { background:#f4f4f4; position: sticky; top: 0; cursor: pointer; }  
    tr:hover { background:#f0f8ff; cursor:pointer; }  

    #locateBtn, #refreshBtn, #toggleBtn {  
      position: absolute; right: 10px; z-index: 1000;  
      border:none; border-radius:50%; width:40px; height:40px; font-size:18px; cursor:pointer; color:white;  
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);  
    }  
    #locateBtn { top:10px; background:#007bff; }  
    #refreshBtn { top:60px; background:#17a2b8; }  
    #toggleBtn { top:110px; background:#6f42c1; }  

    #legend {  
      padding: 6px; font-size:13px; background:#fff; border-bottom:2px solid #ccc; position: sticky; top:0; z-index:900;  
      display:flex; flex-wrap:wrap; gap:6px;  
    }  
    .legend-item {  
      display:inline-flex; align-items:center; gap:6px; padding:4px 8px;  
      background:#f7f7f7; border:1px solid #ddd; border-radius:6px; cursor:pointer;  
    }  
    .legend-color { width:14px; height:14px; border:1px solid #333; border-radius:3px; }  
    .legend-item.active { outline:2px solid #007bff; }  

    /* estilos del bot√≥n de voz (se usan inline tambi√©n en el popup) */
    .voice-btn {
      display:inline-flex; align-items:center; justify-content:center;
      border:none; cursor:pointer; border-radius:8px; padding:6px 10px; font-size:18px;
      color:#fff;
    }
  </style>  
</head>  

<body>  
  <div id="map">  
    <button id="locateBtn">üìç</button>  
    <button id="refreshBtn">üîÑ</button>  
    <button id="toggleBtn">üìã</button>  
  </div>    

  <div id="listPanel">  
    <div id="legend"></div>  
    <table>  
      <thead><tr><th>P√≥liza</th><th>Nombre</th><th>Direcci√≥n</th></tr></thead>  
      <tbody id="dataTableBody"></tbody>  
    </table>  
  </div>  

  <script>  
  const map = L.map('map').setView([25.6866, -100.3161], 12);  
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);  

  const vividColors = ['#ff4d4d','#4d79ff','#33cc33','#ffcc00','#ff66cc','#33cccc','#9933ff','#ff9966'];  
  const streetColors = {};  
  let currentData = [], markers = [], filteredStreet = null, userMarker = null;  
  let currentSort = { column: null, asc: true };  

  function ensureColor(street) {  
    if (!streetColors[street]) {  
      streetColors[street] = vividColors[Object.keys(streetColors).length % vividColors.length];  
    }  
    return streetColors[street];  
  }  

  function buildLegend() {  
    const legend = document.getElementById('legend');  
    legend.innerHTML = '';  
    const streets = Array.from(new Set(currentData.map(r => (r["calle"]||'Sin calle')))).sort();  
    streets.forEach(s => {  
      const color = ensureColor(s);  
      const item = document.createElement('div');  
      item.className = 'legend-item';  
      item.innerHTML = `<span class="legend-color" style="background:${color}"></span>${s}`;  
      item.addEventListener('click', () => toggleFilter(s, item));  
      if (filteredStreet === s) item.classList.add('active');  
      legend.appendChild(item);  
    });  
  }  

  function createIcon(number, color) {  
    const svg = `  
      <svg xmlns="http://www.w3.org/2000/svg" width="46" height="62" viewBox="0 0 46 62">  
        <path d="M23 62s-18-22-18-34A18 18 0 1 1 41 28c0 12-18 34-18 34z"  
          fill="${color}" stroke="#222" stroke-width="2"/>  
        <text x="23" y="30" font-family="Arial, Helvetica, sans-serif" font-size="18" font-weight="700" fill="#fff" text-anchor="middle">${number}</text>  
      </svg>`;  
    return L.icon({ iconUrl: "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg), iconSize: [38, 56], iconAnchor: [19, 56], popupAnchor: [0, -48] });  
  }  

  function escapeHtml(text) {  
    return (text||'').toString().replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','"':'&quot;'}[c]));  
  }  

  function loadData() {  
    document.getElementById('dataTableBody').innerHTML = '';  
    document.getElementById('legend').innerHTML = '';  
    for (const k in streetColors) delete streetColors[k];  
    markers.forEach(m => map.removeLayer(m)); markers = [];  
    currentData = [];  

    Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vQVe0kdrmOnk1W4hL1NwKhC7-2TROeMi-VXaGUtSKlvBlsljjo1KvgfUcdZA8kvADuZBYWJbIsIaqq-/pub?gid=1312490361&single=true&output=csv", {  
      download: true, header: true,  
      complete: function(results) {  
        results.data.forEach(r => {  
          if (!r || (!r.lat && !r.lng)) return;  
          const lat = parseFloat(r.lat), lng = parseFloat(r.lng);  
          if (isNaN(lat) || isNaN(lng)) return;  
          currentData.push(r);  
        });  
        buildLegend();  
        if (currentSort.column !== null) applySort();  
        renderAll();  
      }  
    });  
  }  

  function renderAll() {  
    const tbody = document.getElementById('dataTableBody');  
    tbody.innerHTML = '';  
    markers.forEach(m => map.removeLayer(m)); markers = [];  

    const list = currentData.filter(r => !filteredStreet || (r["calle"]||'Sin calle') === filteredStreet);  

    list.forEach((row, i) => {  
      const street = row["calle"] || 'Sin calle';  
      const color = ensureColor(street);  
      const icon = createIcon(i+1, color);  
      const lat = parseFloat(row.lat), lng = parseFloat(row.lng);  

      const marker = L.marker([lat, lng], { icon }).addTo(map);  

      // popup: agregamos bot√≥n de voz (sin modificar lo dem√°s)
      const popupHtml = `  
        <div style="font-family:Arial,Helvetica,sans-serif;line-height:1.25; position: relative;">  
          <strong>Colonia:</strong> ${escapeHtml(row["Colonia"]||'')}<br/>  
          <strong>P√≥liza:</strong> ${escapeHtml(row["P√≥liza"]||'')}<br/>  
          <strong>Direcci√≥n:</strong> ${escapeHtml(row["calle"]||'')} ${escapeHtml(row["N√∫mero finca"]||'')}<br/>  
          <strong>Contratante:</strong> ${escapeHtml(row["Nombre Contratante"]||'')}<br/>  
          <strong>Inspector:</strong> ${escapeHtml(row["Inspector"]||'')}<br/>  
          <strong>Estatus:</strong> ${escapeHtml(row["Estatus"]||'')}<br/>  
          <div style="margin-top:8px; display:flex; gap:6px;">  
            <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank"  
               style="background:#007bff;color:#fff;padding:6px 8px;border-radius:6px;text-decoration:none;font-size:13px;">üöó Google</a>  
            <a href="https://waze.com/ul?ll=${lat},${lng}&navigate=yes" target="_blank"  
               style="background:#ff6600;color:#fff;padding:6px 8px;border-radius:6px;text-decoration:none;font-size:13px;">üß≠ Waze</a>  

            <!-- BOT√ìN DE VOZ: mismo bot√≥n ser√° toggle (reproducir / detener) -->
            <button class="voice-btn" title="Reproducir/Pausar voz" style="background:#28a745;">
              üîà
            </button>  
          </div>  

          <button class="popup-next-btn" style="  
            position:absolute; bottom:6px; right:6px; padding:4px 8px;  
            font-size:12px; background:#28a745; color:#fff; border:none; border-radius:4px; cursor:pointer;">  
            Next  
          </button>  
        </div>`;  

      marker.bindPopup(popupHtml);  
      markers.push(marker);  

      const tr = document.createElement('tr');  
      tr.style.background = color + '22';  
      tr.innerHTML = `  
        <td>${escapeHtml(row["P√≥liza"]||'')}</td>  
        <td>${escapeHtml(row["Nombre Contratante"]||'')}</td>  
        <td>${escapeHtml((row["calle"]||'') + ' ' + (row["N√∫mero finca"]||''))}</td>`;  
      tr.addEventListener('click', () => { marker.openPopup(); map.setView([lat, lng], 17); });  
      tbody.appendChild(tr);  
    });  
  }  

  function toggleFilter(street, itemElement) {  
    const items = document.querySelectorAll('.legend-item');  
    if (filteredStreet === street) {  
      filteredStreet = null;  
      items.forEach(it => it.classList.remove('active'));  
    } else {  
      filteredStreet = street;  
      items.forEach(it => it.classList.toggle('active', it === itemElement));  
    }  
    renderAll();  
  }  

  function applySort() {  
    const col = currentSort.column;  
    const asc = currentSort.asc;  
    if (col === 0) {  
      currentData.sort((a,b) => {  
        const na = parseFloat((a['P√≥liza']||'').toString().replace(/[^\d.-]/g,'')) || 0;  
        const nb = parseFloat((b['P√≥liza']||'').toString().replace(/[^\d.-]/g,'')) || 0;  
        return asc ? na - nb : nb - na;  
      });  
    } else if (col === 1) {  
      currentData.sort((a,b) => {  
        const sa = (a['Nombre Contratante']||'').toLowerCase();  
        const sb = (b['Nombre Contratante']||'').toLowerCase();  
        return asc ? sa.localeCompare(sb,'es') : sb.localeCompare(sa,'es');  
      });  
    } else if (col === 2) {  
      currentData.sort((a,b) => {  
        const ca = (a['calle']||'').toLowerCase();  
        const cb = (b['calle']||'').toLowerCase();  
        if (ca !== cb) return asc ? ca.localeCompare(cb,'es') : cb.localeCompare(ca,'es');  
        const na = parseInt(a['N√∫mero finca']||'') || 0;  
        const nb = parseInt(b['N√∫mero finca']||'') || 0;  
        return asc ? na - nb : nb - na;  
      });  
    }  
  }  

  document.querySelectorAll('th').forEach((th, idx) => {  
    th.addEventListener('click', () => {  
      currentSort.asc = (currentSort.column === idx) ? !currentSort.asc : true;  
      currentSort.column = idx;  
      applySort();  
      document.querySelectorAll('th').forEach(h => h.textContent = h.textContent.replace(/[‚ñ≤‚ñº]/g,''));  
      th.textContent += currentSort.asc ? ' ‚ñ≤' : ' ‚ñº';  
      renderAll();  
    });  
  });  

  // Botones principales  
  document.getElementById('locateBtn').addEventListener('click', () => {  
    if (!navigator.geolocation) return alert('Geolocalizaci√≥n no soportada');  
    navigator.geolocation.getCurrentPosition(pos=>{  
      const lat = pos.coords.latitude, lng = pos.coords.longitude;  
      map.setView([lat,lng],15);  
      if (userMarker) map.removeLayer(userMarker);  
      userMarker = L.marker([lat,lng]).addTo(map).bindPopup('üìç Est√°s aqu√≠').openPopup();  
    }, ()=>alert('No se pudo obtener la ubicaci√≥n.'));  
  });  

  document.getElementById('refreshBtn').addEventListener('click', loadData);  
  document.getElementById('toggleBtn').addEventListener('click', ()=>document.getElementById('listPanel').classList.toggle('hidden'));  

  // -- Funciones de voz a√±adidas (no tocan el resto de la l√≥gica) --
  let voiceCanceled = false;

  function stopSpeech() {
    voiceCanceled = true;
    try { window.speechSynthesis.cancel(); } catch (e) { /* ignore */ }
  }

  function restoreAllVoiceButtons() {
    const btns = document.querySelectorAll('.voice-btn');
    btns.forEach(b => {
      b.textContent = 'üîà';
      b.style.background = '#28a745';
    });
  }

  function delay(ms) { return new Promise(res => setTimeout(res, ms)); }

  async function speakPolizaAndNombre(polizaRaw, nombreRaw, btn) {
    if (!('speechSynthesis' in window)) { alert('Tu navegador no soporta s√≠ntesis de voz.'); return; }

    // toggle: si ya est√° hablando -> cancelar
    if (speechSynthesis.speaking || speechSynthesis.pending) {
      stopSpeech();
      restoreAllVoiceButtons();
      return;
    }

    // preparar
    voiceCanceled = false;
    btn.textContent = 'üîä';
    btn.style.background = '#dc3545';

    // POLIZA: leer d√≠gito por d√≠gito con 1s entre d√≠gitos
    const poliza = (polizaRaw||'').toString().trim();
    // extraer solo d√≠gitos; si no hay d√≠gitos, leer el texto completo como fallback (caracter a caracter)
    let digits = poliza.replace(/\D/g,'').split('');
    if (digits.length === 0 && poliza.length > 0) digits = poliza.split('');

    for (let d of digits) {
      if (voiceCanceled) break;
      const utter = new SpeechSynthesisUtterance(d.toString());
      utter.lang = 'es-MX';
      utter.rate = 0.95;
      const p = new Promise(resolve => { utter.onend = resolve; utter.onerror = resolve; });
      speechSynthesis.speak(utter);
      await p;
      // pausa 1 segundo entre d√≠gitos
      // Si fue cancelado durante la reproducci√≥n, speechSynthesis.speaking will be false but voiceCanceled is set by stopSpeech
      if (voiceCanceled) break;
      await delay(1000);
    }

    if (!voiceCanceled && nombreRaw && nombreRaw.toString().trim().length > 0) {
      // peque√±a separaci√≥n antes del nombre
      await delay(400);

      // NOMBRE: palabra por palabra con 3s entre palabras
      const words = nombreRaw.toString().trim().split(/\s+/).filter(Boolean);
      for (let w of words) {
        if (voiceCanceled) break;
        const utter = new SpeechSynthesisUtterance(w);
        utter.lang = 'es-MX';
        utter.rate = 0.95;
        const p = new Promise(resolve => { utter.onend = resolve; utter.onerror = resolve; });
        speechSynthesis.speak(utter);
        await p;
        if (voiceCanceled) break;
        await delay(3000); // 3 segundos entre palabras
      }
    }

    // terminar: restaurar bot√≥n si no fue cancelado por otro medio
    stopSpeech(); // ensure speech canceled/no pending state
    restoreAllVoiceButtons();
  }

  // Bot√≥n Next dentro del popup + SETUP del bot√≥n de voz
  map.on('popupopen', e => {
    const popupEl = e.popup.getElement();
    const nextBtn = popupEl.querySelector('.popup-next-btn');
    const voiceBtn = popupEl.querySelector('.voice-btn');

    // --- Next (tu c√≥digo original) ---
    if (nextBtn) {
      nextBtn.onclick = () => {
        const visibles = markers.filter(m => map.hasLayer(m));
        if (visibles.length === 0) return;

        let idx = visibles.findIndex(m => m === e.popup._source);
        idx = (idx + 1) % visibles.length;
        const nextMarker = visibles[idx];

        map.setView(nextMarker.getLatLng(), 17);
        nextMarker.openPopup();
      };
    }

    // --- Voice: enlazamos con el mismo registro seg√∫n lat/lng ---
    if (voiceBtn) {
      // limpiamos handlers anteriores
      voiceBtn.onclick = null;

      // Encontrar el registro actual seg√∫n lat/lng del marker origen del popup
      const markerLat = e.popup._source.getLatLng().lat;
      const markerLng = e.popup._source.getLatLng().lng;
      const markerData = currentData.find(r =>
        parseFloat(r.lat) === markerLat && parseFloat(r.lng) === markerLng
      );

      if (markerData) {
        voiceBtn.onclick = () => {
          const pol = markerData["P√≥liza"] || '';
          const nombre = markerData["Nombre Contratante"] || '';
          speakPolizaAndNombre(pol, nombre, voiceBtn);
        };
      }
    }
  });

  // Si cierran popup o cambian de pesta√±a, detenemos la voz
  map.on('popupclose', () => {
    stopSpeech();
    restoreAllVoiceButtons();
  });
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      stopSpeech();
      restoreAllVoiceButtons();
    }
  });

  // Inicio  
  loadData();  
  </script>  
</body>  
</html>
