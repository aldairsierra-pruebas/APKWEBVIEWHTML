<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visitas Naturgy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script>
    function compareVersions(v1, v2) {
      const a = v1.split('.').map(Number), b = v2.split('.').map(Number);
      for (let i = 0; i < Math.max(a.length, b.length); i++) {
        const diff = (a[i] || 0) - (b[i] || 0);
        if (diff) return diff > 0 ? 1 : -1;
      }
      return 0;
    }
    const currentVersion = "2.0.0";
    function checkUpdate() {
      fetch("https://aldairsierra-pruebas.github.io/APKWEBVIEWHTML/update.json?nocache=" + Date.now())
        .then(r => { if (!r.ok) throw new Error(); return r.json(); })
        .then(data => {
          if (!data || !data.version) return;
          if (compareVersions(data.version, currentVersion) > 0) {
            const overlay = document.createElement('div');
            overlay.id = 'update-overlay';
            overlay.style.cssText = `
              position: fixed; top:0; left:0; width:100%; height:100%;
              background: rgba(0,0,0,0.8); color:#fff; display:flex;
              align-items:center; justify-content:center; flex-direction:column;
              text-align:center; padding:20px; z-index:99999; font-family: Arial;
            `;
            overlay.innerHTML = `
              <h2 style="margin-bottom:12px;">${data.message || 'Actualizaci√≥n disponible'}</h2>
              <p style="margin-bottom:18px;">Versi√≥n actual: ${currentVersion} ‚Äî Nueva: ${data.version}</p>
              <a href="${data.url}" style="background:#28a745;color:#fff;padding:10px 18px;border-radius:8px;text-decoration:none;font-weight:700;">
                Descargar actualizaci√≥n
              </a>
            `;
            document.body.appendChild(overlay);
          }
        })
        .catch(()=> console.warn('No se pudo verificar la versi√≥n'));
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', checkUpdate); else checkUpdate();
  </script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>

  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #map { height: 100vh; transition: height 0.3s ease; }

    /* LIST PANEL (pantalla completa, deslizable) */
    #listPanel {
      position: fixed;
      inset: 0;
      background: #fff;
      z-index: 900;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
      box-shadow: 0 -6px 20px rgba(0,0,0,0.12);
    }
    #listPanel.active { transform: translateY(0); }

    /* handle para deslizar */
    #panelHandle {
      height: 26px;
      background: #f1f1f1;
      display: flex;
      justify-content: center;
      align-items: center;
      border-bottom: 1px solid #e6e6e6;
    }
    #panelHandle div { width: 42px; height: 5px; background: #999; border-radius: 3px; }

    /* controles (bot√≥n filtro + leyenda) */
    #controls {
      display:flex;
      gap:8px;
      align-items:center;
      padding: 8px;
      border-bottom: 1px solid #eee;
      flex-wrap:wrap;
    }
    #controls button {
      padding:6px 10px;
      border-radius:6px;
      border:1px solid #ddd;
      background:#fff;
      cursor:pointer;
    }

    #legend { padding: 6px; font-size:13px; background:#fff; display:flex; flex-wrap:wrap; gap:6px; }
    .legend-item { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; background:#f7f7f7; border:1px solid #ddd; border-radius:6px; cursor:pointer; }
    .legend-item.active { outline:2px solid #007bff; }

    /* tabla */
    #tableWrapper { flex: 1; overflow-y: auto; }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th, td { padding:8px; border-bottom:1px solid #eee; text-align:left; vertical-align:top; }
    th { background:#fafafa; position: sticky; top: 0; z-index: 10; }
    tr:hover { background:#f7fbff; cursor:pointer; }

    .voice-btn {
      display:inline-flex; align-items:center; justify-content:center;
      border:none; cursor:pointer; border-radius:8px; padding:6px 10px; font-size:18px;
      color:#fff;
    }
    small.distance { display:block; margin-top:6px; color:#333; opacity:0.85; font-size:12px; }

    /* modal de calles y adicional */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: 2000; }
    .modal-backdrop .modal { background: #fff; margin: 10% auto; width: 92%; max-height: 70%; overflow-y: auto; border-radius: 10px; padding: 12px; }
    .modal-backdrop ul { list-style: none; padding: 0; margin: 0; }
    .modal-backdrop li { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }

    /* CORRECCI√ìN: evitar que reglas globales fuerzen posici√≥n absoluta de botones (provocaba encimamiento) */
    #locateBtn, #refreshBtn, #toggleBtn, #autoNarrarBtn, #actionMenuBtn, #importFirebaseBtn, #viewInspectionsBtn { position: static; right: auto; z-index: auto; }

    #topActions { position:absolute; top:10px; right:10px; display:flex; flex-direction:column; gap:8px; z-index:9999; align-items:flex-end; }
    #actionMenu { display:none; flex-direction:column; gap:8px; padding:8px; background:rgba(255,255,255,0.95); border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.25); }
    #actionMenu.active { display:flex; }

    .quick-btn { background:#0d6efd;color:white;border:none;border-radius:50%;width:40px;height:40px;font-size:18px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.3); }
    .quick-btn.gray { background:#6c757d; }
    .quick-btn.green { background:#198754; }
    .quick-btn.dark { background:#343a40; }
    .quick-btn.cyan { background:#0dcaf0; }
    .quick-btn.orange { background:#fd7e14; }

    #inspectionsModal .modal { margin: 6% auto; width: 95%; max-width: 900px; max-height: 82%; }
    #inspectionsTable { width:100%; border-collapse:collapse; font-size:13px; }
    #inspectionsTable th, #inspectionsTable td { border-bottom:1px solid #eee; padding:8px; text-align:left; }
    #inspectionsTable th { background:#f8f9fa; position:sticky; top:0; }

    #importModal .modal { margin: 4% auto; width: 96%; max-width: 1200px; max-height: 88%; }
    #importExcelTable { width:100%; border-collapse: collapse; font-size: 13px; }
    #importExcelTable th, #importExcelTable td { border:1px solid #ddd; padding:6px; text-align:left; min-width:120px; }
    #importExcelTable th { background:#f8f9fa; position: sticky; top: 0; z-index: 2; }
    #importExcelTable td[contenteditable="true"] { background: #fffef2; }
    #importStatus { font-size:12px; color:#555; }

    /* small responsive tweak for popup */
    .leaflet-popup-content-wrapper { box-sizing: border-box; }
  </style>
</head>
<body>
  <!-- map -->
  <div id="map"></div>

  <!-- Controles superiores -->
  <div id="topActions">
    <button id="actionMenuBtn" class="quick-btn dark" title="Mostrar / ocultar funciones">‚ò∞</button>
    <div id="actionMenu" aria-hidden="true">
      <button id="locateBtn" class="quick-btn" title="Ordenar por cercan√≠a">üìç</button>
      <button id="refreshBtn" class="quick-btn gray" title="Recargar base">üîÑ</button>
      <button id="autoNarrarBtn" class="quick-btn green" title="Narrador autom√°tico">‚ñ∂Ô∏è</button>
    </div>
    <button id="toggleBtn" class="quick-btn dark" title="Mostrar lista">üìã</button>
    <button id="importFirebaseBtn" class="quick-btn cyan" title="Importar base a Firebase">‚òÅÔ∏è</button>
    <button id="viewInspectionsBtn" class="quick-btn orange" title="Ver inspecciones de Firebase">üóÇÔ∏è</button>
  </div>

  <!-- PANEL LISTA -->
  <div id="listPanel" aria-hidden="true">
    <div id="panelHandle"><div></div></div>

    <div id="controls">
      <button id="filterBtn">üìç Filtrar calle</button>
      <button id="filterAdicionalBtn">üîé Filtrar adicional</button>
      <select id="viewModeSelect" style="padding:6px 8px;border:1px solid #ddd;border-radius:6px;">
        <option value="latest" selected>√öltima carga</option>
        <option value="global">Global hist√≥rico</option>
      </select>
      <select id="filterColoniaSelect" style="padding:6px 8px;border:1px solid #ddd;border-radius:6px;">
        <option value="">Colonia: todas</option>
      </select>
      <select id="filterFechaSelect" style="padding:6px 8px;border:1px solid #ddd;border-radius:6px;">
        <option value="">Fecha importaci√≥n: todas</option>
      </select>
      <button id="reloadFirebaseBtn">‚ü≥ Ver datos</button>
      <button id="hideBtn">‚¨áÔ∏è Ocultar</button>
      <div id="legend" style="flex:1;"></div>
    </div>

    <div id="tableWrapper">
      <table>
        <thead>
          <tr>
            <th data-label="‚úî">‚úî</th>
            <th data-label="P√≥liza">P√≥liza</th>
            <th data-label="Nombre">Nombre</th>
            <th data-label="Direcci√≥n">Direcci√≥n</th>
            <th data-label="Adicional">Adicional</th>
          </tr>
        </thead>
        <tbody id="dataTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Modales -->
  <div id="streetModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal">
      <h3 style="margin-top:0">Selecciona calle</h3>
      <ul id="streetList"></ul>
    </div>
  </div>

  <div id="adicionalModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal">
      <h3 style="margin-top:0">Selecciona valor de Adicional</h3>
      <ul id="adicionalList"></ul>
    </div>
  </div>



  <div id="inspectionsModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <h3 style="margin:0;">Inspecciones realizadas (Firebase)</h3>
        <button id="closeInspectionsModalBtn" style="padding:6px 10px;border:1px solid #ddd;border-radius:6px;background:#fff;cursor:pointer;">Cerrar</button>
      </div>
      <div style="overflow:auto; margin-top:10px; max-height:65vh;">
        <table id="inspectionsTable">
          <thead>
            <tr>
              <th>#</th>
              <th>P√≥liza</th>
              <th>Nombre</th>
              <th>Direcci√≥n</th>
              <th>Inspector</th>
              <th>Fecha</th>
            </tr>
          </thead>
          <tbody id="inspectionsTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
  <div id="importModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <h3 style="margin:0;">Importar base (pegar desde Excel)</h3>
        <button id="closeImportModalBtn" style="padding:6px 10px;border:1px solid #ddd;border-radius:6px;background:#fff;cursor:pointer;">Cerrar</button>
      </div>
      <p style="margin:8px 0 6px; font-size:13px; color:#555;">Copia desde Excel y pega en la primera celda amarilla. El orden es: P√≥liza, calle, N√∫mero finca, Colonia, Municipio, Nombre Contratante, Empresa, Inspector, Adicional.</p>
      <div style="display:flex; gap:8px; margin:8px 0; flex-wrap:wrap;">
        <button id="addImportRowBtn" style="padding:6px 10px;border:1px solid #ddd;border-radius:6px;background:#fff;cursor:pointer;">+ Fila</button>
        <button id="clearImportTableBtn" style="padding:6px 10px;border:1px solid #ddd;border-radius:6px;background:#fff;cursor:pointer;">Limpiar</button>
        <button id="processImportBtn" style="padding:6px 10px;border:1px solid #0d6efd;border-radius:6px;background:#0d6efd;color:#fff;cursor:pointer;">Procesar + Geocodificar + Guardar Firebase</button>
      </div>
      <div style="display:grid; gap:6px; margin-bottom:8px;">
        <label style="font-size:12px; color:#444;">URL Web App (Apps Script Maps.newGeocoder) - opcional y recomendado
          <input id="appsScriptGeocoderUrl" type="text" placeholder="https://script.google.com/macros/s/.../exec" style="width:100%; margin-top:4px; padding:6px 8px; border:1px solid #ddd; border-radius:6px;">
        </label>
        <small style="color:#666;">Si defines esta URL, se usa primero (m√°s preciso para n√∫mero exterior). Si falla, usa respaldo autom√°tico.</small>
      </div>
      <div id="importStatus">Listo para pegar datos.</div>
      <div style="margin-top:8px;">
        <div style="height:8px;background:#e9ecef;border-radius:999px;overflow:hidden;">
          <div id="importProgressBar" style="height:100%;width:0%;background:#0d6efd;transition:width 0.2s;"></div>
        </div>
        <div id="importProgressText" style="font-size:12px;color:#666;margin-top:4px;">0%</div>
      </div>
      <div style="overflow:auto; margin-top:10px; max-height:58vh;">
        <table id="importExcelTable">
          <thead>
            <tr>
              <th>P√≥liza</th>
              <th>calle</th>
              <th>N√∫mero finca</th>
              <th>Colonia</th>
              <th>Municipio</th>
              <th>Nombre Contratante</th>
              <th>Empresa</th>
              <th>Inspector</th>
              <th>Adicional</th>
            </tr>
          </thead>
          <tbody id="importExcelTbody"></tbody>
        </table>
      </div>
    </div>
  </div>


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, setDoc, collectionGroup } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBLqVCqW2s7piZQUH0dHODjK4JXAv74TdA",
      authDomain: "asl-apk.firebaseapp.com",
      projectId: "asl-apk",
      storageBucket: "asl-apk.firebasestorage.app",
      messagingSenderId: "803053462437",
      appId: "1:803053462437:web:b2f4ccb8cd63c489c77e4c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.firebaseBaseReady = false;

    function normalizePolizaDocId(poliza) {
      const raw = (poliza || '').toString().trim();
      if (!raw) return 'SIN_POLIZA';
      return raw.replace(/\//g, '_');
    }

    function mapToPayload(row, importedAt) {
      return {
        poliza: row['P√≥liza'] || '',
        calle: row['calle'] || '',
        numeroFinca: row['N√∫mero finca'] || '',
        colonia: row['Colonia'] || '',
        municipio: row['Municipio'] || '',
        nombreContratante: row['Nombre Contratante'] || '',
        empresa: row['Empresa'] || '',
        inspector: row['Inspector'] || '',
        adicional: row['Adicional'] || '',
        lat: row.lat || '',
        lng: row.lng || '',
        importadoEn: importedAt
      };
    }

    function parseInspectionDate(raw) {
      if (!raw) return null;
      const text = String(raw).trim();
      const direct = new Date(text);
      if (!isNaN(direct.getTime())) return direct;
      const m = text.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})$/);
      if (m) {
        const day = Number(m[1]);
        const month = Number(m[2]) - 1;
        const year = Number(m[3].length === 2 ? `20${m[3]}` : m[3]);
        const d = new Date(year, month, day);
        if (!isNaN(d.getTime())) return d;
      }
      return null;
    }

    window.fetchVisitedMapFromFirebase = async function fetchVisitedMapFromFirebase() {
      const map = {};
      try {
        const snapshot = await getDocs(collection(db, 'VisitasPolizas'));
        snapshot.forEach(d => {
          const row = d.data() || {};
          const poliza = (row.poliza || '').toString().trim();
          if (poliza) map[poliza] = !!row.visited;
        });
      } catch (err) {
        console.warn('No se pudo leer VisitasPolizas', err?.code || err);
      }
      return map;
    };

    window.syncVisitedStatusToFirebase = async function syncVisitedStatusToFirebase(poliza, visited) {
      const key = (poliza || '').toString().trim();
      if (!key) return;
      try {
        await setDoc(doc(db, 'VisitasPolizas', normalizePolizaDocId(key)), {
          poliza: key,
          visited: !!visited,
          updatedAt: new Date().toISOString()
        }, { merge: true });
      } catch (err) {
        console.warn('No se pudo guardar visita en Firebase', err?.code || err);
      }
    };

    window.fetchRecentInspectionMap = async function fetchRecentInspectionMap() {
      const map = {};
      try {
        const snapshot = await getDocs(collection(db, 'Inspecciones'));
        const threshold = new Date();
        threshold.setMonth(threshold.getMonth() - 3);

        snapshot.forEach(d => {
          const row = d.data() || {};
          const poliza = (row?.cliente?.poliza || '').toString().trim();
          if (!poliza) return;
          const dt = parseInspectionDate(row?.inspeccion?.fecha || row?.createdAt || row?.created_at);
          if (!dt || dt < threshold) return;

          const prev = map[poliza] ? parseInspectionDate(map[poliza]) : null;
          if (!prev || dt > prev) map[poliza] = dt.toISOString();
        });
      } catch (err) {
        console.warn('No se pudo consultar inspecciones recientes', err?.code || err);
      }
      return map;
    };


    async function readFirstAvailableCollection(collectionNames = []) {
      for (const name of collectionNames) {
        try {
          const snapshot = await getDocs(collection(db, name));
          const rows = [];
          snapshot.forEach(d => rows.push({ id: d.id, ...d.data(), _sourceCollection: name }));
          return rows;
        } catch (err) {
          console.warn(`No se pudo leer colecci√≥n ${name}`, err?.code || err);
        }
      }
      return [];
    }

    window.fetchBaseRowsFromFirebase = async function fetchBaseRowsFromFirebase(mode = 'latest') {
      let rows = [];
      if (mode === 'global') {
        try {
          const snapshot = await getDocs(collectionGroup(db, 'importaciones'));
          snapshot.forEach(d => rows.push({ id: d.id, ...d.data(), _sourceCollection: 'importaciones' }));
        } catch (err) {
          console.warn('collectionGroup(importaciones) no disponible, usando fallback', err?.code || err);
          rows = await readFirstAvailableCollection(['BasePolizasGlobal', 'BasePolizas']);
        }
      } else {
        rows = await readFirstAvailableCollection(['BasePolizasUltimaActualizacion', 'BasePolizas']);
      }

      rows.sort((a, b) => String(b.importadoEn || '').localeCompare(String(a.importadoEn || '')));
      return rows.map(r => ({
        'P√≥liza': r.poliza || '',
        'calle': r.calle || '',
        'N√∫mero finca': r.numeroFinca || r.numero_finca || '',
        'Colonia': r.colonia || '',
        'Municipio': r.municipio || '',
        'Nombre Contratante': r.nombreContratante || r.nombre || '',
        'Empresa': r.empresa || '',
        'Inspector': r.inspector || '',
        'Adicional': r.adicional || '',
        lat: r.lat || '',
        lng: r.lng || '',
        importadoEn: r.importadoEn || ''
      }));
    };

    window.importDatabaseToFirebase = async function importDatabaseToFirebase() {
      const source = Array.isArray(window.pendingImportData) && window.pendingImportData.length ? window.pendingImportData : window.currentData;
      const data = Array.isArray(source) ? source : [];
      if (!data.length) { alert('No hay datos cargados para importar.'); return; }
      if (!confirm(`¬øImportar ${data.length} registros a Firebase?`)) return;

      const importedAt = new Date().toISOString();
      const latestCollection = collection(db, 'BasePolizasUltimaActualizacion');
      const legacyCollection = collection(db, 'BasePolizas');

      let ok = 0;
      let fail = 0;

      // Limpiar tabla de √∫ltima actualizaci√≥n (si hay permisos)
      try {
        const latestSnapshot = await getDocs(latestCollection);
        for (const d of latestSnapshot.docs) {
          await deleteDoc(doc(db, 'BasePolizasUltimaActualizacion', d.id));
        }
      } catch (err) {
        console.warn('No se pudo limpiar BasePolizasUltimaActualizacion', err?.code || err);
      }

      for (const row of data) {
        const payload = mapToPayload(row, importedAt);

        try {
          const polizaDocId = normalizePolizaDocId(payload.poliza);
          const polizaDocRef = doc(db, 'BasePolizasGlobal', polizaDocId);

          await setDoc(polizaDocRef, {
            poliza: payload.poliza,
            actualizadoEn: importedAt,
            ultimaImportacion: payload.importadoEn
          }, { merge: true });

          // Registro consecutivo por fecha dentro de cada p√≥liza (permite misma p√≥liza en distintos meses/a√±os)
          await addDoc(collection(db, 'BasePolizasGlobal', polizaDocId, 'importaciones'), payload);

          // Snapshot de √∫ltima actualizaci√≥n para vista por defecto
          try {
            await addDoc(latestCollection, payload);
          } catch (err) {
            console.warn('No se pudo escribir BasePolizasUltimaActualizacion', err?.code || err);
          }

          // Compatibilidad con reglas antiguas
          try {
            await addDoc(legacyCollection, payload);
          } catch (err) {
            console.warn('No se pudo escribir BasePolizas', err?.code || err);
          }

          ok++;
        } catch (err) {
          console.error('Error importando registro', row, err);
          fail++;
        }
      }

      window.pendingImportData = null;
      alert(`Importaci√≥n finalizada. ‚úÖ ${ok} | ‚ùå ${fail}`);
    };

    window.firebaseBaseReady = true;

    window.loadInspectionsFromFirebase = async function loadInspectionsFromFirebase() {
      const tbody = document.getElementById('inspectionsTableBody');
      tbody.innerHTML = '<tr><td colspan="6">Cargando...</td></tr>';
      try {
        const snapshot = await getDocs(collection(db, 'Inspecciones'));
        const rows = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        rows.sort((a, b) => String(b?.inspeccion?.fecha || '').localeCompare(String(a?.inspeccion?.fecha || '')));

        if (!rows.length) {
          tbody.innerHTML = '<tr><td colspan="6">No hay inspecciones registradas.</td></tr>';
          return;
        }

        tbody.innerHTML = rows.map((r, i) => `
          <tr>
            <td>${i + 1}</td>
            <td>${(r?.cliente?.poliza || '').toString()}</td>
            <td>${(r?.cliente?.nombre || '').toString()}</td>
            <td>${(r?.cliente?.direccion || '').toString()}</td>
            <td>${(r?.tecnico?.nombre || '').toString()}</td>
            <td>${(r?.inspeccion?.fecha || '').toString()}</td>
          </tr>
        `).join('');
      } catch (err) {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="6">Error consultando Firebase.</td></tr>';
      }
    };
  </script>

  <script>
    // ---------- MAPA ----------
    const map = L.map('map').setView([25.6866, -100.3161], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    // ---------- ESTADO ----------
    const vividColors = ['#e6194b','#3cb44b','#ffe119','#4363d8','#f58231','#911eb4','#46f0f0','#f032e6','#bcf60c','#fabebe','#008080','#e6beff','#9a6324','#fffac8','#800000','#aaffc3','#808000','#ffd8b1','#000075','#808080'];
    const streetColors = {};
    let currentData = [], filteredStreet = null, filteredAdicional = null, filteredColonia = '', filteredFecha = '', userMarker = null;
    const AppState = { markersByKey: new Map(), markers: [] };
    window.currentData = currentData;
    let currentSort = { column: null, asc: true };

    // ---------- VISITADOS (localStorage) ----------
    const VISITED_KEY = 'visited_polizas_v1';
    let visitedMap = JSON.parse(localStorage.getItem(VISITED_KEY) || '{}');

    function isVisited(poliza) { return !!visitedMap[poliza]; }
    function setVisited(poliza, value) {
      if (!poliza) return;
      visitedMap[poliza] = value;
      localStorage.setItem(VISITED_KEY, JSON.stringify(visitedMap));
    }

    // ---------- UTIL ----------
    function ensureColor(street) {
      if (!streetColors[street]) {
        streetColors[street] = vividColors[Object.keys(streetColors).length % vividColors.length];
      }
      return streetColors[street];
    }

    function escapeHtml(text) {
      return (text||'').toString().replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','"':'&quot;'}[c]));
    }

    function getRowKey(row, index = 0) {
      const poliza = (row['P√≥liza'] || '').toString().trim();
      const calle = (row['calle'] || '').toString().trim();
      const numero = (row['N√∫mero finca'] || '').toString().trim();
      const colonia = (row['Colonia'] || '').toString().trim();
      const fecha = (row.importadoEn || '').toString().trim();
      return `${poliza}|${calle}|${numero}|${colonia}|${fecha}|${index}`;
    }

    function resetMarkerStore() {
      AppState.markers.forEach(m => {
        if (map.hasLayer(m)) map.removeLayer(m);
      });
      AppState.markersByKey.clear();
      AppState.markers = [];
    }

    function createIcon(number, color) {
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="46" height="62" viewBox="0 0 46 62">
          <path d="M23 62s-18-22-18-34A18 18 0 1 1 41 28c0 12-18 34-18 34z"
            fill="${color}" stroke="#222" stroke-width="2"/>
          <text x="23" y="30" font-family="Arial, Helvetica, sans-serif" font-size="18" font-weight="700" fill="#fff" text-anchor="middle">${number}</text>
        </svg>`;
      return L.icon({
        iconUrl: "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg),
        iconSize: [24, 36],
        iconAnchor: [12, 36],
        popupAnchor: [0, -30]
      });
    }

    // Haversine - distancia en metros
    function distanceMeters(lat1, lng1, lat2, lng2) {
      const R = 6371000; // metros
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function clearHeaderSortMarks() {
      document.querySelectorAll('th').forEach(h => {
        const label = h.getAttribute('data-label');
        if (label) h.textContent = label;
        else h.textContent = h.textContent.replace(/[‚ñ≤‚ñº]/g,'');
      });
    }

    function sortByDistance(userLat, userLng) {
      currentData.forEach(r => {
        const lat = parseFloat(r.lat);
        const lng = parseFloat(r.lng);
        if (isNaN(lat) || isNaN(lng)) { r._distance = Infinity; } else { r._distance = distanceMeters(userLat, userLng, lat, lng); }
      });
      currentData.sort((a, b) => (a._distance || Infinity) - (b._distance || Infinity));
      currentSort.column = null; currentSort.asc = true; clearHeaderSortMarks();
    }

    // ---------- MAPS / WAZE HELPERS ----------
    function getMapsLink(lat, lng) {
      const ua = navigator.userAgent || navigator.vendor || window.opera;
      const isAndroid = /android/i.test(ua);
      const isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
      const isMobile = isAndroid || isIOS;
      if (!isMobile) return `https://www.google.com/maps?q=${lat},${lng}`;
      if (isAndroid) return `google.navigation:q=${lat},${lng}&mode=d`;
      if (isIOS) return `comgooglemaps://?q=${lat},${lng}&directionsmode=driving`;
      return `https://www.google.com/maps?q=${lat},${lng}`;
    }
    function getWazeLink(lat, lng) {
      const ua = navigator.userAgent || navigator.vendor || window.opera;
      const isMobile = /android|iPad|iPhone|iPod/i.test(ua);
      return isMobile ? `waze://?ll=${lat},${lng}&navigate=yes` : `https://www.waze.com/ul?ll=${lat},${lng}&navigate=yes`;
    }

    // ---------- CARGAR DATOS ----------
    function formatImportDate(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    function populateFirebaseFilters(rows) {
      const coloniaSelect = document.getElementById('filterColoniaSelect');
      const fechaSelect = document.getElementById('filterFechaSelect');

      const colonias = Array.from(new Set(rows.map(r => (r['Colonia'] || '').toString().trim()).filter(Boolean))).sort((a, b) => a.localeCompare(b, 'es'));
      const fechas = Array.from(new Set(rows.map(r => formatImportDate(r.importadoEn)).filter(Boolean))).sort((a, b) => b.localeCompare(a));

      coloniaSelect.innerHTML = '<option value="">Colonia: todas</option>' + colonias.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
      fechaSelect.innerHTML = '<option value="">Fecha importaci√≥n: todas</option>' + fechas.map(f => `<option value="${escapeHtml(f)}">${escapeHtml(f)}</option>`).join('');

      coloniaSelect.value = filteredColonia;
      fechaSelect.value = filteredFecha;
    }

    async function waitForFirebaseBridge(timeoutMs = 5000) {
      const start = Date.now();
      while (Date.now() - start < timeoutMs) {
        if (window.firebaseBaseReady && typeof window.fetchBaseRowsFromFirebase === 'function') return true;
        await delay(120);
      }
      return false;
    }

    async function loadData() {
      document.getElementById('dataTableBody').innerHTML = '';
      document.getElementById('legend').innerHTML = '';
      for (const k in streetColors) delete streetColors[k];
      resetMarkerStore();
      currentData = [];

      const mode = document.getElementById('viewModeSelect')?.value || 'latest';
      try {
        const ready = await waitForFirebaseBridge();
        if (!ready) throw new Error('Firebase no listo');

        let rows = await window.fetchBaseRowsFromFirebase(mode);
        if (!rows.length) {
          setImportStatus('No se encontraron registros en las colecciones permitidas de Firebase.');
        }

        const [visitedRemote, recentInspectionMap] = await Promise.all([
          (typeof window.fetchVisitedMapFromFirebase === 'function') ? window.fetchVisitedMapFromFirebase() : Promise.resolve({}),
          (typeof window.fetchRecentInspectionMap === 'function') ? window.fetchRecentInspectionMap() : Promise.resolve({})
        ]);

        visitedMap = { ...visitedMap, ...visitedRemote };
        localStorage.setItem(VISITED_KEY, JSON.stringify(visitedMap));

        rows = rows.map(r => {
          const pol = (r['P√≥liza'] || '').toString().trim();
          const recentDate = recentInspectionMap[pol] || '';
          return {
            ...r,
            _recentInspection: !!recentDate,
            _recentInspectionDate: recentDate
          };
        });

        currentData = rows.filter(r => !isNaN(parseFloat(r.lat)) && !isNaN(parseFloat(r.lng)));
        window.currentData = currentData;
        filteredStreet = null;
        filteredAdicional = null;
        populateFirebaseFilters(rows);
        if (currentSort.column !== null) applySort();
        renderAll();
        showTable();
      } catch (err) {
        console.error(err);
        const code = err?.code || '';
        if (code.includes('permission-denied')) {
          alert('Firebase respondi√≥ "Missing or insufficient permissions". Debes habilitar reglas para BasePolizas/BasePolizasUltimaActualizacion/BasePolizasGlobal.');
        } else {
          alert('Firebase no listo o sin acceso. Verifica conexi√≥n y permisos de colecciones.');
        }
      }
    }

    // ---------- RENDER LISTA / MARCADORES ----------
    function renderAll() {
      const tbody = document.getElementById('dataTableBody');
      tbody.innerHTML = '';

      const list = currentData.filter(r => {
        if (filteredStreet && (r["calle"]||'Sin calle') !== filteredStreet) return false;
        if (filteredAdicional && ( (r["Adicional"]||'').toString() !== filteredAdicional )) return false;
        if (filteredColonia && ((r['Colonia'] || '').toString() !== filteredColonia)) return false;
        if (filteredFecha && formatImportDate(r.importadoEn) !== filteredFecha) return false;
        return true;
      });

      const visibleKeys = new Set();
      list.forEach((row, i) => {
        const lat = parseFloat(row.lat), lng = parseFloat(row.lng);
        if (isNaN(lat) || isNaN(lng)) return;

        const rowKey = row._rowKey || getRowKey(row, i);
        row._rowKey = rowKey;
        visibleKeys.add(rowKey);

        const street = row["calle"] || 'Sin calle';
        const color = ensureColor(street);
        const icon = createIcon(i+1, color);

        let marker = AppState.markersByKey.get(rowKey);
        if (!marker) {
          const popupHtml = `
            <div style="font-family:Arial,Helvetica,sans-serif;line-height:1.25; position: relative; min-width:260px; padding-top:48px; padding-bottom:46px; box-sizing:border-box;">
              <div style="position:absolute; top:6px; left:8px; right:8px; display:flex; gap:6px;">
                <button class="gmaps-btn" style="flex:1; background:#007bff; color:#fff; border:none; border-radius:6px; padding:6px; font-size:12px;">üöó Google</button>
                <button class="waze-btn" style="flex:1; background:#ff6600; color:#fff; border:none; border-radius:6px; padding:6px; font-size:12px;">üß≠ Waze</button>
                <button class="voice-btn" title="Reproducir/Pausar voz" style="flex:1; background:#28a745; color:#fff; border:none; border-radius:6px; padding:6px; font-size:12px;">üîà</button>
              </div>

              <div style="padding:6px 8px;">
                <strong>Colonia:</strong> ${escapeHtml(row["Colonia"]||'')}<br/>
                <strong>P√≥liza:</strong> ${escapeHtml(row["P√≥liza"]||'')}<br/>
                <strong>Direcci√≥n:</strong> ${escapeHtml(row["calle"]||'')} ${escapeHtml(row["N√∫mero finca"]||'')}<br/>
                <strong>Contratante:</strong> ${escapeHtml(row["Nombre Contratante"]||'')}<br/>
                <strong>Inspector:</strong> ${escapeHtml(row["Inspector"]||'')}<br/>
                <strong>Adicional:</strong> ${escapeHtml(row["Adicional"]||'')}<br/>
              ${row._recentInspection ? `<strong style="color:#dc3545;">‚ö†Ô∏è Inspecci√≥n ya realizada (√∫ltimos 3 meses)</strong><br/>` : ''}
              </div>

              <div style="padding:8px; margin-bottom:8px;">
                <label style="display:inline-flex; align-items:center; gap:8px; font-size:13px;">
                  <input type="checkbox" class="popup-visited-checkbox"> <span>Visitado</span>
                </label>
              </div>

              <button class="acta-btn" style="position:absolute; bottom:6px; left:6px; padding:6px 8px; font-size:12px; background:#0d6efd; color:#fff; border:none; border-radius:6px; cursor:pointer;">Inspeccion</button>
              <button class="popup-next-btn" style="position:absolute; bottom:6px; right:6px; padding:6px 8px; font-size:12px; background:#28a745; color:#fff; border:none; border-radius:6px; cursor:pointer;">Next</button>
            </div>`;

          marker = L.marker([lat, lng], { icon }).bindPopup(popupHtml);
          marker._rowData = row;
          marker._poliza = (row["P√≥liza"]||'').toString();
          marker._rowKey = rowKey;
          AppState.markersByKey.set(rowKey, marker);
          AppState.markers.push(marker);
        } else {
          marker._rowData = row;
          marker._poliza = (row["P√≥liza"]||'').toString();
          marker.setIcon(icon);
          marker.setLatLng([lat, lng]);
        }

        if (!map.hasLayer(marker)) marker.addTo(map);
        marker.setOpacity(isVisited(marker._poliza) ? 0.4 : 1);

        const distanciaText = (row._distance && isFinite(row._distance))
          ? (row._distance >= 1000 ? ((row._distance/1000).toFixed(2) + ' km') : Math.round(row._distance) + ' m')
          : '';

        const polizaVal = (row["P√≥liza"]||'').toString();
        const visited = isVisited(polizaVal);
        const tr = document.createElement('tr');
        tr.style.background = color + '22';
        if (visited) tr.style.opacity = '0.45';

        tr.innerHTML = `
          <td style="width:34px; text-align:center;">
            <input type="checkbox" class="list-visited-checkbox" ${visited ? 'checked' : ''} aria-label="Visitado">
          </td>
          <td>${escapeHtml(polizaVal)}</td>
          <td>${escapeHtml(row["Nombre Contratante"]||'')}</td>
          <td>
            ${escapeHtml((row["calle"]||'') + ' ' + (row["N√∫mero finca"]||''))}
            ${distanciaText ? `<small class="distance">${escapeHtml(distanciaText)}</small>` : ''}
          </td>
          <td>${escapeHtml(row["Adicional"]||'')}</td>`;

        const checkbox = tr.querySelector('input.list-visited-checkbox');
        checkbox.addEventListener('click', (e) => {
          e.stopPropagation();
          const checked = checkbox.checked;
          setVisited(polizaVal, checked);
          if (typeof window.syncVisitedStatusToFirebase === 'function') window.syncVisitedStatusToFirebase(polizaVal, checked);
          tr.style.opacity = checked ? '0.45' : '1';
          if (marker && marker.setOpacity) marker.setOpacity(checked ? 0.4 : 1);

          AppState.markers.forEach(mk => {
            if (mk._poliza === polizaVal && mk.getPopup && mk.getPopup().isOpen && mk.getPopup().isOpen()) {
              const popupEl = mk.getPopup().getElement();
              if (popupEl) {
                const popupCb = popupEl.querySelector('.popup-visited-checkbox');
                if (popupCb) popupCb.checked = checked;
              }
            }
          });
        });

        tr.addEventListener('click', () => {
          marker.openPopup();
          map.setView([lat, lng], 17);
          hideTable();
        });

        tbody.appendChild(tr);
      });

      AppState.markers.forEach(marker => {
        if (!visibleKeys.has(marker._rowKey) && map.hasLayer(marker)) map.removeLayer(marker);
      });
    }

    // Filtrado por calle (modal)
    function toggleFilter(street, itemElement) {
      const items = document.querySelectorAll('.legend-item');
      if (filteredStreet === street) {
        filteredStreet = null;
        items.forEach(it => it.classList.remove('active'));
      } else {
        filteredStreet = street;
        items.forEach(it => it.classList.toggle('active', it === itemElement));
      }
      renderAll();
    }

    // Ordenamientos de columnas
    function applySort() {
      const col = currentSort.column;
      const asc = currentSort.asc;
      if (col === 0) {
        currentData.sort((a,b) => {
          const va = isVisited((a['P√≥liza']||'').toString()) ? 1 : 0;
          const vb = isVisited((b['P√≥liza']||'').toString()) ? 1 : 0;
          return asc ? (va - vb) : (vb - va);
        });
      } else if (col === 1) {
        currentData.sort((a,b) => {
          const na = parseFloat((a['P√≥liza']||'').toString().replace(/[^\d.-]/g,'')) || 0;
          const nb = parseFloat((b['P√≥liza']||'').toString().replace(/[^\d.-]/g,'')) || 0;
          return asc ? na - nb : nb - na;
        });
      } else if (col === 2) {
        currentData.sort((a,b) => {
          const sa = (a['Nombre Contratante']||'').toLowerCase();
          const sb = (b['Nombre Contratante']||'').toLowerCase();
          return asc ? sa.localeCompare(sb,'es') : sb.localeCompare(sa,'es');
        });
      } else if (col === 3) {
        currentData.sort((a,b) => {
          const ca = (a['calle']||'').toLowerCase();
          const cb = (b['calle']||'').toLowerCase();
          if (ca !== cb) return asc ? ca.localeCompare(cb,'es') : cb.localeCompare(ca,'es');
          const na = parseInt(a['N√∫mero finca']||'') || 0;
          const nb = parseInt(b['N√∫mero finca']||'') || 0;
          return asc ? na - nb : nb - na;
        });
      } else if (col === 4) {
        currentData.sort((a,b) => {
          const aa = (a['Adicional']||'').toString().toLowerCase();
          const bb = (b['Adicional']||'').toString().toLowerCase();
          return asc ? aa.localeCompare(bb,'es') : bb.localeCompare(aa,'es');
        });
      }
      clearHeaderSortMarks();
    }

    // Headers click: ordenar por columna
    document.querySelectorAll('th').forEach((th, idx) => {
      th.addEventListener('click', () => {
        currentSort.asc = (currentSort.column === idx) ? !currentSort.asc : true;
        currentSort.column = idx;
        applySort();
        document.querySelectorAll('th').forEach(h => {
          h.textContent = h.getAttribute('data-label') || h.textContent.replace(/[‚ñ≤‚ñº]/g,'');
        });
        th.textContent = (th.getAttribute('data-label') || th.textContent.replace(/[‚ñ≤‚ñº]/g,'')) + (currentSort.asc ? ' ‚ñ≤' : ' ‚ñº');
        renderAll();
      });
    });

    // ---------- BOTONES PRINCIPALES ----------
    document.getElementById('locateBtn').onclick = () => {
      if (!navigator.geolocation) { alert('Geolocalizaci√≥n no soportada'); return; }
      navigator.geolocation.getCurrentPosition(pos => {
        let originLat = pos.coords.latitude;
        let originLng = pos.coords.longitude;
        if (userMarker) { map.removeLayer(userMarker); userMarker = null; }
        userMarker = L.marker([originLat, originLng]).addTo(map).bindPopup('üìç Inicio de ruta').openPopup();
        map.setView([originLat, originLng], 16);

        const MAX_ROUTE_RECORDS = 500;
        if (currentData.length > MAX_ROUTE_RECORDS) {
          alert(`La base tiene ${currentData.length} registros. El modo ruta est√° limitado a ${MAX_ROUTE_RECORDS} para mantener rendimiento.`);
          return;
        }

        let pendientes = currentData.slice();
        let rutaOrdenada = [];

        while (pendientes.length > 0) {
          pendientes.forEach(r => {
            const lat = parseFloat(r.lat);
            const lng = parseFloat(r.lng);
            r._distance = (isNaN(lat) || isNaN(lng)) ? Infinity : distanceMeters(originLat, originLng, lat, lng);
          });

          pendientes.sort((a, b) => (a._distance || Infinity) - (b._distance || Infinity));
          const referencia = pendientes[0];
          const calleRef = (referencia.calle || '').toLowerCase().trim();

          const mismaCalle = pendientes.filter(r =>
            (r.calle || '').toLowerCase().trim() === calleRef &&
            (r._distance || Infinity) <= 100
          );

          let siguiente;
          if (mismaCalle.length > 0) {
            mismaCalle.sort((a, b) => a._distance - b._distance);
            siguiente = mismaCalle[0];
          } else {
            siguiente = referencia;
          }

          rutaOrdenada.push(siguiente);
          originLat = parseFloat(siguiente.lat);
          originLng = parseFloat(siguiente.lng);
          pendientes = pendientes.filter(r => r !== siguiente);
        }

        currentData = rutaOrdenada;
        window.currentData = currentData;
        renderAll();
        showTable();
      }, () => alert('No se pudo obtener ubicaci√≥n'), { enableHighAccuracy: true, timeout: 10000 });
    };

    document.getElementById('refreshBtn').addEventListener('click', loadData);

    const listPanel = document.getElementById('listPanel');
    const actionMenu = document.getElementById('actionMenu');
    const actionMenuBtn = document.getElementById('actionMenuBtn');

    actionMenuBtn.addEventListener('click', () => {
      actionMenu.classList.toggle('active');
      actionMenu.setAttribute('aria-hidden', actionMenu.classList.contains('active') ? 'false' : 'true');
    });

    document.getElementById('toggleBtn').addEventListener('click', () => listPanel.classList.toggle('active'));
    document.getElementById('hideBtn').addEventListener('click', hideTable);

    const importModal = document.getElementById('importModal');
    const importExcelTbody = document.getElementById('importExcelTbody');
    const importStatus = document.getElementById('importStatus');
    const importProgressBar = document.getElementById('importProgressBar');
    const importProgressText = document.getElementById('importProgressText');
    const processImportBtn = document.getElementById('processImportBtn');
    const importColumns = ['P√≥liza', 'calle', 'N√∫mero finca', 'Colonia', 'Municipio', 'Nombre Contratante', 'Empresa', 'Inspector', 'Adicional'];

    function setImportStatus(text) {
      importStatus.textContent = text;
    }

    function setImportProgress(done, total) {
      const pct = total > 0 ? Math.round((done / total) * 100) : 0;
      importProgressBar.style.width = `${pct}%`;
      importProgressText.textContent = `${pct}%`;
    }

    function createImportRow(cells = []) {
      const tr = document.createElement('tr');
      importColumns.forEach((_, idx) => {
        const td = document.createElement('td');
        td.contentEditable = 'true';
        td.textContent = cells[idx] || '';
        tr.appendChild(td);
      });
      importExcelTbody.appendChild(tr);
      return tr;
    }

    function ensureImportRows(min = 12) {
      while (importExcelTbody.children.length < min) createImportRow();
    }

    function clearImportTable() {
      importExcelTbody.innerHTML = '';
      ensureImportRows();
      setImportStatus('Tabla limpia. Lista para pegar datos.');
      setImportProgress(0, 1);
    }

    function openImportModal() {
      importModal.style.display = 'block';
      importModal.setAttribute('aria-hidden', 'false');
      const geocoderInput = document.getElementById('appsScriptGeocoderUrl');
      const saved = localStorage.getItem(GEO_LOCAL_STORAGE_KEY) || '';
      if (geocoderInput && saved && !geocoderInput.value) geocoderInput.value = saved;
      if (!importExcelTbody.children.length) ensureImportRows();
    }

    function closeImportModal() {
      importModal.style.display = 'none';
      importModal.setAttribute('aria-hidden', 'true');
    }

    const RATE_DELAY_MS = 300;
    const GEOCODE_RETRIES = 3;
    const GEO_LOCAL_STORAGE_KEY = 'apps_script_geocoder_url_v1';

    function buildAddress(row) {
      const calle = (row['calle'] || '').toString().trim();
      const num = (row['N√∫mero finca'] || '').toString().trim();
      const colonia = (row['Colonia'] || '').toString().trim();
      const municipio = (row['Municipio'] || '').toString().trim();
      const parts = [];
      if (calle) parts.push(calle + (num ? ` ${num}` : ''));
      if (colonia) parts.push(colonia);
      if (municipio) parts.push(municipio);
      parts.push('Nuevo Le√≥n, M√©xico');
      return parts.join(', ');
    }

    function getAppsScriptGeocoderUrl() {
      const input = document.getElementById('appsScriptGeocoderUrl');
      const value = (input?.value || '').trim();
      return value;
    }

    async function geocodeByAppScript(address) {
      const baseUrl = getAppsScriptGeocoderUrl();
      if (!baseUrl) return null;
      const url = `${baseUrl}${baseUrl.includes('?') ? '&' : '?'}address=${encodeURIComponent(address)}`;
      const response = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!response.ok) return null;
      const data = await response.json();
      const lat = data?.lat ?? data?.location?.lat ?? data?.result?.lat;
      const lng = data?.lng ?? data?.lon ?? data?.location?.lng ?? data?.result?.lng;
      if (lat === undefined || lng === undefined) return null;
      return { lat: String(lat), lng: String(lng), provider: 'apps-script' };
    }

    async function geocodeByNominatim(address) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&addressdetails=1&countrycodes=mx&q=${encodeURIComponent(address)}`;
      const response = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!response.ok) return null;
      const list = await response.json();
      if (!Array.isArray(list) || !list.length) return null;
      return { lat: String(list[0].lat || ''), lng: String(list[0].lon || ''), provider: 'nominatim' };
    }

    async function geocodeAddress(row) {
      const address = buildAddress(row);
      if (!address) return { lat: '', lng: '', provider: 'none' };

      for (let i = 0; i < GEOCODE_RETRIES; i++) {
        try {
          const appScript = await geocodeByAppScript(address);
          if (appScript?.lat && appScript?.lng) return appScript;
        } catch (_) {}

        try {
          const nominatim = await geocodeByNominatim(address);
          if (nominatim?.lat && nominatim?.lng) return nominatim;
        } catch (_) {}

        await delay(RATE_DELAY_MS);
      }

      return { lat: '', lng: '', provider: 'none' };
    }

    async function processPastedImport() {
      const rows = Array.from(importExcelTbody.querySelectorAll('tr'));
      const parsed = rows.map(tr => {
        const cells = Array.from(tr.querySelectorAll('td')).map(td => (td.textContent || '').trim());
        const obj = {};
        importColumns.forEach((name, i) => { obj[name] = cells[i] || ''; });
        return obj;
      }).filter(r => importColumns.some(c => r[c]));

      if (!parsed.length) {
        alert('No hay datos para procesar.');
        return;
      }

      const geocoderInput = document.getElementById('appsScriptGeocoderUrl');
      if (geocoderInput) localStorage.setItem(GEO_LOCAL_STORAGE_KEY, geocoderInput.value.trim());

      processImportBtn.disabled = true;
      processImportBtn.style.opacity = '0.7';
      try {
        setImportProgress(0, parsed.length);
        setImportStatus(`Procesando ${parsed.length} filas...`);
        const geocoded = [];
        let found = 0;
        for (let i = 0; i < parsed.length; i++) {
          const row = parsed[i];
          setImportStatus(`Geocodificando ${i + 1}/${parsed.length}...`);
          const geo = await geocodeAddress(row);
          if (geo.lat && geo.lng) found++;
          geocoded.push({ ...row, lat: geo.lat, lng: geo.lng, geoProvider: geo.provider || 'none' });
          setImportProgress(i + 1, parsed.length);
          await delay(250);
        }

        window.pendingImportData = geocoded;
        currentData = geocoded.filter(r => !isNaN(parseFloat(r.lat)) && !isNaN(parseFloat(r.lng)));
        window.currentData = currentData;
        filteredStreet = null;
        filteredAdicional = null;
        if (currentSort.column !== null) applySort();
        renderAll();
        showTable();

        const byProvider = geocoded.reduce((acc, r) => {
          const key = r.geoProvider || 'none';
          acc[key] = (acc[key] || 0) + 1;
          return acc;
        }, {});
        const withoutCoords = parsed.length - found;
        setImportStatus(`Geocoding completado. Coordenadas: ${found}/${parsed.length}. Sin coordenadas: ${withoutCoords}. Proveedor: ${JSON.stringify(byProvider)}. Guardando en Firebase...`);

        if (typeof window.importDatabaseToFirebase === 'function') {
          await window.importDatabaseToFirebase();
        } else {
          alert('Firebase a√∫n no est√° listo.');
        }

        setImportStatus(`Proceso finalizado. Coordenadas encontradas: ${found}/${parsed.length}. Sin coordenadas: ${parsed.length - found}.`);
        document.getElementById('viewModeSelect').value = 'latest';
        await loadData();
      } finally {
        processImportBtn.disabled = false;
        processImportBtn.style.opacity = '1';
      }
    }

    importExcelTbody.addEventListener('paste', (event) => {
      const text = event.clipboardData?.getData('text/plain') || '';
      if (!text) return;
      event.preventDefault();

      const rowChunks = text.split(/\r?\n/).map(r => r.trim()).filter(Boolean);
      const matrix = rowChunks.map(r => r.split('\t'));
      if (!matrix.length) return;

      const activeCell = document.activeElement;
      let startRow = 0;
      let startCol = 0;

      if (activeCell && activeCell.tagName === 'TD' && activeCell.parentElement?.parentElement === importExcelTbody) {
        const tr = activeCell.parentElement;
        startRow = Array.from(importExcelTbody.children).indexOf(tr);
        startCol = Array.from(tr.children).indexOf(activeCell);
      }

      while (importExcelTbody.children.length < startRow + matrix.length) createImportRow();

      matrix.forEach((cells, rIdx) => {
        const tr = importExcelTbody.children[startRow + rIdx];
        cells.forEach((value, cIdx) => {
          const col = startCol + cIdx;
          if (col >= importColumns.length) return;
          const td = tr.children[col];
          if (td) td.textContent = value.trim();
        });
      });

      setImportStatus(`Pegado completado: ${matrix.length} fila(s).`);
    });

    document.getElementById('importFirebaseBtn').addEventListener('click', openImportModal);
    document.getElementById('closeImportModalBtn').addEventListener('click', closeImportModal);
    document.getElementById('addImportRowBtn').addEventListener('click', () => createImportRow());
    document.getElementById('clearImportTableBtn').addEventListener('click', clearImportTable);
    document.getElementById('processImportBtn').addEventListener('click', processPastedImport);
    importModal.addEventListener('click', (e) => {
      if (e.target === importModal) closeImportModal();
    });

    document.getElementById('reloadFirebaseBtn').addEventListener('click', () => loadData());
    document.getElementById('viewModeSelect').addEventListener('change', () => {
      filteredColonia = '';
      filteredFecha = '';
      loadData();
    });
    document.getElementById('filterColoniaSelect').addEventListener('change', (e) => {
      filteredColonia = e.target.value || '';
      renderAll();
    });
    document.getElementById('filterFechaSelect').addEventListener('change', (e) => {
      filteredFecha = e.target.value || '';
      renderAll();
    });

    const inspectionsModal = document.getElementById('inspectionsModal');
    function openInspectionsModal() {
      inspectionsModal.style.display = 'block';
      inspectionsModal.setAttribute('aria-hidden', 'false');
    }
    function closeInspectionsModal() {
      inspectionsModal.style.display = 'none';
      inspectionsModal.setAttribute('aria-hidden', 'true');
    }

    document.getElementById('viewInspectionsBtn').addEventListener('click', async () => {
      openInspectionsModal();
      if (typeof window.loadInspectionsFromFirebase === 'function') await window.loadInspectionsFromFirebase();
    });

    document.getElementById('closeInspectionsModalBtn').addEventListener('click', closeInspectionsModal);
    inspectionsModal.addEventListener('click', (e) => {
      if (e.target === inspectionsModal) closeInspectionsModal();
    });

    // ---------- VOZ ----------
    let voiceCanceled = false;
    function stopSpeech() { voiceCanceled = true; try { window.speechSynthesis.cancel(); } catch (e) { } }
    function restoreAllVoiceButtons() {
      const btns = document.querySelectorAll('.voice-btn');
      btns.forEach(b => { b.textContent = 'üîà'; b.style.background = '#28a745'; });
    }
    function delay(ms) { return new Promise(res => setTimeout(res, ms)); }

    async function speakPolizaAndNombre(polizaRaw, nombreRaw, btn) {
      if (!('speechSynthesis' in window)) { alert('Tu navegador no soporta s√≠ntesis de voz.'); return; }
      if (speechSynthesis.speaking) { stopSpeech(); restoreAllVoiceButtons(); return; }
      voiceCanceled = false;
      if (btn) { btn.textContent = 'üîä'; btn.style.background = '#dc3545'; }
      const pol = (polizaRaw || '').toString().trim();

      if (pol.length > 0) {
        for (const ch of pol) {
          if (voiceCanceled) break;
          const u = new SpeechSynthesisUtterance(ch);
          u.lang = 'es-MX';
          u.rate = /^\d$/.test(ch) ? 1.00 : 0.9;
          const p = new Promise(res => { u.onend = res; u.onerror = res; });
          speechSynthesis.speak(u);
          await p;
          await delay(500);
        }
      }

      if (voiceCanceled) { stopSpeech(); restoreAllVoiceButtons(); return; }
      await delay(500);

      if (nombreRaw && nombreRaw.toString().trim().length > 0) {
        const palabras = nombreRaw.toString().trim().split(/\s+/).filter(Boolean);
        for (const w of palabras) {
          if (voiceCanceled) break;
          const u = new SpeechSynthesisUtterance(w);
          u.lang = 'es-MX';
          u.rate = 1.0;
          const p = new Promise(res => { u.onend = res; u.onerror = res; });
          speechSynthesis.speak(u);
          await p;
          if (voiceCanceled) break;
          await delay(w.length * 250);
        }
      }

      stopSpeech();
      restoreAllVoiceButtons();
    }

    // Modo narrador autom√°tico
    let autoModeActive = false;
    async function narrarAutomaticamente() {
      if (!('speechSynthesis' in window)) { alert('Tu navegador no soporta s√≠ntesis de voz.'); return; }
      if (autoModeActive) { autoModeActive = false; if (speechSynthesis.speaking) speechSynthesis.cancel(); document.getElementById('autoNarrarBtn').textContent = '‚ñ∂Ô∏è'; return; }
      autoModeActive = true;
      document.getElementById('autoNarrarBtn').textContent = '‚èπ';

      const visibles = AppState.markers.filter(m => map.hasLayer(m));
      for (let i = 0; i < visibles.length && autoModeActive; i++) {
        const marker = visibles[i];
        let row = marker._rowData;
        if (!row) {
          const lat = marker.getLatLng().lat;
          const lng = marker.getLatLng().lng;
          row = currentData.find(r => Math.abs(parseFloat(r.lat) - lat) < 1e-5 && Math.abs(parseFloat(r.lng) - lng) < 1e-5);
        }
        if (!row) continue;
        map.setView(marker.getLatLng(), 17);
        marker.openPopup();
        await speakPolizaAndNombre(row['P√≥liza']||'', row['Nombre Contratante']||'', null);
        await delay(2000);
      }
      autoModeActive = false;
      document.getElementById('autoNarrarBtn').textContent = '‚ñ∂Ô∏è';
    }
    document.getElementById('autoNarrarBtn').addEventListener('click', narrarAutomaticamente);

    // ---------- popupopen: enganchar botones y checkbox (no marcar autom√°ticamente) ----------
    map.on('popupopen', e => {
      const popupEl = e.popup.getElement();
      const marker = e.popup._source;
      const markerLat = marker.getLatLng().lat;
      const markerLng = marker.getLatLng().lng;
      const poliza = marker._poliza;

      // Google Maps button
      const gmapsBtn = popupEl.querySelector('.gmaps-btn');
      if (gmapsBtn) {
        gmapsBtn.onclick = (ev) => {
          ev.preventDefault();
          const link = getMapsLink(markerLat, markerLng);
          window.location.href = link;
        };
      }

      // Waze button
      const wazeBtn = popupEl.querySelector('.waze-btn');
      if (wazeBtn) {
        wazeBtn.onclick = (ev) => {
          ev.preventDefault();
          const link = getWazeLink(markerLat, markerLng);
          window.location.href = link;
        };
      }

      // Acta button
      const actaBtn = popupEl.querySelector('.acta-btn');
      if (actaBtn) {
        const row = marker._rowData || {};
        if (row._recentInspection) {
          actaBtn.disabled = true;
          actaBtn.textContent = 'Inspecci√≥n reciente';
          actaBtn.style.background = '#6c757d';
          actaBtn.style.cursor = 'not-allowed';
          actaBtn.title = 'Esta p√≥liza ya tiene inspecci√≥n registrada en los √∫ltimos 3 meses';
          actaBtn.onclick = (ev) => {
            ev.preventDefault();
            ev.stopPropagation();
            alert('Esta p√≥liza ya tiene inspecci√≥n registrada en los √∫ltimos 3 meses.');
          };
        } else {
          actaBtn.disabled = false;
          actaBtn.textContent = 'Inspeccion';
          actaBtn.style.background = '#0d6efd';
          actaBtn.style.cursor = 'pointer';
          actaBtn.title = '';

          actaBtn.onclick = (ev) => {
            ev.preventDefault();
            ev.stopPropagation();

            const rowData = marker._rowData;
            if (!rowData) {
              alert('No se encontraron datos de la p√≥liza');
              return;
            }

            const url = new URL('https://aldairsierra-pruebas.github.io/APKWEBVIEWHTML/acta-inspeccion.html');
            url.searchParams.set('poliza', rowData['P√≥liza'] || '');
            url.searchParams.set('nombre', rowData['Nombre Contratante'] || '');
            url.searchParams.set('direccion', `${rowData['calle'] || ''} ${rowData['N√∫mero finca'] || ''}`);
            url.searchParams.set('lat', rowData.lat || '');
            url.searchParams.set('lng', rowData.lng || '');

            window.open(url.toString(), '_blank');
          };
        }
      }

      // Next button (NO marca autom√°ticamente)
      const nextBtn = popupEl.querySelector('.popup-next-btn');
      if (nextBtn) {
        nextBtn.onclick = (ev) => {
          ev.preventDefault();
          const visibles = AppState.markers.filter(m => map.hasLayer(m));
          if (visibles.length === 0) return;
          let idx = visibles.findIndex(m => m === marker);
          if (idx < 0) return;
          const nextMarker = visibles[(idx + 1) % visibles.length];
          map.setView(nextMarker.getLatLng(), 17);
          nextMarker.openPopup();
        };
      }

      // Voice button (reusa l√≥gica)
      const voiceBtn = popupEl.querySelector('.voice-btn');
      if (voiceBtn) {
        voiceBtn.onclick = null;
        let markerData = marker && marker._rowData;
        if (!markerData) {
          markerData = currentData.find(r =>
            Math.abs(parseFloat(r.lat) - markerLat) < 1e-5 &&
            Math.abs(parseFloat(r.lng) - markerLng) < 1e-5
          );
        }
        if (markerData) {
          voiceBtn.onclick = (ev) => {
            ev.preventDefault();
            if (speechSynthesis.speaking) { stopSpeech(); restoreAllVoiceButtons(); return; }
            speakPolizaAndNombre(markerData['P√≥liza']||'', markerData['Nombre Contratante']||'', voiceBtn);
          };
        }
      }

      // Popup checkbox: sincronizar con lista y marcador
      const popupCb = popupEl.querySelector('.popup-visited-checkbox');
      if (popupCb) {
        // set initial state from storage
        popupCb.checked = isVisited(poliza);

        // remove previous handler if any
        popupCb._handler && popupCb.removeEventListener('change', popupCb._handler);

        popupCb._handler = (ev) => {
          const checked = popupCb.checked;
          setVisited(poliza, checked);
          if (typeof window.syncVisitedStatusToFirebase === 'function') window.syncVisitedStatusToFirebase(poliza, checked);

          // update marker appearance
          if (marker && marker.setOpacity) marker.setOpacity(checked ? 0.4 : 1);

          // update row checkbox in list (if exists)
          const rows = document.querySelectorAll('#dataTableBody tr');
          for (const r of rows) {
            const cellPol = r.children[1] && r.children[1].textContent && r.children[1].textContent.trim();
            if (cellPol === poliza) {
              const listCb = r.querySelector('input.list-visited-checkbox');
              if (listCb) listCb.checked = checked;
              r.style.opacity = checked ? '0.45' : '1';
              break;
            }
          }
        };

        popupCb.addEventListener('change', popupCb._handler);
      }
    });

    map.on('popupclose', () => {
      stopSpeech();
      restoreAllVoiceButtons();
    });

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        stopSpeech();
        restoreAllVoiceButtons();
      }
    });

    // ---------- PANEL SHOW/HIDE y GESTOS ----------
    function showTable() { listPanel.classList.add('active'); listPanel.setAttribute('aria-hidden','false'); }
    function hideTable() { listPanel.classList.remove('active'); listPanel.setAttribute('aria-hidden','true'); }

    // swipe down to hide
    let startY = 0;
    listPanel.addEventListener('touchstart', e => { startY = e.touches[0].clientY; }, { passive:true });
    listPanel.addEventListener('touchend', e => { const endY = e.changedTouches[0].clientY; if (endY - startY > 80) hideTable(); }, { passive:true });

    // handle tap toggles
    const handle = document.getElementById('panelHandle');
    handle.addEventListener('click', () => {
      if (listPanel.classList.contains('active')) hideTable(); else showTable();
    });

    // ---------- MODAL CALLES ----------
    function openStreetModal() { renderStreetModal(); const m = document.getElementById('streetModal'); m.style.display = 'block'; m.setAttribute('aria-hidden','false'); }
    function closeStreetModal() { const m = document.getElementById('streetModal'); m.style.display = 'none'; m.setAttribute('aria-hidden','true'); }

    function renderStreetModal() {
      const ul = document.getElementById('streetList');
      ul.innerHTML = '';
      const streets = Array.from(new Set(currentData.map(r => (r["calle"]||'Sin calle')))).sort((a,b) => a.localeCompare(b,'es'));
      const liAll = document.createElement('li');
      liAll.textContent = 'Todas'; liAll.style.fontWeight = '700';
      liAll.onclick = () => { filteredStreet = null; renderAll(); closeStreetModal(); };
      ul.appendChild(liAll);
      streets.forEach(calle => {
        const li = document.createElement('li');
        li.textContent = calle;
        li.onclick = () => { filteredStreet = calle; renderAll(); closeStreetModal(); };
        ul.appendChild(li);
      });
    }

    document.getElementById('streetModal').onclick = e => { if (e.target.id === 'streetModal') closeStreetModal(); };
    document.getElementById('filterBtn').addEventListener('click', openStreetModal);

    // ---------- MODAL ADICIONAL ----------
    function openAdicionalModal() { renderAdicionalModal(); const m = document.getElementById('adicionalModal'); m.style.display = 'block'; m.setAttribute('aria-hidden','false'); }
    function closeAdicionalModal() { const m = document.getElementById('adicionalModal'); m.style.display = 'none'; m.setAttribute('aria-hidden','true'); }

    function renderAdicionalModal() {
      const ul = document.getElementById('adicionalList');
      ul.innerHTML = '';
      const adicionales = Array.from(new Set(currentData.map(r => (r["Adicional"]||'').toString()))).sort((a,b) => a.localeCompare(b,'es'));
      const liAll = document.createElement('li'); liAll.textContent = 'Todos'; liAll.style.fontWeight = '700';
      liAll.onclick = () => { filteredAdicional = null; renderAll(); closeAdicionalModal(); };
      ul.appendChild(liAll);
      adicionales.forEach(val => {
        const display = val || '(vac√≠o)';
        const li = document.createElement('li');
        li.textContent = display;
        li.onclick = () => { filteredAdicional = val; renderAll(); closeAdicionalModal(); };
        ul.appendChild(li);
      });
    }

    document.getElementById('adicionalModal').onclick = e => { if (e.target.id === 'adicionalModal') closeAdicionalModal(); };
    document.getElementById('filterAdicionalBtn').addEventListener('click', openAdicionalModal);

    // ---------- INICIO ----------
    loadData();
  </script>
</body>
</html>
