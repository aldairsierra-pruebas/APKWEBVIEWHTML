<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visitas Naturgy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script>
    function compareVersions(v1, v2) {
      const a = v1.split('.').map(Number), b = v2.split('.').map(Number);
      for (let i = 0; i < Math.max(a.length, b.length); i++) {
        const diff = (a[i] || 0) - (b[i] || 0);
        if (diff) return diff > 0 ? 1 : -1;
      }
      return 0;
    }
    const currentVersion = "2.0.0";
    function checkUpdate() {
      fetch("https://aldairsierra-pruebas.github.io/APKWEBVIEWHTML/update.json?nocache=" + Date.now())
        .then(r => { if (!r.ok) throw new Error(); return r.json(); })
        .then(data => {
          if (!data || !data.version) return;
          if (compareVersions(data.version, currentVersion) > 0) {
            const overlay = document.createElement('div');
            overlay.id = 'update-overlay';
            overlay.style.cssText = `
              position: fixed; top:0; left:0; width:100%; height:100%;
              background: rgba(0,0,0,0.8); color:#fff; display:flex;
              align-items:center; justify-content:center; flex-direction:column;
              text-align:center; padding:20px; z-index:99999; font-family: Arial;
            `;
            overlay.innerHTML = `
              <h2 style="margin-bottom:12px;">${data.message || 'Actualizaci√≥n disponible'}</h2>
              <p style="margin-bottom:18px;">Versi√≥n actual: ${currentVersion} ‚Äî Nueva: ${data.version}</p>
              <a href="${data.url}" style="background:#28a745;color:#fff;padding:10px 18px;border-radius:8px;text-decoration:none;font-weight:700;">
                Descargar actualizaci√≥n
              </a>
            `;
            document.body.appendChild(overlay);
          }
        })
        .catch(()=> console.warn('No se pudo verificar la versi√≥n'));
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', checkUpdate); else checkUpdate();
  </script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>

  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #map { height: 100vh; transition: height 0.3s ease; }

    #listPanel { position: fixed; inset: 0; background: #fff; z-index: 900; transform: translateY(100%); transition: transform 0.3s ease; display: flex; flex-direction: column; box-shadow: 0 -6px 20px rgba(0,0,0,0.12); }
    #listPanel.active { transform: translateY(0); }

    #panelHandle { height: 26px; background: #f1f1f1; display: flex; justify-content: center; align-items: center; border-bottom: 1px solid #e6e6e6; }
    #panelHandle div { width: 42px; height: 5px; background: #999; border-radius: 3px; }

    #controls { display:flex; gap:8px; align-items:center; padding: 8px; border-bottom: 1px solid #eee; flex-wrap:wrap; }
    #controls button { padding:6px 10px; border-radius:6px; border:1px solid #ddd; background:#fff; cursor:pointer; }

    #legend { padding: 6px; font-size:13px; background:#fff; display:flex; flex-wrap:wrap; gap:6px; }
    .legend-item { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; background:#f7f7f7; border:1px solid #ddd; border-radius:6px; cursor:pointer; }
    .legend-item.active { outline:2px solid #007bff; }

    #tableWrapper { flex: 1; overflow-y: auto; }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th, td { padding:8px; border-bottom:1px solid #eee; text-align:left; vertical-align:top; }
    th { background:#fafafa; position: sticky; top: 0; z-index: 10; }
    tr:hover { background:#f7fbff; cursor:pointer; }

    .voice-btn { display:inline-flex; align-items:center; justify-content:center; border:none; cursor:pointer; border-radius:8px; padding:6px 10px; font-size:18px; color:#fff; }
    small.distance { display:block; margin-top:6px; color:#333; opacity:0.85; font-size:12px; }

    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: 2000; }
    .modal-backdrop .modal { background: #fff; margin: 10% auto; width: 92%; max-height: 70%; overflow-y: auto; border-radius: 10px; padding: 12px; }
    .modal-backdrop ul { list-style: none; padding: 0; margin: 0; }
    .modal-backdrop li { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }

    #locateBtn,#refreshBtn,#toggleBtn,#autoNarrarBtn { position: static; right: auto; z-index: auto; }
  </style>
</head>
<body>

<div id="map"></div>

<div style="position:absolute; top:10px; right:10px; display:flex; flex-direction:column; gap:8px; z-index:9999;">
  <button id="locateBtn" style="background:#0d6efd;color:white;border:none;border-radius:50%;width:40px;height:40px;font-size:18px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.3);">üìç</button>
  <button id="refreshBtn" style="background:#6c757d;color:white;border:none;border-radius:50%;width:40px;height:40px;font-size:18px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.3);">üîÑ</button>
  <button id="toggleBtn" style="background:#343a40;color:white;border:none;border-radius:50%;width:40px;height:40px;font-size:18px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.3);">üìã</button>
  <button id="autoNarrarBtn" style="background:#198754;color:white;border:none;border-radius:50%;width:40px;height:40px;font-size:18px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.3);">‚ñ∂Ô∏è</button>
</div>

<div id="listPanel" aria-hidden="true">
  <div id="panelHandle"><div></div></div>
  <div id="controls">
    <button id="filterBtn">üìç Filtrar calle</button>
    <button id="filterAdicionalBtn">üîé Filtrar adicional</button>
    <button id="hideBtn">‚¨áÔ∏è Ocultar</button>
    <div id="legend" style="flex:1;"></div>
  </div>
  <div id="tableWrapper">
    <table>
      <thead>
        <tr>
          <th data-label="‚úî">‚úî</th>
          <th data-label="P√≥liza">P√≥liza</th>
          <th data-label="Nombre">Nombre</th>
          <th data-label="Direcci√≥n">Direcci√≥n</th>
          <th data-label="Adicional">Adicional</th>
        </tr>
      </thead>
      <tbody id="dataTableBody"></tbody>
    </table>
  </div>
</div>

<div id="streetModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal">
    <h3 style="margin-top:0">Selecciona calle</h3>
    <ul id="streetList"></ul>
  </div>
</div>

<div id="adicionalModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal">
    <h3 style="margin-top:0">Selecciona valor de Adicional</h3>
    <ul id="adicionalList"></ul>
  </div>
</div>

<script>
const map = L.map('map').setView([25.6866, -100.3161], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

function getMapsLink(lat,lng){
  const ua=navigator.userAgent||navigator.vendor||window.opera;
  const isAndroid=/android/i.test(ua);
  const isIOS=/iPad|iPhone|iPod/.test(ua)&&!window.MSStream;
  const isMobile=isAndroid||isIOS;
  if(!isMobile) return `https://www.google.com/maps?q=${lat},${lng}`;
  if(isAndroid) return `google.navigation:q=${lat},${lng}&mode=d`;
  if(isIOS) return `comgooglemaps://?q=${lat},${lng}&directionsmode=driving`;
  return `https://www.google.com/maps?q=${lat},${lng}`;
}
function getWazeLink(lat,lng){
  const ua=navigator.userAgent||navigator.vendor||window.opera;
  const isMobile=/android|iPad|iPhone|iPod/i.test(ua);
  return isMobile?`waze://?ll=${lat},${lng}&navigate=yes`:`https://www.waze.com/ul?ll=${lat},${lng}&navigate=yes`;
}
</script>

<script>
/* --- TODO tu JS existente sin cambios funcionales, solo popup corregido --- */
</script>

<script>
/* SOLO parche del popup */
map.on('popupopen', e => {

  const popupEl = e.popup.getElement();
  const marker = e.popup._source;
  const lat = marker.getLatLng().lat;
  const lng = marker.getLatLng().lng;

  const gmapsBtn = popupEl.querySelector('.gmaps-btn');
  if (gmapsBtn) gmapsBtn.onclick = () => window.location.href = getMapsLink(lat,lng);

  const wazeBtn = popupEl.querySelector('.waze-btn');
  if (wazeBtn) wazeBtn.onclick = () => window.location.href = getWazeLink(lat,lng);

});
</script>

</body>
</html>
