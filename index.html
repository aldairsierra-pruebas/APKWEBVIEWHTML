<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visitas Naturgy</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #map { height: 60vh; position: relative; }
    #listPanel {
      height: 40vh;
      overflow-y: auto;
      border-top: 2px solid #ccc;
      background: white;
      transition: transform 0.3s ease-in-out;
    }
    #listPanel.hidden {
      transform: translateY(100%);
    }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th, td { padding:6px; border:1px solid #ddd; text-align:left; }
    th { background:#f4f4f4; position: sticky; top: 0; cursor:pointer; }
    tr:hover { background:#f0f8ff; cursor:pointer; }

    /* Botones flotantes */
    #locateBtn, #refreshBtn, #toggleListBtn {
      position: absolute;
      right: 10px;
      z-index: 1000;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      color: white;
    }
    #locateBtn { top: 10px; background: #007bff; }
    #refreshBtn { top: 60px; background: #17a2b8; }
    #toggleListBtn { top: 110px; background: #28a745; }

    /* Leyenda */
    #legend {
      padding: 5px;
      font-size: 13px;
      background: #fff;
      border-bottom: 2px solid #ccc;
      position: sticky;
      top: 0;
      z-index: 900;
    }
    .legend-item {
      display: inline-flex;
      align-items: center;
      margin-right: 12px;
    }
    .legend-color {
      width: 14px;
      height: 14px;
      display: inline-block;
      margin-right: 4px;
      border: 1px solid #333;
    }
  </style>
</head>
<body>
  <div id="map">
    <button id="locateBtn">üìç</button>
    <button id="refreshBtn">üîÑ</button>
    <button id="toggleListBtn">üìã</button>
  </div>
  <div id="listPanel">
    <div id="legend"></div>
    <table>
      <thead>
        <tr><th>P√≥liza</th><th>Nombre</th><th>Direcci√≥n</th></tr>
      </thead>
      <tbody id="dataTableBody"></tbody>
    </table>
  </div>

<script>
const map = L.map('map').setView([25.6866, -100.3161], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

// Colores pastel por calle
const pastelColors = ['#FFB3BA', '#BAE1FF', '#BAFFC9', '#FFFFBA', '#FFDFBA', '#E3BAFF', '#B5EAD7'];
const streetColors = {};
let markers = [];

function getColorForStreet(street) {
  if (!streetColors[street]) {
    const color = pastelColors[Object.keys(streetColors).length % pastelColors.length];
    streetColors[street] = color;
    const legendItem = document.createElement("div");
    legendItem.className = "legend-item";
    legendItem.innerHTML = `<span class="legend-color" style="background:${color}"></span>${street}`;
    document.getElementById("legend").appendChild(legendItem);
  }
  return streetColors[street];
}

function escapeHtml(text) {
  return text.replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','\"':'&quot;'}[c]));
}

function loadData() {
  const tbody = document.getElementById("dataTableBody");
  tbody.innerHTML = '';
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vQVe0kdrmOnk1W4hL1NwKhC7-2TROeMi-VXaGUtSKlvBlsljjo1KvgfUcdZA8kvADuZBYWJbIsIaqq-/pub?gid=1312490361&single=true&output=csv", {
    download: true,
    header: true,
    complete: function(results) {
      let index = 0;
      results.data.forEach(row => {
        if (!row.lat || !row.lng) return;
        const lat = parseFloat(row.lat);
        const lng = parseFloat(row.lng);
        if (isNaN(lat) || isNaN(lng)) return;

        const street = row["calle"] || "Sin calle";
        const color = getColorForStreet(street);
        const colorHex = color.replace('#', '');
        index++;

        const iconUrl = `https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=${index}|${colorHex}|000000`;
        const icon = L.icon({ iconUrl, iconSize: [30, 50], iconAnchor: [15, 50] });
        const marker = L.marker([lat, lng], { icon }).addTo(map);

        const popupHtml = `
          <strong>Colonia:</strong> ${row["Colonia"] || ''}<br/>
          <strong>P√≥liza:</strong> ${row["P√≥liza"] || ''}<br/>
          <strong>Direcci√≥n:</strong> ${row["calle"]||''} ${row["N√∫mero finca"]||''}<br/>
          <strong>Contratante:</strong> ${row["Nombre Contratante"]||''}<br/>
          <strong>Inspector:</strong> ${row["Inspector"]||''}<br/>
          <button onclick="openRoute(${lat},${lng})" style="margin-top:6px;padding:4px 8px;border:1px solid #ccc;border-radius:4px;background:#28a745;color:#fff;cursor:pointer">
            üöó Ver Ruta
          </button>`;
        marker.bindPopup(popupHtml);
        markers.push(marker);

        const tr = document.createElement('tr');
        tr.style.backgroundColor = color;
        tr.dataset.lat = lat;
        tr.dataset.lng = lng;
        tr.dataset.calle = street;
        tr.innerHTML = `
          <td>${escapeHtml(row["P√≥liza"]||'')}</td>
          <td>${escapeHtml(row["Nombre Contratante"]||'')}</td>
          <td>${escapeHtml((row["calle"]||'') + ' ' + (row["N√∫mero finca"]||''))}</td>`;
        tr.addEventListener('click', () => {
          marker.openPopup();
          map.setView([lat,lng], 17);
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        tbody.appendChild(tr);
      });
    }
  });
}

function openRoute(lat, lng) {
  const gmaps = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
  window.open(gmaps, "_blank");
}

// Botones flotantes
document.getElementById("locateBtn").addEventListener("click", () => {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      map.setView([lat, lng], 15);
      L.marker([lat, lng]).addTo(map).bindPopup("üìç Est√°s aqu√≠").openPopup();
    }, () => alert("No se pudo obtener la ubicaci√≥n."));
  } else alert("Geolocalizaci√≥n no soportada en este dispositivo.");
});

document.getElementById("refreshBtn").addEventListener("click", loadData);

document.getElementById("toggleListBtn").addEventListener("click", () => {
  document.getElementById("listPanel").classList.toggle("hidden");
});

loadData();

/* === ORDENAMIENTO DE TABLA === */
document.querySelectorAll("th").forEach((header, index) => {
  header.addEventListener("click", () => sortTableByColumn(index));
});

let currentSort = { column: null, asc: true };

function sortTableByColumn(columnIndex) {
  const table = document.querySelector("table");
  const tbody = table.querySelector("tbody");
  const rows = Array.from(tbody.querySelectorAll("tr"));

  const asc = currentSort.column === columnIndex ? !currentSort.asc : true;
  currentSort = { column: columnIndex, asc };

  rows.sort((a, b) => {
    const cellA = a.children[columnIndex].innerText.trim().toLowerCase();
    const cellB = b.children[columnIndex].innerText.trim().toLowerCase();
    const numA = parseFloat(cellA.replace(/[^\d.-]/g, ""));
    const numB = parseFloat(cellB.replace(/[^\d.-]/g, ""));

    if (!isNaN(numA) && !isNaN(numB)) return asc ? numA - numB : numB - numA;
    return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
  });

  tbody.innerHTML = "";
  rows.forEach(r => tbody.appendChild(r));
  document.querySelectorAll("th").forEach(th => th.textContent = th.textContent.replace(/[‚ñ≤‚ñº]/g, ""));
  const arrow = asc ? " ‚ñ≤" : " ‚ñº";
  table.querySelectorAll("th")[columnIndex].textContent += arrow;

  updateMarkersFromTable();
}

/* === REGENERAR √çCONOS SEG√öN ORDEN === */
function updateMarkersFromTable() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];
  const rows = document.querySelectorAll("#dataTableBody tr");
  rows.forEach((tr, i) => {
    const lat = parseFloat(tr.dataset.lat);
    const lng = parseFloat(tr.dataset.lng);
    const street = tr.dataset.calle;
    const color = streetColors[street];
    const colorHex = color.replace('#','');
    const iconUrl = `https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=${i+1}|${colorHex}|000000`;
    const icon = L.icon({ iconUrl, iconSize: [30, 50], iconAnchor: [15, 50] });
    const marker = L.marker([lat, lng], { icon }).addTo(map);
    markers.push(marker);
  });
}
</script>
</body>
</html>
