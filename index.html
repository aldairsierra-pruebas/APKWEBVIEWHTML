<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visitas Naturgy</title>
  <!-- Comprobaci√≥n de versi√≥n -->
  <script>
    function compareVersions(v1, v2) {
      const a = v1.split('.').map(Number), b = v2.split('.').map(Number);
      for (let i = 0; i < Math.max(a.length, b.length); i++) {
        const diff = (a[i] || 0) - (b[i] || 0);
        if (diff) return diff > 0 ? 1 : -1;
      }
      return 0;
    }
    const currentVersion = "2.0";
    function checkUpdate() {
      fetch("https://aldairsierra-pruebas.github.io/APKWEBVIEWHTML/update.json?nocache=" + Date.now())
        .then(r => { if (!r.ok) throw new Error(); return r.json(); })
        .then(data => {
          if (!data || !data.version) return;
          if (compareVersions(data.version, currentVersion) > 0) {
            const overlay = document.createElement('div');
            overlay.id = 'update-overlay';
            overlay.style.cssText = `
              position: fixed; top:0; left:0; width:100%; height:100%;
              background: rgba(0,0,0,0.8); color:#fff; display:flex;
              align-items:center; justify-content:center; flex-direction:column;
              text-align:center; padding:20px; z-index:99999; font-family: Arial;
            `;
            overlay.innerHTML = `
              <h2 style="margin-bottom:12px;">${data.message || 'Actualizaci√≥n disponible'}</h2>
              <p style="margin-bottom:18px;">Versi√≥n actual: ${currentVersion} ‚Äî Nueva: ${data.version}</p>
              <a href="${data.url}" style="background:#28a745;color:#fff;padding:10px 18px;border-radius:8px;text-decoration:none;font-weight:700;">
                Descargar actualizaci√≥n
              </a>
            `;
            document.body.appendChild(overlay);
          }
        })
        .catch(()=> console.warn('No se pudo verificar la versi√≥n'));
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', checkUpdate); else checkUpdate();
  </script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>

  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #map { height: 100vh; transition: height 0.3s ease; }
    #listPanel {
      height: 40vh; overflow-y: auto; border-top: 2px solid #ccc; background: #fff;
      position: fixed; bottom: 0; width: 100%; transition: transform 0.3s ease; z-index: 900;
    }
    #listPanel.hidden { transform: translateY(100%); }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th, td { padding:6px; border:1px solid #ddd; text-align:left; }
    th { background:#f4f4f4; position: sticky; top: 0; cursor: pointer; }
    tr:hover { background:#f0f8ff; cursor:pointer; }

    #locateBtn, #refreshBtn, #toggleBtn {
      position: absolute; right: 10px; z-index: 1000;
      border:none; border-radius:50%; width:40px; height:40px; font-size:18px; cursor:pointer; color:white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    #locateBtn { top:10px; background:#007bff; }
    #refreshBtn { top:60px; background:#17a2b8; }
    #toggleBtn { top:110px; background:#6f42c1; }

    #legend {
      padding: 6px; font-size:13px; background:#fff; border-bottom:2px solid #ccc; position: sticky; top:0; z-index:900;
      display:flex; flex-wrap:wrap; gap:6px;
    }
    .legend-item {
      display:inline-flex; align-items:center; gap:6px; padding:4px 8px;
      background:#f7f7f7; border:1px solid #ddd; border-radius:6px; cursor:pointer;
    }
    .legend-color { width:14px; height:14px; border:1px solid #333; border-radius:3px; }
    .legend-item.active { outline:2px solid #007bff; }

    /* estilos del bot√≥n de voz (se usan inline tambi√©n en el popup) */
    .voice-btn {
      display:inline-flex; align-items:center; justify-content:center;
      border:none; cursor:pointer; border-radius:8px; padding:6px 10px; font-size:18px;
      color:#fff; min-width:44px; min-height:36px; box-sizing:border-box;
    }
    .popup-controls { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    .popup-checkboxes { display:flex; gap:8px; align-items:center; margin-left:6px; }
    .popup-top-right { position:absolute; top:6px; right:6px; display:flex; gap:6px; align-items:center; }
    .small-checkbox { transform:scale(1.05); }
    .tiny-label { font-size:12px; }
  </style>
</head>

<body>
  <div id="map">
    <button id="locateBtn">üìç</button>
    <button id="refreshBtn">üîÑ</button>
    <button id="toggleBtn">üìã</button>
  </div>

  <div id="listPanel">
    <div id="legend"></div>
    <table>
      <thead><tr><th>P√≥liza</th><th>Nombre</th><th>Direcci√≥n</th></tr></thead>
      <tbody id="dataTableBody"></tbody>
    </table>
  </div>

  <script>
  const map = L.map('map').setView([25.6866, -100.3161], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  const vividColors = ['#ff4d4d','#4d79ff','#33cc33','#ffcc00','#ff66cc','#33cccc','#9933ff','#ff9966'];
  const streetColors = {};
  let currentData = [], markers = [], filteredStreet = null, userMarker = null;
  let currentSort = { column: null, asc: true };

  // Optional: endpoint to persist changes to your sheet via a Google Apps Script or other server.
  // If you have one, set it here (e.g. 'https://script.google.com/macros/s/XXX/exec') and the code will POST {poliza, status}
  const UPDATE_ENDPOINT = ''; // <- configure if you have a server-side handler

  function ensureColor(street) {
    if (!streetColors[street]) {
      streetColors[street] = vividColors[Object.keys(streetColors).length % vividColors.length];
    }
    return streetColors[street];
  }

  function createIcon(number, color) {
    const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="46" height="62" viewBox="0 0 46 62">
        <path d="M23 62s-18-22-18-34A18 18 0 1 1 41 28c0 12-18 34-18 34z"
          fill="${color}" stroke="#222" stroke-width="2"/>
        <text x="23" y="30" font-family="Arial, Helvetica, sans-serif" font-size="18" font-weight="700" fill="#fff" text-anchor="middle">${number}</text>
      </svg>`;
    return L.icon({ iconUrl: "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg), iconSize: [38, 56], iconAnchor: [19, 56], popupAnchor: [0, -48] });
  }

  function escapeHtml(text) {
    return (text||'').toString().replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','"':'&quot;'}[c]));
  }

  function loadData() {
    document.getElementById('dataTableBody').innerHTML = '';
    document.getElementById('legend').innerHTML = '';
    for (const k in streetColors) delete streetColors[k];
    markers.forEach(m => map.removeLayer(m)); markers = [];
    currentData = [];

    Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vQVe0kdrmOnk1W4hL1NwKhC7-2TROeMi-VXaGUtSKlvBlsljjo1KvgfUcdZA8kvADuZBYWJbIsIaqq-/pub?gid=1312490361&single=true&output=csv", {
      download: true, header: true,
      complete: function(results) {
        results.data.forEach(r => {
          if (!r || (!r.lat && !r.lng)) return;
          const lat = parseFloat(r.lat), lng = parseFloat(r.lng);
          if (isNaN(lat) || isNaN(lng)) return;
          currentData.push(r);
        });
        buildLegend();
        if (currentSort.column !== null) applySort();
        renderAll();
      }
    });
  }

  function buildLegend() {
    const legend = document.getElementById('legend');
    legend.innerHTML = '';
    const streets = Array.from(new Set(currentData.map(r => (r["calle"]||'Sin calle')))).sort();
    streets.forEach(s => {
      const color = ensureColor(s);
      const item = document.createElement('div');
      item.className = 'legend-item';
      item.innerHTML = `<span class="legend-color" style="background:${color}"></span>${s}`;
      item.addEventListener('click', () => toggleFilter(s, item));
      if (filteredStreet === s) item.classList.add('active');
      legend.appendChild(item);
    });
  }

  function renderAll() {
    const tbody = document.getElementById('dataTableBody');
    tbody.innerHTML = '';
    markers.forEach(m => map.removeLayer(m)); markers = [];

    const list = currentData.filter(r => !filteredStreet || (r["calle"]||'Sin calle') === filteredStreet);

    list.forEach((row, i) => {
      const street = row["calle"] || 'Sin calle';
      const color = (row["Estatus"]||'').startsWith('üü¢') ? '#33cc33' : ensureColor(street);
      const icon = createIcon(i+1, color);
      const lat = parseFloat(row.lat), lng = parseFloat(row.lng);

      const marker = L.marker([lat, lng], { icon }).addTo(map);

      // build popup KEEPING ALL ORIGINAL FIELDS and adding controls at top-right inside popup
      const popupHtml = `
        <div style="font-family:Arial,Helvetica,sans-serif;line-height:1.25; position: relative; padding:6px 10px 36px 10px; min-width:260px;">
          <div class="popup-top-right">
            <div class="popup-checkboxes tiny-label">
              <label title="Marcar como realizado" style="display:inline-flex;align-items:center;gap:6px"><input type="checkbox" class="done-checkbox small-checkbox"> <span>Hecho</span></label>
              <label title="Modo autom√°tico" style="display:inline-flex;align-items:center;gap:6px"><input type="checkbox" class="auto-checkbox small-checkbox"> <span>Auto</span></label>
            </div>
          </div>

          <strong>Colonia:</strong> ${escapeHtml(row["Colonia"]||'')}<br/>
          <strong>P√≥liza:</strong> ${escapeHtml(row["P√≥liza"]||'')}<br/>
          <strong>Direcci√≥n:</strong> ${escapeHtml(row["calle"]||'')} ${escapeHtml(row["N√∫mero finca"]||'')}<br/>
          <strong>Contratante:</strong> ${escapeHtml(row["Nombre Contratante"]||'')}<br/>
          <strong>Inspector:</strong> ${escapeHtml(row["Inspector"]||'')}<br/>
          <strong>Estatus:</strong> <span class="estatus-text">${escapeHtml(row["Estatus"]||'')}</span><br/>

          <div style="margin-top:8px; display:flex; gap:6px; align-items:center;">
            <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank"
               style="background:#007bff;color:#fff;padding:6px 8px;border-radius:6px;text-decoration:none;font-size:13px;display:inline-flex;align-items:center;">üöó Google</a>
            <a href="https://waze.com/ul?ll=${lat},${lng}&navigate=yes" target="_blank"
               style="background:#ff6600;color:#fff;padding:6px 8px;border-radius:6px;text-decoration:none;font-size:13px;display:inline-flex;align-items:center;">üß≠ Waze</a>

            <!-- VOZ BUTTON -->
            <button class="voice-btn" title="Reproducir/Pausar voz" style="background:#28a745;">üîà</button>

            <!-- Next button (keeps original behaviour) -->
            <button class="voice-btn next-popup-btn" title="Next" style="background:#6f42c1;">‚è≠Ô∏è</button>
          </div>

        </div>`;

      marker.bindPopup(popupHtml);
      markers.push(marker);

      const tr = document.createElement('tr');
      tr.style.background = color + '22';
      tr.innerHTML = `
        <td>${escapeHtml(row["P√≥liza"]||'')}</td>
        <td>${escapeHtml(row["Nombre Contratante"]||'')}</td>
        <td>${escapeHtml((row["calle"]||'') + ' ' + (row["N√∫mero finca"]||''))}</td>`;
      tr.addEventListener('click', () => { marker.openPopup(); map.setView([lat, lng], 17); });
      tbody.appendChild(tr);
    });
  }

  function toggleFilter(street, itemElement) {
    const items = document.querySelectorAll('.legend-item');
    if (filteredStreet === street) {
      filteredStreet = null;
      items.forEach(it => it.classList.remove('active'));
    } else {
      filteredStreet = street;
      items.forEach(it => it.classList.toggle('active', it === itemElement));
    }
    renderAll();
  }

  function applySort() {
    const col = currentSort.column;
    const asc = currentSort.asc;
    if (col === 0) {
      currentData.sort((a,b) => {
        const na = parseFloat((a['P√≥liza']||'').toString().replace(/[^\d.-]/g,'')) || 0;
        const nb = parseFloat((b['P√≥liza']||'').toString().replace(/[^\d.-]/g,'')) || 0;
        return asc ? na - nb : nb - na;
      });
    } else if (col === 1) {
      currentData.sort((a,b) => {
        const sa = (a['Nombre Contratante']||'').toLowerCase();
        const sb = (b['Nombre Contratante']||'').toLowerCase();
        return asc ? sa.localeCompare(sb,'es') : sb.localeCompare(sa,'es');
      });
    } else if (col === 2) {
      currentData.sort((a,b) => {
        const ca = (a['calle']||'').toLowerCase();
        const cb = (b['calle']||'').toLowerCase();
        if (ca !== cb) return asc ? ca.localeCompare(cb,'es') : cb.localeCompare(ca,'es');
        const na = parseInt(a['N√∫mero finca']||'') || 0;
        const nb = parseInt(b['N√∫mero finca']||'') || 0;
        return asc ? na - nb : nb - na;
      });
    }
  }

  document.querySelectorAll('th').forEach((th, idx) => {
    th.addEventListener('click', () => {
      currentSort.asc = (currentSort.column === idx) ? !currentSort.asc : true;
      currentSort.column = idx;
      applySort();
      document.querySelectorAll('th').forEach(h => h.textContent = h.textContent.replace(/[‚ñ≤‚ñº]/g,''));
      th.textContent += currentSort.asc ? ' ‚ñ≤' : ' ‚ñº';
      renderAll();
    });
  });

  // Botones principales
  document.getElementById('locateBtn').addEventListener('click', () => {
    if (!navigator.geolocation) return alert('Geolocalizaci√≥n no soportada');
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat = pos.coords.latitude, lng = pos.coords.longitude;
      map.setView([lat,lng],15);
      if (userMarker) map.removeLayer(userMarker);
      userMarker = L.marker([lat,lng]).addTo(map).bindPopup('üìç Est√°s aqu√≠').openPopup();
    }, ()=>alert('No se pudo obtener la ubicaci√≥n.'));
  });

  document.getElementById('refreshBtn').addEventListener('click', loadData);
  document.getElementById('toggleBtn').addEventListener('click', ()=>document.getElementById('listPanel').classList.toggle('hidden'));

  // --- VOZ: utilidades y comportamiento solicitado ---
  let voiceCanceled = false;
  let autoRunning = false;

  function stopSpeech() {
    voiceCanceled = true;
    try { window.speechSynthesis.cancel(); } catch (e) { /* ignore */ }
  }

  function delay(ms) { return new Promise(res => setTimeout(res, ms)); }

  function computePauseForText(text) {
    // pausa proporcional a la longitud del texto (en ms)
    const len = (text||'').toString().trim().length;
    // approx 80ms por caracter, limit min 300ms max 2200ms
    return Math.max(300, Math.min(2200, Math.round(len * 80)));
  }

  function computePauseBetweenDigits(digitsCount) {
    // pausa m√°s corta entre d√≠gitos pero dependiente de la longitud
    return Math.max(200, Math.min(900, Math.round(digitsCount * 60)));
  }

  async function speakText(text, opts={rate:1.0}){
    if (voiceCanceled) return;
    return new Promise(res => {
      const u = new SpeechSynthesisUtterance(text.toString());
      u.lang = 'es-MX';
      u.rate = opts.rate || 1.0;
      u.onend = () => res();
      u.onerror = () => res();
      window.speechSynthesis.speak(u);
    });
  }

  async function speakRowSequential(startIndex, visibleMarkersIndices) {
    // startIndex: index in markers/currentData of the first to speak
    // visibleMarkersIndices: array of marker indexes to consider in order
    autoRunning = true; voiceCanceled = false;

    // build ordered list starting from startIndex over visibleMarkersIndices
    const ordered = [];
    for (let idx of visibleMarkersIndices) ordered.push(idx);
    // rotate so startIndex comes first
    while (ordered.length && ordered[0] !== startIndex) ordered.push(ordered.shift());

    for (let idx of ordered) {
      if (voiceCanceled) break;
      const row = currentData[idx];
      const status = (row['Estatus']||'').toString();
      if (status.startsWith('üü¢')) continue; // skip done

      // open popup for visibility
      if (markers[idx]) {
        markers[idx].openPopup();
        map.setView(markers[idx].getLatLng(), 17);
      }

      // speak p√≥liza digit by digit
      const polRaw = (row['P√≥liza']||'').toString();
      const digits = polRaw.replace(/\D/g,'').split('').filter(Boolean);
      if (digits.length === 0 && polRaw.trim().length>0) {
        // fallback: speak whole
        await speakText(polRaw, {rate:1.05});
        await delay(computePauseForText(polRaw));
      } else {
        for (let d of digits) {
          if (voiceCanceled) break;
          await speakText(d, {rate:1.05});
          await delay(computePauseBetweenDigits(digits.length));
        }
      }

      if (voiceCanceled) break;

      // speak name
      const nombre = (row['Nombre Contratante']||'').toString();
      if (nombre.trim().length>0) {
        await delay(200);
        // speak word by word but keep natural pause based on full length
        await speakText(nombre, {rate:1.0});
        await delay(computePauseForText(nombre));
      }

      if (voiceCanceled) break;

      // if not last pending, say "Siguiente" and small pause
      // determine if there's any pending later in ordered
      const laterPending = ordered.slice(ordered.indexOf(idx)+1).some(i => !(currentData[i]['Estatus']||'').toString().startsWith('üü¢'));
      if (laterPending) {
        await speakText('Siguiente', {rate:1.05});
        await delay(700);
      } else {
        // stop at last
        break;
      }
    }

    autoRunning = false; voiceCanceled = false;
  }

  // helper to update status locally and optionally on server
  async function setStatusForPoliza(poliza, newStatus) {
    // update currentData row(s) matching poliza
    let updatedIndexes = [];
    currentData.forEach((r, idx) => {
      if ((r['P√≥liza']||'').toString() === poliza.toString()) {
        r['Estatus'] = newStatus;
        updatedIndexes.push(idx);
      }
    });

    // update markers icons and popup estatus text
    updatedIndexes.forEach(i => {
      // replace icon color
      const color = newStatus.startsWith('üü¢') ? '#33cc33' : ensureColor(currentData[i]['calle']||'Sin calle');
      const newIcon = createIcon(i+1, color);
      if (markers[i]) markers[i].setIcon(newIcon);
    });

    // try to persist to server if endpoint provided
    if (UPDATE_ENDPOINT) {
      try {
        await fetch(UPDATE_ENDPOINT, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({poliza, status:newStatus}) });
      } catch (e) { console.warn('No se pudo persistir estado en servidor:', e); }
    }

    // re-render table body estatus cell quickly
    const tbody = document.getElementById('dataTableBody');
    // simple re-render for performance
    renderAll();
  }

  // popupopen: wire controls (voice, auto, done, next)
  map.on('popupopen', e => {
    const popupEl = e.popup.getElement();
    const voiceBtn = popupEl.querySelector('.voice-btn');
    const nextBtn = popupEl.querySelector('.next-popup-btn') || popupEl.querySelector('.popup-next-btn') || popupEl.querySelector('.voice-btn.next-popup-btn');
    const doneCheckbox = popupEl.querySelector('.done-checkbox');
    const autoCheckbox = popupEl.querySelector('.auto-checkbox');

    // find marker index for this popup
    const markerLat = e.popup._source.getLatLng().lat;
    const markerLng = e.popup._source.getLatLng().lng;
    const markerIndex = currentData.findIndex(r => parseFloat(r.lat) === markerLat && parseFloat(r.lng) === markerLng);
    const row = currentData[markerIndex];

    // set checkbox states according to data
    if (doneCheckbox) {
      doneCheckbox.checked = ((row['Estatus']||'').toString()).startsWith('üü¢');
      doneCheckbox.onchange = async () => {
        if (doneCheckbox.checked) {
          const now = new Date();
          const stamp = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0') + ' ' + String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
          const newStatus = 'üü¢ Realizado - ' + stamp;
          await setStatusForPoliza(row['P√≥liza']||'', newStatus);
          // if auto was running, stop it when this is done
          if (autoRunning) { stopSpeech(); }
        } else {
          const newStatus = 'üî¥ Pendiente';
          await setStatusForPoliza(row['P√≥liza']||'', newStatus);
        }
      };
    }

    if (autoCheckbox) {
      autoCheckbox.checked = false;
      autoCheckbox.onchange = async () => {
        if (autoCheckbox.checked) {
          // gather visible markers indices in order (markers array order)
          const visibles = markers.map((m,idx)=> idx).filter(idx => map.hasLayer(markers[idx]));
          // start from markerIndex, but only pending ones will be spoken
          speakRowSequential(markerIndex, visibles).catch(err=>{console.warn(err);});
        } else {
          stopSpeech();
        }
      };
    }

    // voice button: manual single speak for this row
    if (voiceBtn) {
      voiceBtn.onclick = async () => {
        // toggle: if speaking, stop
        if (window.speechSynthesis.speaking || window.speechSynthesis.pending) { stopSpeech(); return; }
        voiceCanceled = false;
        // speak this single row
        const polRaw = (row['P√≥liza']||'').toString();
        const digits = polRaw.replace(/\D/g,'').split('').filter(Boolean);
        if (digits.length === 0 && polRaw.trim().length>0) {
          await speakText(polRaw, {rate:1.05});
          await delay(computePauseForText(polRaw));
        } else {
          for (let d of digits) {
            if (voiceCanceled) break;
            await speakText(d, {rate:1.05});
            await delay(computePauseBetweenDigits(digits.length));
          }
        }
        if (!voiceCanceled) {
          const nombre = (row['Nombre Contratante']||'').toString();
          if (nombre.trim().length>0) {
            await delay(150);
            await speakText(nombre, {rate:1.0});
            await delay(computePauseForText(nombre));
          }
        }
      };
    }

    // Next button: moves to next visible marker
    if (nextBtn) {
      nextBtn.onclick = () => {
        const visibles = markers.filter(m => map.hasLayer(m));
        if (visibles.length === 0) return;

        let idx = visibles.findIndex(m => m === e.popup._source);
        idx = (idx + 1) % visibles.length;
        const nextMarker = visibles[idx];

        map.setView(nextMarker.getLatLng(), 17);
        nextMarker.openPopup();
      };
    }

  });

  map.on('popupclose', () => {
    stopSpeech();
    autoRunning = false;
  });

  document.addEventListener('visibilitychange', () => {
    if (document.hidden) { stopSpeech(); }
  });

  // Inicio
  loadData();
  </script>
</body>
</html>
