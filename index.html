<!DOCTYPE html>    
<html lang="es">    
<head>    
  <meta charset="UTF-8">    
  <title>Visitas Naturgy</title>      
  <!-- Comprobaci√≥n de versi√≥n -->      
  <script>    
    function compareVersions(v1, v2) {    
      const a = v1.split('.').map(Number), b = v2.split('.').map(Number);    
      for (let i = 0; i < Math.max(a.length, b.length); i++) {    
        const diff = (a[i] || 0) - (b[i] || 0);    
        if (diff) return diff > 0 ? 1 : -1;    
      }    
      return 0;    
    }    
    const currentVersion = "2.0";    
    function checkUpdate() {    
      fetch("https://aldairsierra-pruebas.github.io/APKWEBVIEWHTML/update.json?nocache=" + Date.now())    
        .then(r => { if (!r.ok) throw new Error(); return r.json(); })    
        .then(data => {    
          if (!data || !data.version) return;    
          if (compareVersions(data.version, currentVersion) > 0) {    
            const overlay = document.createElement('div');    
            overlay.id = 'update-overlay';    
            overlay.style.cssText = `    
              position: fixed; top:0; left:0; width:100%; height:100%;    
              background: rgba(0,0,0,0.8); color:#fff; display:flex;    
              align-items:center; justify-content:center; flex-direction:column;    
              text-align:center; padding:20px; z-index:99999; font-family: Arial;    
            `;    
            overlay.innerHTML = `    
              <h2 style="margin-bottom:12px;">${data.message || 'Actualizaci√≥n disponible'}</h2>    
              <p style="margin-bottom:18px;">Versi√≥n actual: ${currentVersion} ‚Äî Nueva: ${data.version}</p>    
              <a href="${data.url}" style="background:#28a745;color:#fff;padding:10px 18px;border-radius:8px;text-decoration:none;font-weight:700;">    
                Descargar actualizaci√≥n    
              </a>    
            `;    
            document.body.appendChild(overlay);    
          }    
        })    
        .catch(()=> console.warn('No se pudo verificar la versi√≥n'));    
    }    
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', checkUpdate); else checkUpdate();    
  </script>      
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />    
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>    
  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>      
  
  <style>    
    body { margin:0; font-family: Arial, sans-serif; }    
    #map { height: 100vh; transition: height 0.3s ease; }    
    #listPanel {    
      height: 40vh; overflow-y: auto; border-top: 2px solid #ccc; background: #fff;    
      position: fixed; bottom: 0; width: 100%; transition: transform 0.3s ease; z-index: 900;    
    }    
    #listPanel.hidden { transform: translateY(100%); }    
    table { width:100%; border-collapse: collapse; font-size:14px; }    
    th, td { padding:6px; border:1px solid #ddd; text-align:left; }    
    th { background:#f4f4f4; position: sticky; top: 0; cursor: pointer; }    
    tr:hover { background:#f0f8ff; cursor:pointer; }    
  
    #locateBtn, #refreshBtn, #toggleBtn {    
      position: absolute; right: 10px; z-index: 1000;    
      border:none; border-radius:50%; width:40px; height:40px; font-size:18px; cursor:pointer; color:white;    
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);    
    }    
    #locateBtn { top:10px; background:#007bff; }    
    #refreshBtn { top:60px; background:#17a2b8; }    
    #toggleBtn { top:110px; background:#6f42c1; }    
  
    #legend {    
      padding: 6px; font-size:13px; background:#fff; border-bottom:2px solid #ccc; position: sticky; top:0; z-index:900;    
      display:flex; flex-wrap:wrap; gap:6px;    
    }    
    .legend-item {    
      display:inline-flex; align-items:center; gap:6px; padding:4px 8px;    
      background:#f7f7f7; border:1px solid #ddd; border-radius:6px; cursor:pointer;    
    }    
    .legend-color { width:14px; height:14px; border:1px solid #333; border-radius:3px; }    
    .legend-item.active { outline:2px solid #007bff; }    
  
    /* estilos del bot√≥n de voz (se usan inline tambi√©n en el popup) */  
    .voice-btn {  
      display:inline-flex; align-items:center; justify-content:center;  
      border:none; cursor:pointer; border-radius:8px; padding:6px 10px; font-size:18px;  
      color:#fff;  
    }  
  </style>    
</head>    
  
<body>    
  <div id="map">    
    <button id="locateBtn">üìç</button>    
    <button id="refreshBtn">üîÑ</button>    
    <button id="toggleBtn">üìã</button>    
  </div>      
  
  <div id="listPanel">    
    <div id="legend"></div>    
    <table>    
      <thead><tr><th>P√≥liza</th><th>Nombre</th><th>Direcci√≥n</th></tr></thead>    
      <tbody id="dataTableBody"></tbody>    
    </table>    
  </div>    
  
  <script>    
  const map = L.map('map').setView([25.6866, -100.3161], 12);    
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);    
  
  const vividColors = ['#ff4d4d','#4d79ff','#33cc33','#ffcc00','#ff66cc','#33cccc','#9933ff','#ff9966'];    
  const streetColors = {};    
  let currentData = [], markers = [], filteredStreet = null, userMarker = null;    
  let currentSort = { column: null, asc: true };    
  
  function ensureColor(street) {    
    if (!streetColors[street]) {    
      streetColors[street] = vividColors[Object.keys(streetColors).length % vividColors.length];    
    }    
    return streetColors[street];    
  }    
  
  function buildLegend() {    
    const legend = document.getElementById('legend');    
    legend.innerHTML = '';    
    const streets = Array.from(new Set(currentData.map(r => (r["calle"]||'Sin calle')))).sort();    
    streets.forEach(s => {    
      const color = ensureColor(s);    
      const item = document.createElement('div');    
      item.className = 'legend-item';    
      item.innerHTML = `<span class="legend-color" style="background:${color}"></span>${s}`;    
      item.addEventListener('click', () => toggleFilter(s, item));    
      if (filteredStreet === s) item.classList.add('active');    
      legend.appendChild(item);    
    });    
  }    
  
  function createIcon(number, color) {    
    const svg = `    
      <svg xmlns="http://www.w3.org/2000/svg" width="46" height="62" viewBox="0 0 46 62">    
        <path d="M23 62s-18-22-18-34A18 18 0 1 1 41 28c0 12-18 34-18 34z"    
          fill="${color}" stroke="#222" stroke-width="2"/>    
        <text x="23" y="30" font-family="Arial, Helvetica, sans-serif" font-size="18" font-weight="700" fill="#fff" text-anchor="middle">${number}</text>    
      </svg>`;    
    return L.icon({ iconUrl: "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg), iconSize: [38, 56], iconAnchor: [19, 56], popupAnchor: [0, -48] });    
  }    
  
  function escapeHtml(text) {    
    return (text||'').toString().replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','"':'&quot;'}[c]));    
  }    
  
  function loadData() {    
    document.getElementById('dataTableBody').innerHTML = '';    
    document.getElementById('legend').innerHTML = '';    
    for (const k in streetColors) delete streetColors[k];    
    markers.forEach(m => map.removeLayer(m)); markers = [];    
    currentData = [];    
  
    Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vQVe0kdrmOnk1W4hL1NwKhC7-2TROeMi-VXaGUtSKlvBlsljjo1KvgfUcdZA8kvADuZBYWJbIsIaqq-/pub?gid=1312490361&single=true&output=csv", {    
      download: true, header: true,    
      complete: function(results) {    
        results.data.forEach(r => {    
          if (!r || (!r.lat && !r.lng)) return;    
          const lat = parseFloat(r.lat), lng = parseFloat(r.lng);    
          if (isNaN(lat) || isNaN(lng)) return;    
          currentData.push(r);    
        });    
        buildLegend();    
        if (currentSort.column !== null) applySort();    
        renderAll();    
      }    
    });    
  }    
  
  function renderAll() {    
    const tbody = document.getElementById('dataTableBody');    
    tbody.innerHTML = '';    
    markers.forEach(m => map.removeLayer(m)); markers = [];    
  
    const list = currentData.filter(r => !filteredStreet || (r["calle"]||'Sin calle') === filteredStreet);    
  
    list.forEach((row, i) => {    
      const street = row["calle"] || 'Sin calle';    
      const color = ensureColor(street);    
      const icon = createIcon(i+1, color);    
      const lat = parseFloat(row.lat), lng = parseFloat(row.lng);    
  
      const marker = L.marker([lat, lng], { icon }).addTo(map);    
  
      // popup: agregamos bot√≥n de voz (sin modificar lo dem√°s)  
      const popupHtml = `    
        <div style="font-family:Arial,Helvetica,sans-serif;line-height:1.25; position: relative;">    
          <strong>Colonia:</strong> ${escapeHtml(row["Colonia"]||'')}<br/>    
          <strong>P√≥liza:</strong> ${escapeHtml(row["P√≥liza"]||'')}<br/>    
          <strong>Direcci√≥n:</strong> ${escapeHtml(row["calle"]||'')} ${escapeHtml(row["N√∫mero finca"]||'')}<br/>    
          <strong>Contratante:</strong> ${escapeHtml(row["Nombre Contratante"]||'')}<br/>    
          <strong>Inspector:</strong> ${escapeHtml(row["Inspector"]||'')}<br/>    
          <strong>Estatus:</strong> ${escapeHtml(row["Estatus"]||'')}<br/>    
          <div style="margin-top:8px; display:flex; gap:6px;">    
            <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank"    
               style="background:#007bff;color:#fff;padding:6px 8px;border-radius:6px;text-decoration:none;font-size:13px;">üöó Google</a>    
            <a href="https://waze.com/ul?ll=${lat},${lng}&navigate=yes" target="_blank"    
               style="background:#ff6600;color:#fff;padding:6px 8px;border-radius:6px;text-decoration:none;font-size:13px;">üß≠ Waze</a>    
  
            <!-- BOT√ìN DE VOZ: mismo bot√≥n ser√° toggle (reproducir / detener) -->  
            <button class="voice-btn" title="Reproducir/Pausar voz" style="background:#28a745;">  
              üîà  
            </button>    
          </div>    
  
          <button class="popup-next-btn" style="    
            position:absolute; bottom:6px; right:6px; padding:4px 8px;    
            font-size:12px; background:#28a745; color:#fff; border:none; border-radius:4px; cursor:pointer;">    
            Next    
          </button>    
        </div>`;    
  
      marker.bindPopup(popupHtml);    
      markers.push(marker);    
  
      const tr = document.createElement('tr');    
      tr.style.background = color + '22';