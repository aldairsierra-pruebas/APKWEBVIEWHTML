<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visitas Naturgy</title>

<!-- ====== COMPROBACIÓN DE VERSIÓN ====== -->
<script>
function compareVersions(v1, v2) {
  const a = v1.split('.').map(Number), b = v2.split('.').map(Number);
  for (let i = 0; i < Math.max(a.length, b.length); i++) {
    const diff = (a[i] || 0) - (b[i] || 0);
    if (diff) return diff > 0 ? 1 : -1;
  }
  return 0;
}
const currentVersion = "2.1";
fetch("https://aldairsierra-pruebas.github.io/APKWEBVIEWHTML/update.json?nocache=" + Date.now())
  .then(r => r.ok ? r.json() : Promise.reject())
  .then(d => {
    if (compareVersions(d.version, currentVersion) < 0) {
      const overlay = document.createElement("div");
      overlay.style.cssText = `
        position:fixed;top:0;left:0;width:100%;height:100%;
        background:rgba(0,0,0,.8);color:white;display:flex;
        flex-direction:column;align-items:center;justify-content:center;
        text-align:center;z-index:9999;font-family:Arial;
      `;
      overlay.innerHTML = `
        <h2>${d.message}</h2>
        <p>Versión actual: ${currentVersion} | Nueva: ${d.version}</p>
        <a href="${d.url}" style="background:#28a745;color:#fff;
          padding:10px 20px;border-radius:6px;text-decoration:none;font-size:18px;">Actualizar</a>`;
      document.body.appendChild(overlay);
    }
  })
  .catch(() => console.warn("No se pudo verificar la versión"));
</script>

<!-- ====== LIBRERÍAS ====== -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>

<!-- ====== ESTILOS ====== -->
<style>
  body { margin:0; font-family: Arial, sans-serif; }
  #map { height: 100vh; transition: height 0.3s ease; }
  #listPanel {
    height: 40vh; overflow-y: auto; border-top: 2px solid #ccc; background: #fff;
    position: fixed; bottom: 0; width: 100%; transition: transform 0.3s ease; z-index: 900;
  }
  #listPanel.hidden { transform: translateY(100%); }
  table { width:100%; border-collapse: collapse; font-size:14px; }
  th, td { padding:6px; border:1px solid #ddd; text-align:left; }
  th { background:#f4f4f4; position: sticky; top: 0; cursor: pointer; }
  tr:hover { background:#f0f8ff; cursor:pointer; }

  #locateBtn, #refreshBtn, #toggleBtn {
    position: absolute; right: 10px; z-index: 1000;
    border: none; border-radius: 50%; width: 40px; height: 40px;
    font-size: 18px; cursor: pointer; color: white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }
  #locateBtn { top: 10px; background: #007bff; }
  #refreshBtn { top: 60px; background: #17a2b8; }
  #toggleBtn { top: 110px; background: #6f42c1; }

  #legend {
    padding: 5px; font-size: 13px; background: #fff;
    border-bottom: 2px solid #ccc; position: sticky; top: 0; z-index: 900;
    display: flex; flex-wrap: wrap; gap: 6px;
  }
  .legend-item {
    display: inline-flex; align-items: center; gap: 4px;
    background: #f7f7f7; border: 1px solid #ccc; border-radius: 4px;
    padding: 3px 6px; cursor: pointer; transition: background .2s;
  }
  .legend-item:hover { background: #e6e6e6; }
  .legend-color { width: 14px; height: 14px; border: 1px solid #333; border-radius: 3px; }
  .legend-item.active { outline: 2px solid #007bff; }
</style>
</head>
<body>
  <div id="map">
    <button id="locateBtn">📍</button>
    <button id="refreshBtn">🔄</button>
    <button id="toggleBtn">📋</button>
  </div>

  <div id="listPanel">
    <div id="legend"></div>
    <table>
      <thead><tr><th>Póliza</th><th>Nombre</th><th>Dirección</th></tr></thead>
      <tbody id="dataTableBody"></tbody>
    </table>
  </div>

<script>
const map = L.map('map').setView([25.6866, -100.3161], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

const vividColors = ['#ff4d4d','#4d79ff','#33cc33','#ffcc00','#ff66cc','#33cccc','#9933ff','#ff9966'];
const streetColors = {};
let currentData = [], markers = [], filteredStreet = null;

function getColor(street) {
  if (!streetColors[street]) {
    const color = vividColors[Object.keys(streetColors).length % vividColors.length];
    streetColors[street] = color;
    const item = document.createElement("div");
    item.className = "legend-item";
    item.innerHTML = `<span class="legend-color" style="background:${color}"></span>${street}`;
    item.addEventListener("click", () => toggleFilter(street, item));
    document.getElementById("legend").appendChild(item);
  }
  return streetColors[street];
}

function createIcon(num, color) {
  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="42" height="56" viewBox="0 0 42 56">
    <path d="M21 56s-16-19-16-30A16 16 0 1 1 37 26c0 11-16 30-16 30z"
          fill="${color}" stroke="#222" stroke-width="2"/>
    <text x="21" y="26" font-family="Arial" font-size="16" font-weight="700"
          fill="#fff" text-anchor="middle">${num}</text>
  </svg>`;
  return L.icon({ iconUrl: "data:image/svg+xml," + encodeURIComponent(svg), iconSize: [36, 50], iconAnchor: [18, 50] });
}

function loadData() {
  clearAll();
  Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vQVe0kdrmOnk1W4hL1NwKhC7-2TROeMi-VXaGUtSKlvBlsljjo1KvgfUcdZA8kvADuZBYWJbIsIaqq-/pub?gid=1312490361&single=true&output=csv", {
    download: true, header: true,
    complete: r => { currentData = r.data.filter(x=>x.lat&&x.lng); renderAll(); }
  });
}

function renderAll() {
  document.getElementById("dataTableBody").innerHTML = "";
  markers.forEach(m => map.removeLayer(m)); markers = [];

  currentData.forEach((row,i)=>{
    const street = row["calle"] || "Sin calle";
    if (filteredStreet && street !== filteredStreet) return;
    const color = getColor(street);
    const icon = createIcon(i+1, color);
    const lat = parseFloat(row.lat), lng = parseFloat(row.lng);

    const marker = L.marker([lat,lng],{icon}).addTo(map);
    marker.bindPopup(`
      <b>${row["Nombre Contratante"]||''}</b><br>
      ${row["calle"]||''} ${row["Número finca"]||''}<br>
      <small>${row["Colonia"]||''}</small><br>
      <button onclick="openRoute(${lat},${lng})" style="margin-top:5px;padding:4px 8px;background:#28a745;color:#fff;border:none;border-radius:4px;">🚗 Ruta</button>
    `);
    markers.push(marker);

    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${row["Póliza"]||''}</td><td>${row["Nombre Contratante"]||''}</td>
                    <td>${(row["calle"]||'')+' '+(row["Número finca"]||'')}</td>`;
    tr.style.background = color + "30"; // leve transparencia
    tr.addEventListener("click", ()=>{ marker.openPopup(); map.setView([lat,lng],17); });
    document.getElementById("dataTableBody").appendChild(tr);
  });
}

function toggleFilter(street, item) {
  const legendItems = document.querySelectorAll(".legend-item");
  if (filteredStreet === street) {
    filteredStreet = null;
    legendItems.forEach(el => el.classList.remove("active"));
  } else {
    filteredStreet = street;
    legendItems.forEach(el => el.classList.toggle("active", el === item));
  }
  renderAll();
}

function clearAll() {
  markers.forEach(m => map.removeLayer(m));
  markers = []; currentData = [];
  document.getElementById("legend").innerHTML = ""; Object.keys(streetColors).forEach(k => delete streetColors[k]);
}

function openRoute(lat,lng){window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`,"_blank");}

document.getElementById("locateBtn").onclick = () => {
  if (navigator.geolocation)
    navigator.geolocation.getCurrentPosition(p => {
      const {latitude, longitude} = p.coords;
      map.setView([latitude, longitude], 15);
      L.marker([latitude, longitude]).addTo(map).bindPopup("📍 Estás aquí").openPopup();
    });
};
document.getElementById("refreshBtn").onclick = loadData;
document.getElementById("toggleBtn").onclick = () => document.getElementById("listPanel").classList.toggle("hidden");

loadData();
</script>
</body>
</html>