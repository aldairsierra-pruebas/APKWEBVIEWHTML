<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visitas Naturgy</title>
  <!-- ... (tu código CSS y scripts iniciales sin cambios) ... -->
</head>
<body>
  <div id="map">
    <button id="locateBtn">📍</button>
    <button id="refreshBtn">🔄</button>
    <button id="toggleBtn">📋</button>
  </div>

  <div id="listPanel">
    <div id="legend"></div>
    <table>
      <thead><tr><th>Póliza</th><th>Nombre</th><th>Dirección</th></tr></thead>
      <tbody id="dataTableBody"></tbody>
    </table>
  </div>

<script>
  // --- Tu código original completo hasta renderAll() sin tocarlo ---

  function renderAll() {
    const tbody = document.getElementById('dataTableBody');
    tbody.innerHTML = '';
    markers.forEach(m => map.removeLayer(m)); markers = [];

    const list = currentData.filter(r => !filteredStreet || (r["calle"]||'Sin calle') === filteredStreet);

    list.forEach((row, i) => {
      const street = row["calle"] || 'Sin calle';
      const color = ensureColor(street);
      const icon = createIcon(i+1, color);
      const lat = parseFloat(row.lat), lng = parseFloat(row.lng);

      const marker = L.marker([lat, lng], { icon }).addTo(map);

      // --- Popup con botón de voz ---
      const popupHtml = `
        <div style="font-family:Arial,Helvetica,sans-serif;line-height:1.25; position: relative; font-size:15px;">
          <strong>Póliza:</strong> ${escapeHtml(row["Póliza"]||'')}<br/>
          <strong>Nombre:</strong> ${escapeHtml(row["Nombre Contratante"]||'')}<br/>
          <strong>Colonia:</strong> ${escapeHtml(row["Colonia"]||'')}<br/>
          <strong>Dirección:</strong> ${escapeHtml(row["calle"]||'')} ${escapeHtml(row["Número finca"]||'')}<br/>
          <strong>Inspector:</strong> ${escapeHtml(row["Inspector"]||'')}<br/>
          <strong>Estatus:</strong> ${escapeHtml(row["Estatus"]||'')}<br/>
          
          <div style="margin-top:10px; display:flex; gap:6px; flex-wrap:wrap;">
            <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank"
               style="background:#007bff;color:#fff;padding:6px 10px;border-radius:8px;text-decoration:none;">🚗 Google</a>
            <a href="https://waze.com/ul?ll=${lat},${lng}&navigate=yes" target="_blank"
               style="background:#ff6600;color:#fff;padding:6px 10px;border-radius:8px;text-decoration:none;">🧭 Waze</a>
            <button class="voice-btn" title="Reproducir voz"
              style="background:#28a745;color:#fff;padding:6px 10px;border:none;border-radius:8px;font-size:18px;cursor:pointer;">
              🔈
            </button>
          </div>

          <button class="popup-next-btn" style="
            position:absolute; bottom:6px; right:6px; padding:4px 8px;
            font-size:12px; background:#28a745; color:#fff; border:none; border-radius:4px; cursor:pointer;">
            Next
          </button>
        </div>`;

      marker.bindPopup(popupHtml);
      markers.push(marker);

      const tr = document.createElement('tr');
      tr.style.background = color + '22';
      tr.innerHTML = `
        <td>${escapeHtml(row["Póliza"]||'')}</td>
        <td>${escapeHtml(row["Nombre Contratante"]||'')}</td>
        <td>${escapeHtml((row["calle"]||'') + ' ' + (row["Número finca"]||''))}</td>`;
      tr.addEventListener('click', () => { marker.openPopup(); map.setView([lat, lng], 17); });
      tbody.appendChild(tr);
    });
  }

  // --- Control de voz ---
  function speakTextSequentially(texts, btn) {
    if (!window.speechSynthesis) return alert("Tu navegador no soporta síntesis de voz.");
    window.speechSynthesis.cancel();

    btn.textContent = "🔊";
    btn.style.background = "#dc3545";

    const speak = (txt, delay) => new Promise(res => {
      const utter = new SpeechSynthesisUtterance(txt);
      utter.lang = "es-ES";
      utter.rate = 0.9;
      utter.onend = () => setTimeout(res, delay);
      speechSynthesis.speak(utter);
    });

    (async () => {
      for (let t of texts) await speak(t, 2000); // 2 segundos de pausa
      btn.textContent = "🔈";
      btn.style.background = "#28a745";
    })();
  }

  // --- Detectar botones dentro del popup ---
  map.on('popupopen', e => {
    const popupEl = e.popup.getElement();
    const nextBtn = popupEl.querySelector('.popup-next-btn');
    const voiceBtn = popupEl.querySelector('.voice-btn');

    const markerData = currentData.find(r =>
      r["lat"] == e.popup._source.getLatLng().lat &&
      r["lng"] == e.popup._source.getLatLng().lng
    );

    // Next
    if (nextBtn) {
      nextBtn.onclick = () => {
        const visibles = markers.filter(m => map.hasLayer(m));
        if (visibles.length === 0) return;
        let idx = visibles.findIndex(m => m === e.popup._source);
        idx = (idx + 1) % visibles.length;
        const nextMarker = visibles[idx];
        map.setView(nextMarker.getLatLng(), 17);
        nextMarker.openPopup();
      };
    }

    // Voice
    if (voiceBtn && markerData) {
      voiceBtn.onclick = () => {
        const poliza = markerData["Póliza"] ? `Póliza ${markerData["Póliza"]}` : "";
        const nombre = markerData["Nombre Contratante"] ? `${markerData["Nombre Contratante"]}` : "";
        speakTextSequentially([poliza, nombre], voiceBtn);
      };
    }
  });

  // --- Resto de tu código sin cambios ---
  document.getElementById('refreshBtn').addEventListener('click', loadData);
  document.getElementById('toggleBtn').addEventListener('click', ()=>document.getElementById('listPanel').classList.toggle('hidden'));
  document.getElementById('locateBtn').addEventListener('click', () => {
    if (!navigator.geolocation) return alert('Geolocalización no soportada');
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat = pos.coords.latitude, lng = pos.coords.longitude;
      map.setView([lat,lng],15);
      if (userMarker) map.removeLayer(userMarker);
      userMarker = L.marker([lat,lng]).addTo(map).bindPopup('📍 Estás aquí').openPopup();
    }, ()=>alert('No se pudo obtener la ubicación.'));
  });

  loadData();
</script>
</body>
</html>