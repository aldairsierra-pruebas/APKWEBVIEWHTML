<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa de Visitas Naturgy</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    #map { height: 100vh; width: 100%; }
    .done-btn { margin-top:5px; padding:5px 10px; background:#28a745; color:white; cursor:pointer; border:none; border-radius:3px; }
  </style>
</head>
<body>
  <h2>Mapa de Visitas</h2>
  <div id="map"></div>

  <script>
    const apiURL = "https://script.google.com/macros/s/XXXXXXXXXXXX/exec"; // URL Apps Script

    const map = L.map('map').setView([25.6866, -100.3161], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    fetch(apiURL)
      .then(res => res.json())
      .then(data => {
        data.forEach(item => {
          const lat = parseFloat(item.lat);
          const lng = parseFloat(item.lng);
          if (!isNaN(lat) && !isNaN(lng)) {
            const marker = L.marker([lat, lng]).addTo(map);
            const popupContent = `
              <b>Calle:</b> ${item.calle} ${item["NÃºmero finca"]} <br>
              <b>Colonia:</b> ${item.Colonia} <br>
              <b>Inspector:</b> ${item.Inspector} <br>
              <b>Estatus:</b> ${item.Estatus} <br>
              <button class="done-btn" onclick="marcarRealizado('${item.PÃ³liza}', this)">Marcar como realizado</button>
            `;
            marker.bindPopup(popupContent);
          }
        });
      });

    function marcarRealizado(poliza, btn) {
      fetch(apiURL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `poliza=${poliza}&estatus=ðŸŸ¢`
      })
      .then(res => res.json())
      .then(data => {
        if(data.success){
          alert("Marcado como realizado");
          btn.disabled = true;
          btn.innerText = "âœ” Realizado";
        }
      });
    }
  </script>
</body>
</html>
