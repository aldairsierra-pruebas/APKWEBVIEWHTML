f
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ODIS Incidencias - Formulario Completo (P2 Visible)</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: Arial, Helvetica, sans-serif;
            font-size: 13px;
            /* üëà Letra m√°s peque√±a general */
        }

        body {
            margin: 0;
            background: #f2f4f7;
            padding: 16px;
        }

        h1 {
            font-size: 18px
        }

        h2 {
            font-size: 16px;
            margin: 10px 0;
            color: #0b3356
        }

        h3 {
            font-size: 14px;
            margin: 8px 0;
            color: #0b3356
        }

        label {
            font-size: 12.5px;
            margin-top: 6px;
            display: block;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 6px;
            margin-top: 3px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 12.5px;
        }

        textarea {
            resize: vertical
        }

        .section {
            background: #fff;
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 14px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, .06);

            /* üëá AQU√ç ESTA LA MAGIA */
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
        }

        /* Hace que los t√≠tulos ocupen todo el ancho */
        .section h2,
        .section h3,
        .section p,
        .section .group-title,
        .section #p21Defectos,
        .section #p2Aparatos,
        .section #p4Contenedor {
            grid-column: 1 / -1;
        }

        .hidden {
            display: none
        }

        .btn {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12.5px;
        }

        .primary {
            background: #0b3356;
            color: #fff
        }

        .secondary {
            background: #ddd
        }

        .actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .defecto {
            border: 1px dashed #ccc;
            padding: 6px;
            border-radius: 6px;
            margin-top: 6px;
        }

        .muted {
            color: #777;
            font-size: 12px
        }

        .equipo {
            border: 1px solid #e6eef5;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .group-title {
            font-weight: 700;
            margin-top: 6px;
            font-size: 13px;
        }

        .small {
            font-size: 12px;
            color: #555
        }

        .eq-box {
            font-size: 12px
        }

        .eq-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 6px
        }

        .eq-header input {
            width: 60px
        }

        .co-box {
            margin-top: 4px
        }

        .selected-list {
            margin-top: 6px;
            font-size: 12px;
            color: #333
        }

        .selected-item {
            background: #eef3ff;
            padding: 2px 5px;
            border-radius: 4px;
            margin: 2px 0;
            display: inline-block;
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000
        }

        .modal {
            background: #fff;
            width: 90%;
            max-width: 500px;
            border-radius: 10px;
            padding: 14px;
            max-height: 80vh;
            overflow: auto
        }

        .modal h3 {
            margin-top: 0
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 10px
        }

        .modal label {
            display: block;
            margin: 4px 0;
            font-size: 12px
        }

        /* M√≥vil m√°s compacto */
        @media(max-width:600px) {
            body {
                padding: 8px
            }

            .section {
                grid-template-columns: 1fr
            }
        }

        /* P2.1 GRID INTERNO */
        .p21-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 8px;
        }

        .p21-grid .col {
            background: #f9fbff;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e6eef5;
        }

        .p21-grid label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            margin: 4px 0;
        }

        .p21-grid input[type="checkbox"] {
            width: 14px;
            height: 14px;
        }

        /* GRID INTERNO MODAL */
        .modal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            margin-top: 8px;
        }

        .modal-grid label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            background: #f4f6f9;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .modal-grid input[type="checkbox"] {
            width: 14px;
            height: 14px;
        }

        .p4-row {
            display: grid;
            grid-template-columns: 1fr 120px;
            gap: 8px;
            align-items: start;
            margin-top: 6px;
        }

        .p4-row textarea {
            width: 100%;
        }

        .precinto-input {
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 12px;
        }

        .section.collapsible h2,
        .section.collapsible h3 {
            cursor: pointer;
            position: relative;
        }

        .section.collapsible h2::after,
        .section.collapsible h3::after {
            content: "‚ñº";
            position: absolute;
            right: 0;
            font-size: 12px;
            transition: transform 0.2s ease;
        }

        .section.collapsed h2::after,
        .section.collapsed h3::after {
            transform: rotate(-90deg);
        }

        .section-content {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.2s ease;
        }

        .section.collapsed .section-content {
            max-height: 0;
            opacity: 0;
            pointer-events: none;
        }
    </style>

</head>

<body>
    <form id="formODIS">


        <div class="section collapsible">
            <h2>Datos del Cliente</h2>
            <div class="section">
                <label>P√≥liza</label><input type="number" name="poliza">
                <label>Nombre</label><input type="text" name="nombre">
                <label>Tel√©fono</label><input type="tel" name="telefono">
                <label>Celular</label><input type="tel" name="celular">
                <label>Fecha de nacimiento</label><input type="date" name="fechaNacimiento">
                <label>Correo electr√≥nico</label><input type="email" name="email">
                <h3>Fechas (autocomputadas)</h3>
                <label>Fecha de solicitud (autogenerada)</label>
                <input type="datetime-local" id="fechaSolicitud" name="fechaSolicitud" readonly>

                <label>Fecha requerida (solicitud + 7 d√≠as)</label>
                <input type="datetime-local" id="fechaRequerida" name="fechaRequerida" readonly>

                <label>Fecha de vencimiento (solicitud + 1 mes)</label>
                <input type="datetime-local" id="fechaVencimiento" name="fechaVencimiento" readonly>
            </div>

        </div>


        <h2>Datos del Medidor</h2>
        <label>Fecha y hora de inspecci√≥n</label><input type="datetime-local" name="fechaInspeccion">
        <label>Latitud / Longitud</label><input type="text" name="latlng">
        <div class="section collapsible">
            <h2>P1. Prueba de litraje inicial</h2>
            <div class="section">
                <label>Lectura inicial</label><input type="number" id="p1Ini">
                <label>Lectura final</label><input type="number" id="p1Fin">
                <label>Diferencia</label><input type="number" id="p1Diff" readonly>
            </div>
        </div>

        <div class="section collapsible">
            <h2>P2. Seguimiento de la IDA</h2>
            <div class="section">
                <p class="small">P2.1 Detecci√≥n de Defectos en IDA.

                <div id="p21Defectos" class="p21-grid">

                    <div class="col">
                        <div class="group-title">Defectos Cr√≠ticos / Precintado Total</div>

                        <label><input type="checkbox" class="p21-def" data-cat="crit" value="60B Exterior"> Fuga Visible (60B) Exterior</label>
                        <label><input type="checkbox" class="p21-def" data-cat="crit" value="60B Fuga oculta"> (60B) Fuga oculta</label>
                        <label><input type="checkbox" class="p21-def" data-cat="crit" value="60B Interior"> (60B) Interior</label>
                        <label><input type="checkbox" class="p21-def" data-cat="crit" value="63 Fuga en v√°lvula"> (63) Fuga en v√°lvula</label>
                        <label><input type="checkbox" class="p21-def" data-cat="crit" value="83 IDA fuera de norma"> (83) IDA fuera de norma</label>
                    </div>

                    <div class="col">
                        <div class="group-title">Defectos Secundarios / √Åreas de mejora</div>

                        <label><input type="checkbox" class="p21-def" data-cat="sec" value="1 Material fuera de norma"> (1) Material fuera de norma</label>
                        <label><input type="checkbox" class="p21-def" data-cat="sec" value="16 Salida sin tap√≥n"> (16) Salida sin tap√≥n</label>
                        <label><input type="checkbox" class="p21-def" data-cat="sec" value="3 IDA cercana a otros servicios"> (3) IDA cercana a otros servicios</label>
                        <label><input type="checkbox" class="p21-def" data-cat="sec" value="4 Falta de sujeci√≥n"> (4) Falta de sujeci√≥n</label>
                        <label><input type="checkbox" class="p21-def" data-cat="sec" value="5 Conexi√≥n de IDA da√±ada"> (5) Conexi√≥n de IDA da√±ada</label>
                        <label><input type="checkbox" class="p21-def" data-cat="sec" value="87 IDA no identificada"> (87) IDA no identificada</label>
                    </div>

                </div>
            </div>
            <div class="section collapsible" id="p2Aparatos" style="margin-top:12px">
                <h3>P2.2 Detecci√≥n de defectos en aparatos conectados</h3>
                <div class="section">
                    <table class="three-col" id="tablaEquipos"></table>
                </div>
            </div>

        </div>

        <div class="section collapsible">
            <h2>P4. Descripci√≥n de verificaci√≥n</h2>
            <div id="p4Contenedor" class="muted">Seleccione defectos en P2 para generar esta secci√≥n.</div>
            <div class="section">
                <label>Observaciones globales</label>
                <textarea id="observacionesGlobal" name="observacionesGlobal" rows="3" maxlength="2000"></textarea>

                <label id="precintoLabel" class="hidden">Precinto (solo si hay cr√≠tico)</label>
                <input type="text" id="precinto" name="precinto" maxlength="50" class="hidden">
            </div>
        </div>
        <div>
            <div class="section collapsible">
                <h2>Datos Extras</h2>

                <label>¬øCliente realiza aviso al CCAU?</label>
                <select id="clienteAvisoCcau" name="clienteAvisoCcau">
                    <label><input type="checkbox" name="ClienteAvisoCcau" value="si">Si</label>
                    <label><input type="checkbox" name="ClienteAvisoCcau" value="no">No</label>
                    <option value="si">SI</option>
                    <option value="no">No</option>

                    <label id="numAvisoLabel" class="hidden">N√∫mero de aviso al CCAU</label>
                    <input type="text" id="numAvisoCcau" name="numAvisoCcau" maxlength="15" class="hidden" placeholder="M√°x 15 chars">

                    <h2>Tipo de revisi√≥n</h2>
                    <label><input type="checkbox" name="tipoRevision" value="Asistencia Gas"> Asistencia Gas</label>
                    <label><input type="checkbox" name="tipoRevision" value="Asistencia Hogar"> Asistencia Hogar</label>
                    <label><input type="checkbox" name="tipoRevision" value="Asistencia Hogar Plus"> Asistencia Hogar Plus</label>
                    <label><input type="checkbox" name="tipoRevision" value="Servigas Natural"> Servigas Natural</label>
                    <div>
                        <!-- E. Datos t√©cnico fijos -->
                        <div class="section">
                            <h2>T√©cnico</h2>
                            <label>Nombre del t√©cnico</label><input type="text" id="nombreTecnico" name="nombreTecnico" value="Aldair Isaac Sierra Loa">
                            <label>Empresa colaboradora</label><input type="text" id="empresaTecnico" name="empresaTecnico" value="Oca Global">
                            <label>N√∫mero de t√©cnico</label><input type="text" id="numTecnico" name="numTecnico" value="7236">
                            <label>Hora de salida (solicitud + 30 min)</label><input type="datetime-local" id="horaSalida" name="horaSalida" readonly>
                        </div>

                        <div class="section actions">
                            <button type="button" class="btn secondary" id="btnCancel">Cancelar</button>
                            <button type="submit" class="btn primary">Guardar</button>
                        </div>

    </form>

    <!-- MODAL P2.2 -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <h3>Seleccionar defectos</h3>
            <div id="modalDefectos" class="modal-grid"></div>
            <div class="modal-actions">
                <button type="button" class="btn secondary" onclick="cerrarModal()">Cancelar</button>
                <button type="button" class="btn primary" onclick="guardarDefectos()">Guardar</button>
            </div>
        </div>
    </div>


    <script type="module">
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import {
            getFirestore,
            collection,
            addDoc
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBLqVCqW2s7piZQUH0dHODjK4JXAv74TdA",
            authDomain: "asl-apk.firebaseapp.com",
            projectId: "asl-apk",
            storageBucket: "asl-apk.firebasestorage.app",
            messagingSenderId: "803053462437",
            appId: "1:803053462437:web:b2f4ccb8cd63c489c77e4c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        console.log("üî• Firebase conectado (module) üî•");

        // ---------- Helpers ----------
        const trimOrNull = v => (v === undefined || v === null) ? null : (String(v).trim() === "" ? null : String(v).trim());

        function gatherFormFields(form) {
            // Recopila todos los campos del form por name. Maneja grupos de checkboxes, radios y selects.
            const out = {};
            const names = new Set(Array.from(form.elements).map(el => el.name).filter(n => n));

            names.forEach(name => {
                const els = Array.from(form.querySelectorAll(`[name="${name}"]`));
                if (els.length === 0) return;

                const first = els[0];

                if (first.type === "checkbox") {
                    // Si hay m√∫ltiples checkboxes con el mismo name -> array de valores marcados (o null).
                    if (els.length > 1) {
                        const checked = els.filter(e => e.checked).map(e => trimOrNull(e.value)).filter(Boolean);
                        out[name] = checked.length ? checked : null;
                    } else {
                        // checkbox √∫nico -> valor si est√° marcado, si no null
                        out[name] = first.checked ? (trimOrNull(first.value) ?? true) : null;
                    }
                } else if (first.type === "radio") {
                    const checked = els.find(e => e.checked);
                    out[name] = checked ? trimOrNull(checked.value) : null;
                } else if (first.tagName.toLowerCase() === "select" && first.multiple) {
                    const vals = Array.from(first.selectedOptions).map(o => trimOrNull(o.value)).filter(Boolean);
                    out[name] = vals.length ? vals : null;
                } else {
                    out[name] = trimOrNull(first.value);
                }
            });

            return out;
        }

        function getP21DefectosFromDOM() {
            const criticos = [];
            const secundarios = [];
            document.querySelectorAll('.p21-def').forEach(cb => {
                if (!cb.checked) return;
                const v = trimOrNull(cb.value);
                if (!v) return;
                if (cb.dataset.cat === "crit") criticos.push(v);
                else if (cb.dataset.cat === "sec") secundarios.push(v);
            });
            return {
                criticos: criticos.length ? criticos : null,
                secundarios: secundarios.length ? secundarios : null
            };
        }

        function getEquiposDataFromDOM() {
            const data = {};
            document.querySelectorAll('.qty').forEach(inp => {
                const eq = inp.dataset.eq;
                const cantidad = Number(inp.value || 0);
                if (cantidad <= 0) return;

                // CO ppm dentro de #co_{eq} input (si existe)
                const coContainer = document.querySelector(`#co_${eq}`);
                const coInput = coContainer ? coContainer.querySelector('input') : null;
                const co_ppm = coInput && coInput.value ? Number(coInput.value) : null;

                // Defectos: .selected-list #list_{eq} .selected-item
                const listEl = document.getElementById(`list_${eq}`);
                const defects = listEl ? Array.from(listEl.querySelectorAll('.selected-item')).map(s => trimOrNull(s.textContent)).filter(Boolean) : null;

                data[eq] = {
                    cantidad,
                    co_ppm: co_ppm ?? null,
                    defectos: defects && defects.length ? defects : null
                };
            });

            return Object.keys(data).length ? data : null;
        }

        function getP4GeneratedFromDOM() {
            const out = [];
            // Cada fila .p4-row generada contiene un textarea y, posiblemente, un input.precinto-input
            p4Cont = document.getElementById('p4Contenedor');
            if (!p4Cont) return null;

            const filas = p4Cont.querySelectorAll('.p4-row');
            filas.forEach(f => {
                const ta = f.querySelector('textarea');
                const prec = f.querySelector('.precinto-input');
                const desc = ta ? trimOrNull(ta.value) : null;
                const precVal = prec ? trimOrNull(prec.value) : null;
                if (desc || precVal) {
                    out.push({
                        descripcion: desc,
                        precinto: precVal
                    });
                }
            });

            return out.length ? out : null;
        }

        // ---------- Submit handler ----------
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('formODIS');
            if (!form) return;

            form.addEventListener('submit', async (ev) => {
                ev.preventDefault();

                // 1) Campos planos del formulario
                const flat = gatherFormFields(form);

                // 2) Datos espec√≠ficos construidos desde DOM (no dependen de nombres)
                const p21 = getP21DefectosFromDOM();
                const equipos = getEquiposDataFromDOM();
                const p4Generado = getP4GeneratedFromDOM();

                // 3) Valores calculados / utiles (fechas autogeneradas y calculos p1)
                const computed = {
                    fechaSolicitud: trimOrNull(document.getElementById('fechaSolicitud')?.value) ?? null,
                    fechaRequerida: trimOrNull(document.getElementById('fechaRequerida')?.value) ?? null,
                    fechaVencimiento: trimOrNull(document.getElementById('fechaVencimiento')?.value) ?? null,
                    horaSalida: trimOrNull(document.getElementById('horaSalida')?.value) ?? null,
                    lecturaInicial: trimOrNull(document.getElementById('p1Ini')?.value) ?? null,
                    lecturaFinal: trimOrNull(document.getElementById('p1Fin')?.value) ?? null,
                    diferencia: trimOrNull(document.getElementById('p1Diff')?.value) ?? null
                };

                // 4) Estructura final: incluimos tanto el mapa plano (flat) como estructuras por seccion
                const registro = {
                    createdAt: new Date().toISOString(),

                    // Guardamos el "flat" para que aparezcan exactamente los names del form
                    formFields: flat,

                    // Estructura organizada por secciones (√∫til para consultas)
                    cliente: {
                        poliza: flat.poliza ?? null,
                        nombre: flat.nombre ?? null,
                        telefono: flat.telefono ?? null,
                        celular: flat.celular ?? null,
                        fechaNacimiento: flat.fechaNacimiento ?? null,
                        email: flat.email ?? null
                    },

                    fechas: {
                        solicitud: computed.fechaSolicitud,
                        requerida: computed.fechaRequerida,
                        vencimiento: computed.fechaVencimiento
                    },

                    inspeccion: {
                        fechaInspeccion: flat.fechaInspeccion ?? null,
                        latlng: flat.latlng ?? null,
                        lecturaInicial: computed.lecturaInicial,
                        lecturaFinal: computed.lecturaFinal,
                        diferencia: computed.diferencia
                    },

                    p2: {
                        ida: p21,
                        aparatos: equipos
                    },

                    p4: {
                        observacionesGlobal: flat.observacionesGlobal ?? null,
                        precintoGlobal: flat.precinto ?? null,
                        generados: p4Generado
                    },

                    cca: {
                        clienteAviso: flat.clienteAvisoCcau ?? flat.ClienteAvisoCcau ?? null,
                        numeroAviso: flat.numAvisoCcau ?? null
                    },

                    tipoRevision: flat.tipoRevision ?? null,

                    tecnico: {
                        nombre: flat.nombreTecnico ?? null,
                        empresa: flat.empresaTecnico ?? null,
                        numero: flat.numTecnico ?? null,
                        horaSalida: computed.horaSalida
                    }
                };

                try {
                    await addDoc(collection(db, "Inspecciones"), registro);
                    alert("‚úÖ Inspecci√≥n guardada correctamente en la colecci√≥n Inspecciones.");
                    form.reset();
                    // recalcula las fechas autogeneradas y UI si es necesario
                    if (typeof calcularFechasIniciales === "function") calcularFechasIniciales();
                    // limpia listas din√°micas (puedes recargar si prefieres)
                    location.reload();
                } catch (err) {
                    console.error("Error guardando inspecci√≥n:", err);
                    alert("‚ùå Error al guardar la inspecci√≥n (revisa consola).");
                }
            });
        });
    </script>



    <script>
        /* P1 diferencia */
        const ini = document.getElementById('p1Ini');
        const fin = document.getElementById('p1Fin');
        const diff = document.getElementById('p1Diff');

        function calc() {
            diff.value = (Number(fin.value || 0) - Number(ini.value || 0));
        }
        ini.addEventListener('input', calc);
        fin.addEventListener('input', calc);

        /* Equipo y defectos (lista exacta) */
        const P2_CRITICOS = [{
                code: '60B_ext',
                label: '(60B) Exterior'
            },
            {
                code: '60B_oculta',
                label: '(60B) Fuga oculta'
            },
            {
                code: '60B_int',
                label: '(60B) Interior'
            },
            {
                code: '63_valvula',
                label: '(63) Fuga en v√°lvula'
            },
            {
                code: '83_fuera_norma',
                label: '(83) IDA fuera de norma'
            }
        ];
        const P2_SECUNDARIOS = [{
                code: '1_material',
                label: '(1) Material fuera de norma'
            },
            {
                code: '16_sin_tapon',
                label: '(16) Salida sin tap√≥n'
            },
            {
                code: '3_cercano',
                label: '(3) IDA cercana a otros servicios'
            },
            {
                code: '4_falta_sujecion',
                label: '(4) Falta de sujeci√≥n'
            },
            {
                code: '5_conexion_danada',
                label: '(5) Conexi√≥n de IDA da√±ada'
            },
            {
                code: '87_no_identificada',
                label: '(87) IDA no identificada'
            }
        ];

        const EQUIPOS_ORDER = [{
                id: 'CA',
                name: 'CA - Calentador de Acumulaci√≥n'
            },
            {
                id: 'CP',
                name: 'CP - Calentador de Paso'
            },
            {
                id: 'ES',
                name: 'ES - Estufa'
            },
            {
                id: 'HO',
                name: 'HO - Horno'
            },
            {
                id: 'SE',
                name: 'SE - Secador'
            },
            {
                id: 'CL',
                name: 'CL - Calentador'
            },
            {
                id: 'VS',
                name: 'VS - V√°lvula Sin Aparato'
            }
        ];

        const DEFECTOS_APARATO = [
            '(10) Dificultad de cierre',
            '(13) Zona de ventilaci√≥n permanente',
            '(14) Material fuera de norma aparato',
            '(17) Aparato fijo sin conexi√≥n fija',
            '(61) Fuga en manguera interior',
            '(62) Fuga en aparato',
            '(63) Fuga en v√°lvula',
            '(64) Manguera da√±ada interior',
            '(65) Sin ventilaci√≥n permanente primer piso',
            '(66) Sin conducto de evacuaci√≥n de gases',
            '(67) Fuga en manguera exterior',
            '(68) Manguera da√±ada exterior',
            '(80) Mon√≥xido de carbono (CO) ppm',
            '(85) Sin ventilaci√≥n permanente por debajo del primer s√≥tano',
            '(86) Elemento de cierre'
        ];

        const p4Cont = document.getElementById('p4Contenedor');
        const tablaEquipos = document.getElementById('tablaEquipos');
        const modal = document.getElementById('modalOverlay');
        const modalDefectos = document.getElementById('modalDefectos');
        const defectosPorEquipo = {};
        let equipoActivo = null;

        function renderEquipos() {
            let row;
            EQUIPOS_ORDER.forEach((eq, i) => {
                if (i % 3 === 0) row = tablaEquipos.insertRow();
                const cell = row.insertCell();
                cell.className = 'eq-box';
                cell.innerHTML = `
      <div class="eq-header">
        <strong>${eq.name}</strong>
        <input type="number" min="0" value="0" data-eq="${eq.id}" class="qty">
      </div>
      <div id="co_${eq.id}" class="co-box hidden">
        <input type="number" min="0" placeholder="CO ppm">
      </div>
      <button type="button" class="btn secondary hidden" id="btn_${eq.id}" onclick="abrirModal('${eq.id}')">Defectos</button>
      <div class="selected-list" id="list_${eq.id}"></div>
    `;
            });
        }

        document.addEventListener('input', e => {
            if (e.target.classList.contains('qty')) {
                const eq = e.target.dataset.eq;
                const qty = Number(e.target.value || 0);
                const coBox = document.getElementById('co_' + eq);
                const btn = document.getElementById('btn_' + eq);
                const list = document.getElementById('list_' + eq);

                if (qty > 0) {
                    coBox.classList.remove('hidden');
                    btn.classList.remove('hidden');
                } else {
                    coBox.classList.add('hidden');
                    btn.classList.add('hidden');
                    list.innerHTML = '';
                    defectosPorEquipo[eq] = [];
                    syncP4();
                }
            }
        });

        function abrirModal(eq) {
            equipoActivo = eq;
            const current = defectosPorEquipo[eq] || [];
            modal.style.display = 'flex';
            modalDefectos.innerHTML = DEFECTOS_APARATO.map(d => {
                const checked = current.includes(d) ? 'checked' : '';
                return `<label><input type="checkbox" value="${d}" ${checked}> ${d}</label>`;
            }).join('');
        }

        function cerrarModal() {
            modal.style.display = 'none';
        }

        function guardarDefectos() {
            if (!equipoActivo) return;
            const checks = Array.from(modalDefectos.querySelectorAll('input:checked'));
            const selected = checks.map(c => c.value);
            defectosPorEquipo[equipoActivo] = selected;
            const list = document.getElementById('list_' + equipoActivo);
            list.innerHTML = selected.map(item => `<span class="selected-item">${item}</span>`).join('');
            cerrarModal();
            syncP4();
        }

        window.abrirModal = abrirModal;
        window.cerrarModal = cerrarModal;
        window.guardarDefectos = guardarDefectos;

        // Delegate change on defect checkboxes
        document.addEventListener('change', e => {
            if (e.target && e.target.classList && e.target.classList.contains('def-checkbox')) {
                syncP4();
            }
        });

        // Sync to P4 (pre-filled descriptions)
        function esDefectoCriticoAparato(texto) {
            const criticos = ['(61)', '(62)', '(63)', '(67)', '(80)'];
            return criticos.some(c => texto.includes(c));
        }

        function syncP4() {
            p4Cont.innerHTML = '';

            const p21Checked = Array.from(document.querySelectorAll('.p21-def'))
                .filter(i => i.checked);

            const equiposConDefectos = Object.entries(defectosPorEquipo)
                .filter(([, defects]) => defects.length > 0);

            if (p21Checked.length === 0 && equiposConDefectos.length === 0) {
                p4Cont.innerHTML = '<span class="muted">Sin defectos seleccionados.</span>';
                return;
            }

            /* ================= IDA ================= */
            if (p21Checked.length > 0) {
                const box = document.createElement('div');
                box.className = 'defecto';
                box.innerHTML = `<strong>IDA</strong>`;
                p4Cont.appendChild(box);

                p21Checked.forEach(d => {
                    const esCritico = d.dataset.cat === 'crit';
                    const row = document.createElement('div');
                    row.className = 'p4-row';

                    const descripcion = `
        <div>
          <em>${d.parentNode.textContent.trim()}</em>
          <textarea rows="2">
Se detecta ${d.parentNode.textContent.trim().toLowerCase()}. Proceder seg√∫n normativa.
          </textarea>
        </div>
      `;

                    const precinto = esCritico ?
                        `<input type="text" class="precinto-input" placeholder="Precinto">` :
                        `<div></div>`;

                    row.innerHTML = descripcion + precinto;
                    box.appendChild(row);
                });
            }

            /* ================= APARATOS ================= */
            equiposConDefectos.forEach(([eq, defects]) => {

                const eqName = (EQUIPOS_ORDER.find(x => x.id === eq) || {}).name || eq;

                const box = document.createElement('div');
                box.className = 'defecto';
                box.innerHTML = `<strong>${eqName}</strong>`;
                p4Cont.appendChild(box);

                defects.forEach(defecto => {

                    const esCritico = esDefectoCriticoAparato(defecto);

                    const row = document.createElement('div');
                    row.className = 'p4-row';

                    const descripcion = `
        <div>
          <em>${defecto}</em>
          <textarea rows="2">
Se detecta ${defecto.toLowerCase()} en ${eqName.toLowerCase()}. Proceder seg√∫n normativa.
          </textarea>
        </div>
      `;

                    const precinto = esCritico ?
                        `<input type="text" class="precinto-input" placeholder="Precinto">` :
                        `<div></div>`;

                    row.innerHTML = descripcion + precinto;
                    box.appendChild(row);
                });
            });
        }


        renderEquipos();

        // üëá AQUI
        document.querySelectorAll('.p21-def').forEach(cb => {
            cb.addEventListener('change', syncP4);
        });
        // Cancel
        document.getElementById('btnCancel').addEventListener('click', () => {
            if (confirm('Limpiar formulario?')) location.reload();
        });

        /* ============================
           4Ô∏è‚É£ Mostrar / ocultar campos
        ============================ */

        // Mostrar n√∫mero de aviso si responde SI
        document.getElementById('clienteAvisoCcau').addEventListener('change', function(e) {
            const esSi = e.target.value === 'si';
            document.getElementById('numAvisoCcau').classList.toggle('hidden', !esSi);
            document.getElementById('numAvisoLabel').classList.toggle('hidden', !esSi);
        });

        // Mostrar campo precinto SOLO si hay defecto cr√≠tico
        function updatePrecintoVisibility() {
            const hayCritico = Array.from(document.querySelectorAll('.p21-def[data-cat="crit"]'))
                .some(cb => cb.checked);

            document.getElementById('precinto').classList.toggle('hidden', !hayCritico);
            document.getElementById('precintoLabel').classList.toggle('hidden', !hayCritico);
        }

        // Escuchar cambios en defectos cr√≠ticos
        document.querySelectorAll('.p21-def[data-cat="crit"]')
            .forEach(cb => cb.addEventListener('change', updatePrecintoVisibility));

        updatePrecintoVisibility();


        /* ============================
           5Ô∏è‚É£ C√°lculo autom√°tico fechas
        ============================ */

        function toLocalInputFormat(date) {
            const pad = n => String(n).padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }

        function calcularFechasIniciales() {

            const ahora = new Date();

            const requerida = new Date(ahora);
            requerida.setDate(requerida.getDate() + 7);

            const vencimiento = new Date(ahora);
            vencimiento.setMonth(vencimiento.getMonth() + 1);

            const salida = new Date(ahora);
            salida.setMinutes(salida.getMinutes() + 30);

            document.getElementById('fechaSolicitud').value = toLocalInputFormat(ahora);
            document.getElementById('fechaRequerida').value = toLocalInputFormat(requerida);
            document.getElementById('fechaVencimiento').value = toLocalInputFormat(vencimiento);
            document.getElementById('horaSalida').value = toLocalInputFormat(salida);
        }

        calcularFechasIniciales();
        /* ============================
   AUTOLLENADO DESDE MAPA
============================ */

        function autocompletarDesdeURL() {

            const params = new URLSearchParams(window.location.search);

            const poliza = params.get("poliza");
            const nombre = params.get("nombre");
            const lat = params.get("lat");
            const lng = params.get("lng");

            if (poliza) {
                const el = document.querySelector('[name="poliza"]');
                if (el) {
                    el.value = poliza;
                    el.readOnly = true;
                    el.tabIndex = -1;
                }
            }

            if (nombre) {
                const el = document.querySelector('[name="nombre"]');
                if (el) {
                    el.value = nombre;
                    el.readOnly = true;
                    el.tabIndex = -1;
                }
            }

            if (lat && lng) {
                const el = document.querySelector('[name="latlng"]');
                if (el) {
                    el.value = `${lat}, ${lng}`;
                    el.readOnly = true;
                    el.tabIndex = -1;
                }
            }
        }

        autocompletarDesdeURL();
        document.querySelectorAll('.section.collapsible').forEach(section => {

            const header = section.querySelector('h2, h3');
            const content = section.querySelector('.section-content');

            if (!header || !content) return;

            content.style.maxHeight = content.scrollHeight + "px";

            header.addEventListener('click', () => {

                section.classList.toggle('collapsed');

                if (section.classList.contains('collapsed')) {
                    content.style.maxHeight = "0px";
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                }

            });

        });
    </script>
</body>

</html>
