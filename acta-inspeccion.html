<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Formulario CCRAP (Control De Calidad Revision Anual Preventiva)</title>
    <link rel="icon" type="image/x-icon" href="favicon_visitas_inspeccion.ico">
    <style>
        * {
            box-sizing: border-box;
            font-family: Arial, Helvetica, sans-serif;
            font-size: 13px
        }

        body {
            margin: 0;
            background: #f2f4f7;
            padding: 16px
        }

        h1 {
            font-size: 18px
        }

        h2 {
            font-size: 16px;
            margin: 10px 0;
            color: #0b3356
        }

        h3 {
            font-size: 14px;
            margin: 8px 0;
            color: #0b3356
        }

        label {
            font-size: 12.5px;
            margin-top: 6px;
            display: block
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 6px;
            margin-top: 3px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 12.5px
        }

        textarea {
            resize: vertical
        }

        .section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
        }

        .section {
            background: #fff;
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 14px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, .06);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px
        }

        .section h2,
        .section h3,
        .section p,
        .section .group-title,
        .section #p21Defectos,
        .section #p2Aparatos,
        .section #p4Contenedor {
            grid-column: 1/-1
        }

        .hidden {
            display: none !important
        }

        /* BOTONES */
        .btn {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12.5px
        }

        .primary {
            background: #0b3356;
            color: #fff
        }

        .secondary {
            background: #ddd
        }

        .actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px
        }

        .btn-icon {
            width: 16px;
            height: 16px;
            object-fit: contain;
            vertical-align: middle;
            margin-right: 6px;
        }

        .btn.secondary.icon-only {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 6px 10px;
            font-size: 14px;
        }

        /* ELEMENTOS ESPECÍFICOS */
        .defecto {
            border: 1px dashed #ccc;
            padding: 6px;
            border-radius: 6px;
            margin-top: 6px;
            background: #fafafa;
        }

        .muted {
            color: #777;
            font-size: 12px
        }

        .equipo {
            border: 1px solid #e6eef5;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px
        }

        .group-title {
            font-weight: 700;
            margin-top: 6px;
            font-size: 13px
        }

        .small {
            font-size: 12px;
            color: #555
        }


        .check-columns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 8px;
        }

        .check-columns label,
        .binary-group label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            margin: 2px 0;
        }

        .check-columns input[type="checkbox"],
        .binary-group input[type="checkbox"] {
            width: 14px;
            height: 14px;
            margin-top: 0;
        }

        .binary-group {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 4px;
        }

        .calc-label {
            margin-top: 3px;
            min-height: 32px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: #f8fafc;
            display: flex;
            align-items: center;
            padding: 6px 8px;
            font-weight: 700;
            color: #0b3356;
        }

        /* ESTILOS DE EQUIPOS (P2.2) RESTAURADOS */
        .eq-box {
            font-size: 12px;
            border: 1px solid #e6eef5;
            border-radius: 8px;
            padding: 10px;
            background: #f9fbff;
        }

        .equipos-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
            width: 100%;
        }

        .eq-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 6px
        }

        .qty-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .qty-btn {
            width: 26px;
            height: 26px;
            padding: 0;
            border: 1px solid #b9c7d8;
            background: #fff;
            border-radius: 6px;
            font-size: 16px;
            line-height: 1;
            cursor: pointer;
        }

        .eq-header input {
            width: 52px;
            text-align: center;
            margin-top: 0;
        }

        .co-box {
            margin-top: 4px
        }

        .selected-list {
            margin-top: 6px;
            font-size: 12px;
            color: #333
        }

        .selected-item {
            background: #eef3ff;
            padding: 2px 5px;
            border-radius: 4px;
            margin: 2px 0;
            display: inline-block;
            border: 1px solid #dce6f7;
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000
        }

        .modal {
            background: #fff;
            width: 90%;
            max-width: 500px;
            border-radius: 10px;
            padding: 14px;
            max-height: 80vh;
            overflow: auto
        }

        .modal h3 {
            margin-top: 0
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 10px
        }

        .modal label {
            display: block;
            margin: 4px 0;
            font-size: 12px
        }

        /* RESPONSIVE */
        @media(max-width:600px) {
            body {
                padding: 8px
            }

            .section {
                grid-template-columns: 1fr
            }

            .equipos-grid {
                grid-template-columns: 1fr;
            }
        }

        /* GRID P2.1 */
        .p21-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 8px
        }

        .p21-grid .col {
            background: #f9fbff;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e6eef5
        }

        .p21-grid label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            margin: 4px 0
        }

        .p21-grid input[type="checkbox"] {
            width: 14px;
            height: 14px
        }

        /* GRID MODAL */
        .modal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            margin-top: 8px
        }

        .modal-grid label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            background: #f4f6f9;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid #e2e8f0
        }

        .modal-grid input[type="checkbox"] {
            width: 14px;
            height: 14px
        }

        /* FILAS P4 (Generadas dinámicamente) */
        .p4-row {
            display: grid;
            grid-template-columns: 1fr 120px;
            gap: 8px;
            align-items: start;
            margin-top: 6px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            margin-bottom: 8px;
        }

        .p4-row:last-child {
            border-bottom: none;
        }

        .p4-row textarea {
            width: 100%;
            font-family: monospace;
            font-size: 11px;
        }

        .precinto-input {
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 12px
        }

        /* ACORDEÓN (Lógica Corregida de Cambios.txt) */
        .section.collapsible h2,
        .section.collapsible h3 {
            cursor: pointer;
            position: relative
        }

        .section.collapsible h2::after,
        .section.collapsible h3::after {
            content: "▼";
            position: absolute;
            right: 0;
            font-size: 12px;
            transition: transform .2s
        }

        .section.collapsed h2::after,
        .section.collapsed h3::after {
            transform: rotate(-90deg)
        }

        .section-content {
            grid-column: 1/-1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
            overflow: hidden;
            transition: max-height .3s ease, opacity .2s ease;
        }

        .section.collapsed .section-content {
            max-height: 0;
            opacity: 0;
            pointer-events: none
        }

        .cliente-grid {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        .cliente-grid .check-columns {
            grid-template-columns: repeat(4, minmax(0, max-content));
            justify-content: start;
            column-gap: 16px;
        }

        .cliente-grid .binary-group {
            gap: 12px;
        }

        .foto-medidor-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 6px;
        }

        .foto-medidor-lista {
            margin-top: 6px;
            padding-left: 16px;
            color: #4b5563;
            font-size: 12px;
        }

        @media(max-width:980px) {
            .cliente-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .cliente-grid .check-columns {
                grid-template-columns: repeat(2, minmax(0, max-content));
            }
        }
    </style>
</head>

<body>
    <form id="formODIS">

        <div class="section">
            <h2>Acta / Revisión Anual Preventiva</h2>
        </div>

        <div class="section collapsible">
            <h2>Datos del Cliente</h2>
            <div class="section-content cliente-grid">
                <div class="field"><label>Póliza</label><input type="text" maxlength="12" inputmode="numeric" name="poliza" required></div>
                <div class="field"><label>Nombre</label><input type="text" name="nombre" required></div>
                <div class="field"><label>Teléfono</label><input type="text" maxlength="10" inputmode="numeric" name="telefono"></div>
                <div class="field"><label>Celular</label><input type="text" maxlength="10" inputmode="numeric" name="celular"></div>
                <div class="field"><label>Fecha de nacimiento</label><input type="date" name="fechaNacimiento"></div>
                <div class="field"><label>Correo electrónico</label><input type="email" name="email"></div>

                <div class="field" style="grid-column:1/-1;">
                    <label>Identificación presentada</label>
                    <div class="check-columns" id="identificacionCliente">
                        <label><input type="checkbox" name="identificacionCliente" value="Cedula"> Cédula</label>
                        <label><input type="checkbox" name="identificacionCliente" value="Pasaporte"> Pasaporte</label>
                        <label><input type="checkbox" name="identificacionCliente" value="Licencia"> Licencia</label>
                        <label><input type="checkbox" name="identificacionCliente" value="Otro"> Otro</label>
                    </div>
                </div>

                <div class="field" style="grid-column:1/-1;">
                    <label>¿Es titular del servicio?</label>
                    <div class="binary-group" id="titularServicioGroup">
                        <label><input type="checkbox" name="titularServicio" value="si"> Sí</label>
                        <label><input type="checkbox" name="titularServicio" value="no"> No</label>
                    </div>
                </div>
                <div class="field hidden" id="fieldParentesco"><label>Parentesco</label><input type="text" id="parentesco" name="parentesco"></div>

                <h3>Fechas reg</h3>
                <div class="field"><label>Fecha de solicitud</label><input type="datetime-local" id="fechaSolicitud" name="fechaSolicitud" readonly></div>
                <div class="field"><label>Fecha requerida (+7 días)</label><input type="datetime-local" id="fechaRequerida" name="fechaRequerida" readonly></div>
                <div class="field"><label>Fecha de vencimiento (+1 mes)</label><input type="datetime-local" id="fechaVencimiento" name="fechaVencimiento" readonly></div>
            </div>
        </div>

        <div class="section collapsible" id="sectionMedidor">
            <h2>Datos del Medidor</h2>
            <div class="section-content">
                <div class="field"><label>Fecha y hora de inspección</label><input type="text" name="fechaInspeccion" id="fechaInspeccion" readonly></div>
                <div class="field"><label>Latitud / Longitud</label><input type="text" name="latlng" readonly></div>

                <div class="field">
                    <label>Presente tambor litraje</label>
                    <div class="binary-group" data-exclusive-group="tamborLitraje">
                        <label><input type="checkbox" name="tamborLitraje" value="si" required> Sí</label>
                        <label><input type="checkbox" name="tamborLitraje" value="no"> No</label>
                    </div>
                </div>

                <div class="field">
                    <label>Registro litraje</label>
                    <div class="binary-group" data-exclusive-group="registroLitraje">
                        <label><input type="checkbox" name="registroLitraje" value="si" required> Sí</label>
                        <label><input type="checkbox" name="registroLitraje" value="no"> No</label>
                    </div>
                </div>

                <div class="field">
                    <label>Nivel de accesibilidad</label>
                    <div class="binary-group" id="accesibilidadGroup">
                        <label><input type="checkbox" name="nivelAccesibilidad" value="G1" required> G1</label>
                        <label><input type="checkbox" name="nivelAccesibilidad" value="G2"> G2</label>
                        <label><input type="checkbox" name="nivelAccesibilidad" value="G3"> G3</label>
                    </div>
                </div>

                <div class="field">
                    <label>¿Se realiza prueba de litraje?</label>
                    <div class="binary-group" data-exclusive-group="pruebaLitraje" id="pruebaLitrajeGroup">
                        <label><input type="checkbox" name="pruebaLitraje" value="si" required> Sí</label>
                        <label><input type="checkbox" name="pruebaLitraje" value="no"> No</label>
                    </div>
                </div>

                <div class="field hidden" id="fieldLecturaActual">
                    <label>Lectura actual</label>
                    <input type="number" id="lecturaActual" name="lecturaActual" inputmode="numeric" max="99999999" oninput="if(this.value.length>8)this.value=this.value.slice(0,8)">
                </div>

                <div class="field" style="grid-column:1/-1;">
                    <label>Fotografías del medidor</label>
                    <div class="foto-medidor-actions">
                        <button type="button" class="btn secondary icon-only" id="btnTomarFotoMedidor"><img class="btn-icon" src="https://img.icons8.com/?size=100&id=11758&format=png&color=000000" alt="Tomar foto">Tomar foto</button>
                        <button type="button" class="btn secondary icon-only" id="btnSubirFotoMedidor"><img class="btn-icon" src="https://img.icons8.com/?size=100&id=GiNKOzxL3w6e&format=png&color=000000" alt="Subir fotografía">Subir fotografía</button>
                    </div>
                    <input type="file" id="fotosMedidorCamara" name="fotosMedidorCamara" accept="image/*" capture="environment" multiple class="hidden">
                    <input type="file" id="fotosMedidorArchivo" name="fotosMedidorArchivo" accept="image/*" multiple class="hidden">
                    <div class="small">Puede tomar o cargar hasta 5 fotos del medidor (JPG/PNG/WEBP).</div>
                    <ul class="foto-medidor-lista" id="fotosMedidorLista"></ul>
                </div>
            </div>
        </div>

        <div class="section collapsible" id="sectionP1">
            <h2>P1. Prueba de litraje inicial</h2>
            <div class="section-content">
                <div class="field"><label>Lectura inicial</label><input type="number" maxlength="8" id="p1Ini" max="99999999" oninput="if(this.value.length>8)this.value=this.value.slice(0,8)"></div>
                <div class="field"><label>Lectura final</label><input type="number" maxlength="8" id="p1Fin" min="0" max="99999999" oninput="if(this.value.length>8)this.value=this.value.slice(0,8)"></div>
                <div class="field">
                    <label>Diferencia</label>
                    <div class="calc-label" id="p1DiffLabel">0.00</div>
                    <input type="hidden" id="p1Diff" name="p1Diff" value="0">
                </div>
                <div class="field"><label>Duración (minutos)</label><input type="number" id="p1Duracion" min="1" step="1" inputmode="numeric"></div>
                <div class="field">
                    <label>Flujo (litros/hora)</label>
                    <div class="calc-label" id="p1FlujoLabel">0.00</div>
                    <input type="hidden" id="p1Flujo" name="p1Flujo" value="0">
                </div>
            </div>
        </div>

        <div class="section collapsible" id="sectionP2">
            <h2>P2. Seguimiento de la IDA (Instalación de Aprovechamiento)</h2>
            <div class="section-content">
                <p class="small">P2.1 Detección de Defectos en IDA. Seleccione directamente los defectos aplicables.</p>

                <div id="p21Defectos" class="p21-grid">
                    <div class="col">
                        <div class="group-title">Defectos Críticos / Precintado Total</div>
                        <div class="field"><label><input type="checkbox" class="p21-def" data-cat="crit" value="60B Exterior"> Fuga Visible (60B) Exterior</label></div>
                        <div class="field"><label><input type="checkbox" class="p21-def" data-cat="crit" value="60B Fuga oculta"> (60B) Fuga oculta</label></div>
                        <div class="field"><label><input type="checkbox" class="p21-def" data-cat="crit" value="60B Interior"> (60B) Interior</label></div>
                        <div class="field"><label><input type="checkbox" class="p21-def" data-cat="crit" value="63 Fuga en válvula"> (63) Fuga en válvula</label></div>
                        <div class="field"><label><input type="checkbox" class="p21-def" data-cat="crit" value="83 IDA fuera de norma"> (83) IDA fuera de norma</label></div>
                    </div>

                    <div class="col">
                        <div class="group-title">Defectos Secundarios / Áreas de mejora</div>
                        <div class="field"><label><input type="checkbox" class="p21-def" data-cat="sec" value="87 IDA no identificada"> (87) IDA no identificada</label></div>
                        <div class="field"><label><input type="checkbox" class="p21-def" data-cat="sec" value="1 Material fuera de norma"> (1) Material fuera de norma</label></div>
                        <div class="field"><label><input type="checkbox" class="p21-def" data-cat="sec" value="16 Salida sin tapón"> (16) Salida sin tapón</label></div>
                        <div class="field"><label><input type="checkbox" class="p21-def" data-cat="sec" value="3 IDA cercana a otros servicios"> (3) IDA cercana a otros servicios</label></div>
                        <div class="field"><label><input type="checkbox" class="p21-def" data-cat="sec" value="4 Falta de sujeción"> (4) Falta de sujeción</label></div>
                        <div class="field"><label><input type="checkbox" class="p21-def" data-cat="sec" value="5 Conexión de IDA dañada"> (5) Conexión de IDA dañada</label></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="section collapsible" id="sectionP22">
            <h2>P2.2 Detección de defectos en aparatos conectados</h2>
            <div class="section-content">
                <div id="p2Aparatos" class="equipos-grid"></div>
            </div>
        </div>

        <div class="section collapsible" id="sectionP4">
            <h2>P4. Descripción de verificación</h2>
            <div class="section-content">
                <div id="p4Contenedor" class="muted">Seleccione defectos en P2 para generar esta sección.</div>
                <hr>
                <div class="field"><label>Observaciones globales (Manual)</label><textarea id="observacionesGlobal" name="observacionesGlobal" rows="3" maxlength="500" required></textarea></div>
                <div class="field"><label id="precintoLabel" class="hidden">Precinto Global (solo si hay crítico)</label><input type="text" id="precinto" name="precinto" maxlength="50" class="hidden"></div>
            </div>
        </div>

        <div class="section collapsible hidden" id="sectionDatosExtras">
            <h2>CCAU</h2>
            <div class="section-content">
                <div class="field"><label>¿Cliente realiza aviso al CCAU?</label><select id="clienteAvisoCcau" name="clienteAvisoCcau">
                        <option value="">--Seleccione--</option>
                        <option value="si">SI</option>
                        <option value="no">NO</option>
                    </select></div>
                <div class="field"><label id="numAvisoLabel" class="hidden">Número de aviso al CCAU</label><input type="text" id="numAvisoCcau" name="numAvisoCcau" maxlength="15" class="hidden" placeholder="Máx 15 chars"></div>

                <div class="field">
                    <label for="tipoRevision">Tipo de revisión</label>
                    <select id="tipoRevision" name="tipoRevision">
                        <option value="">-- Seleccione --</option>
                        <option value="Asistencia Gas" selected>Asistencia Gas</option>
                        <option value="Asistencia Hogar">Asistencia Hogar</option>
                        <option value="Asistencia Hogar Plus">Asistencia Hogar Plus</option>
                        <option value="Servigas Natural">Servigas Natural</option>
                    </select>
                </div>

            </div>
        </div>

        <div class="section collapsible">
            <h2>Técnico</h2>
            <div class="section-content">
                <label>Nombre del técnico</label><input type="text" id="nombreTecnico" name="nombreTecnico" value="Aldair Isaac Sierra Loa">
                <label>Empresa colaboradora</label><input type="text" id="empresaTecnico" name="empresaTecnico" value="Oca Global">
                <label>Número de técnico</label><input type="text" id="numTecnico" name="numTecnico" value="7236">
                <label>Hora de salida (+30 min)</label><input type="datetime-local" id="horaSalida" name="horaSalida" readonly>
            </div>
        </div>

        <div class="section">
            <div class="actions">
                <button type="button" class="btn secondary" id="btnCancel">Cancelar</button>
                <button type="submit" class="btn primary">Guardar Inspección</button>
            </div>
        </div>

    </form>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <h3>Seleccionar defectos</h3>
            <div id="modalDefectos" class="modal-grid"></div>
            <div class="modal-actions">
                <button type="button" class="btn secondary" onclick="window.cerrarModal()">Cancelar</button>
                <button type="button" class="btn primary" onclick="window.guardarDefectos()">Guardar</button>
            </div>
        </div>
    </div>


    <script type="module">
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import {
            getFirestore,
            collection,
            addDoc
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
        import {
            getStorage,
            ref,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBLqVCqW2s7piZQUH0dHODjK4JXAv74TdA",
            authDomain: "asl-apk.firebaseapp.com",
            projectId: "asl-apk",
            storageBucket: "asl-apk.appspot.com",
            messagingSenderId: "803053462437",
            appId: "1:803053462437:web:b2f4ccb8cd63c489c77e4c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        // ==========================================
        // CONSTANTES Y ESTADO (Restaurado de anterior.txt)
        // ==========================================
        const EQUIPOS_ORDER = [{
                id: 'CA',
                name: 'CA - Calentador de Acumulación'
            },
            {
                id: 'CP',
                name: 'CP - Calentador de Paso'
            },
            {
                id: 'ES',
                name: 'ES - Estufa'
            },
            {
                id: 'HO',
                name: 'HO - Horno'
            },
            {
                id: 'SE',
                name: 'SE - Secador'
            },
            {
                id: 'CL',
                name: 'CL - Calentador'
            },
            {
                id: 'VS',
                name: 'VS - Válvula Sin Aparato'
            }
        ];

        const DEFECTOS_APARATO = [
            '(10) Dificultad de cierre',
            '(13) Zona de ventilación permanente',
            '(14) Material fuera de norma aparato',
            '(17) Aparato fijo sin conexión fija',
            '(61) Fuga en manguera interior',
            '(62) Fuga en aparato',
            '(63) Fuga en válvula',
            '(64) Manguera dañada interior',
            '(65) Sin ventilación permanente primer piso',
            '(66) Sin conducto de evacuación de gases',
            '(67) Fuga en manguera exterior',
            '(68) Manguera dañada exterior',
            '(80) Monóxido de carbono (CO) ppm',
            '(85) Sin ventilación permanente por debajo del primer sótano',
            '(86) Elemento de cierre'
        ];

        let defectosPorEquipo = {};
        let equipoActivo = null;
        let fotosMedidorSeleccionadas = [];

        // ==========================================
        // HELPERS
        // ==========================================
        const trimOrNull = v => (v === undefined || v === null) ? null : (String(v).trim() === "" ? null : String(v).trim());

        function gatherFormFields(form) {
            const out = {};
            const names = new Set(Array.from(form.elements).map(el => el.name).filter(n => n));
            names.forEach(name => {
                const els = Array.from(form.querySelectorAll(`[name="${name}"]`));
                if (!els.length) return;
                const first = els[0];
                if (first.type === "checkbox") {
                    if (els.length > 1) {
                        const checked = els.filter(e => e.checked).map(e => trimOrNull(e.value)).filter(Boolean);
                        out[name] = checked.length ? checked : null;
                    } else {
                        out[name] = first.checked ? (trimOrNull(first.value) ?? true) : null;
                    }
                } else if (first.tagName === "SELECT") {
                    const vals = Array.from(first.selectedOptions).map(o => trimOrNull(o.value)).filter(Boolean);
                    out[name] = vals.length ? (first.multiple ? vals : vals[0]) : null;
                } else {
                    out[name] = trimOrNull(first.value);
                }
            });
            return out;
        }

        // ==========================================
        // FUNCIONES UI (Restaurado de anterior.txt)
        // ==========================================

        // 1. Renderizar tabla de equipos
        function renderEquipos() {
            const tabla = document.getElementById('p2Aparatos');
            if (!tabla) return;
            tabla.innerHTML = ''; // Limpiar

            EQUIPOS_ORDER.forEach((eq) => {
                const card = document.createElement('div');
                card.className = 'eq-box';
                card.innerHTML = `
          <div class="eq-header">
            <strong>${eq.name}</strong>
            <div class="qty-controls">
                <button type="button" class="qty-btn" data-action="minus" data-eq="${eq.id}" aria-label="Restar ${eq.name}">−</button>
                <input type="number" min="0" value="0" data-eq="${eq.id}" class="qty">
                <button type="button" class="qty-btn" data-action="plus" data-eq="${eq.id}" aria-label="Sumar ${eq.name}">+</button>
            </div>
          </div>
          <div id="co_${eq.id}" class="co-box hidden">
            <input type="number" min="0" value="0" placeholder="CO ppm" style="width:100px">
          </div>
          <div style="margin-top:4px;">
             <button type="button" class="btn secondary hidden" id="btn_${eq.id}" onclick="window.abrirModal('${eq.id}')">Seleccionar Defectos</button>
          </div>
          <div class="selected-list" id="list_${eq.id}"></div>
        `;
                tabla.appendChild(card);
            });
        }

        // 2. Modales (Exponemos a window porque es type module)
        window.abrirModal = (eq) => {
            equipoActivo = eq;
            const current = defectosPorEquipo[eq] || [];
            const modalOverlay = document.getElementById('modalOverlay');
            const modalDefectos = document.getElementById('modalDefectos');

            modalOverlay.style.display = 'flex';
            modalDefectos.innerHTML = DEFECTOS_APARATO.map(d => {
                const checked = current.includes(d) ? 'checked' : '';
                return `<label><input type="checkbox" value="${d}" ${checked}> ${d}</label>`;
            }).join('');
        };

        window.cerrarModal = () => {
            document.getElementById('modalOverlay').style.display = 'none';
        };

        window.guardarDefectos = () => {
            if (!equipoActivo) return;
            const modalDefectos = document.getElementById('modalDefectos');
            const checks = Array.from(modalDefectos.querySelectorAll('input:checked'));
            const selected = checks.map(c => c.value);
            defectosPorEquipo[equipoActivo] = selected;

            // Actualizar UI
            const list = document.getElementById('list_' + equipoActivo);
            list.innerHTML = selected.map(item => `<span class="selected-item">${item}</span>`).join(' ');

            window.cerrarModal();
            syncP4(); // Regenerar textos
        };

        function updateEquipoVisibility(eq, qty) {
            const coBox = document.getElementById('co_' + eq);
            const btn = document.getElementById('btn_' + eq);
            const list = document.getElementById('list_' + eq);
            const coInput = document.querySelector(`#co_${eq} input`);
            if (!coBox || !btn || !list || !coInput) return;

            if (qty > 0) {
                coBox.classList.remove('hidden');
                btn.classList.remove('hidden');
                coInput.value = coInput.value === '' ? '0' : coInput.value;
                coInput.required = true;
            } else {
                coBox.classList.add('hidden');
                btn.classList.add('hidden');
                coInput.value = '0';
                coInput.required = false;
                list.innerHTML = '';
                defectosPorEquipo[eq] = [];
                syncP4();
            }
        }

        function expandSectionP4() {
            const section = document.getElementById('sectionP4');
            if (!section) return;
            const content = section.querySelector('.section-content');
            if (!content) return;

            section.classList.remove('collapsed');
            content.style.maxHeight = content.scrollHeight + 'px';
        }


        function syncExclusiveGroup(groupName, selectedInput) {
            document.querySelectorAll(`input[name="${groupName}"]`).forEach(cb => {
                if (cb !== selectedInput) cb.checked = false;
            });
        }

        function updateTitularParentesco() {
            const noTitular = document.querySelector('input[name="titularServicio"][value="no"]');
            const parentescoField = document.getElementById('fieldParentesco');
            const parentescoInput = document.getElementById('parentesco');
            if (!noTitular || !parentescoField || !parentescoInput) return;

            if (noTitular.checked) {
                parentescoField.classList.remove('hidden');
                parentescoInput.required = true;
            } else {
                parentescoField.classList.add('hidden');
                parentescoInput.required = false;
                parentescoInput.value = '';
            }
        }

        function hasFugaSeleccionada(p21Checked, equiposConDefectos) {
            const fugaEnIda = p21Checked.some(item => {
                const text = `${item.value || ''} ${item.parentNode?.textContent || ''}`.toLowerCase();
                return text.includes('fuga');
            });

            const fugaEnAparatos = equiposConDefectos.some(([, defects]) =>
                (defects || []).some(def => String(def).toLowerCase().includes('fuga'))
            );

            return fugaEnIda || fugaEnAparatos;
        }

        function syncDatosExtras(fugaActiva) {
            const section = document.getElementById('sectionDatosExtras');
            const clienteAviso = document.getElementById('clienteAvisoCcau');
            const tipoRevision = document.getElementById('tipoRevision');
            const numAviso = document.getElementById('numAvisoCcau');
            const numAvisoLabel = document.getElementById('numAvisoLabel');
            if (!section || !clienteAviso || !tipoRevision || !numAviso || !numAvisoLabel) return;

            if (fugaActiva) {
                section.classList.remove('hidden');
                clienteAviso.required = true;
                tipoRevision.required = true;
                const content = section.querySelector('.section-content');
                if (content && !section.classList.contains('collapsed')) {
                    content.style.maxHeight = content.scrollHeight + 'px';
                }
            } else {
                section.classList.add('hidden');
                clienteAviso.required = false;
                tipoRevision.required = false;
                numAviso.required = false;
                clienteAviso.value = '';
                numAviso.value = '';
                numAviso.classList.add('hidden');
                numAvisoLabel.classList.add('hidden');
            }
        }

        function updatePruebaLitrajeUI() {
            const pruebaNo = document.querySelector('input[name="pruebaLitraje"][value="no"]');
            const fieldLecturaActual = document.getElementById('fieldLecturaActual');
            const lecturaActual = document.getElementById('lecturaActual');
            const sectionP1 = document.getElementById('sectionP1');
            const sectionP22 = document.getElementById('sectionP22');
            const p1Ini = document.getElementById('p1Ini');
            const p1Fin = document.getElementById('p1Fin');
            const p1Duracion = document.getElementById('p1Duracion');

            if (!pruebaNo || !fieldLecturaActual || !lecturaActual || !sectionP1 || !sectionP22 || !p1Ini || !p1Fin || !p1Duracion) return;

            const noPrueba = pruebaNo.checked;
            if (noPrueba) {
                fieldLecturaActual.classList.remove('hidden');
                lecturaActual.required = true;
                sectionP1.classList.add('hidden');
                sectionP22.classList.add('hidden');
                p1Ini.required = false;
                p1Fin.required = false;
                p1Duracion.required = false;
                p1Duracion.value = '';
                const p1Diff = document.getElementById('p1Diff');
                const p1Flujo = document.getElementById('p1Flujo');
                const p1DiffLabel = document.getElementById('p1DiffLabel');
                const p1FlujoLabel = document.getElementById('p1FlujoLabel');
                if (p1Diff) p1Diff.value = '0';
                if (p1Flujo) p1Flujo.value = '0';
                if (p1DiffLabel) p1DiffLabel.textContent = '0.00';
                if (p1FlujoLabel) p1FlujoLabel.textContent = '0.00';

                document.querySelectorAll('.qty').forEach(inp => {
                    inp.value = 0;
                    updateEquipoVisibility(inp.dataset.eq, 0);
                });
            } else {
                fieldLecturaActual.classList.add('hidden');
                lecturaActual.required = false;
                lecturaActual.value = '';
                sectionP1.classList.remove('hidden');
                sectionP22.classList.remove('hidden');
                p1Ini.required = true;
                p1Fin.required = true;
                p1Duracion.required = true;
            }
        }

        function renderFotosMedidorLista() {
            const lista = document.getElementById('fotosMedidorLista');
            if (!lista) return;
            if (!fotosMedidorSeleccionadas.length) {
                lista.innerHTML = '<li>Sin fotografías seleccionadas.</li>';
                return;
            }
            lista.innerHTML = fotosMedidorSeleccionadas
                .map(file => `<li>${file.name} (${Math.round(file.size / 1024)} KB)</li>`)
                .join('');
        }

        function addFotosMedidor(files) {
            const nuevas = Array.from(files || []).filter(file => file?.type?.startsWith('image/'));
            if (!nuevas.length) return;
            fotosMedidorSeleccionadas = [...fotosMedidorSeleccionadas, ...nuevas].slice(0, 5);
            renderFotosMedidorLista();
        }

        function validateBusinessRules() {
            const form = document.getElementById('formODIS');
            if (!form) return false;

            if (!form.reportValidity()) return false;

            const titularSeleccionado = document.querySelectorAll('input[name="titularServicio"]:checked').length;
            if (!titularSeleccionado) {
                alert('Debe seleccionar si es titular del servicio (Sí/No).');
                return false;
            }

            const grupos = ['tamborLitraje', 'registroLitraje', 'pruebaLitraje'];
            for (const g of grupos) {
                if (!document.querySelector(`input[name="${g}"]:checked`)) {
                    alert('Complete toda la sección de datos del medidor.');
                    return false;
                }
            }

            if (!document.querySelector('input[name="nivelAccesibilidad"]:checked')) {
                alert('Seleccione el nivel de accesibilidad (G1, G2 o G3).');
                return false;
            }

            const sectionP22 = document.getElementById('sectionP22');
            const p22Visible = sectionP22 && !sectionP22.classList.contains('hidden');
            if (p22Visible) {
                const totalAparatos = Array.from(document.querySelectorAll('.qty')).reduce((acc, el) => acc + Number(el.value || 0), 0);
                if (totalAparatos < 1) {
                    alert('Debe seleccionar mínimo un aparato en P2.2.');
                    return false;
                }
            }

            const totalDefectos = document.querySelectorAll('.p21-def:checked').length + Object.values(defectosPorEquipo).reduce((acc, arr) => acc + (arr?.length || 0), 0);
            const totalFilasP4 = document.querySelectorAll('#p4Contenedor .p4-row').length;
            if (totalDefectos > 0 && totalFilasP4 < totalDefectos) {
                alert('Si selecciona defectos, deben reflejarse en P4.');
                return false;
            }

            const precintoGlobal = document.getElementById('precinto');
            if (precintoGlobal && !precintoGlobal.classList.contains('hidden') && !trimOrNull(precintoGlobal.value)) {
                alert('El precinto es obligatorio cuando hay defecto crítico.');
                precintoGlobal.focus();
                return false;
            }

            const sectionP1 = document.getElementById('sectionP1');
            const p1Visible = sectionP1 && !sectionP1.classList.contains('hidden');
            if (p1Visible) {
                const p1Ini = document.getElementById('p1Ini');
                const p1Fin = document.getElementById('p1Fin');
                const iniVal = Number(p1Ini?.value || 0);
                const finVal = Number(p1Fin?.value || 0);

                if (finVal < iniVal) {
                    alert('La lectura final no puede ser menor que la lectura inicial.');
                    p1Fin?.focus();
                    return false;
                }

                const diferencia = finVal - iniVal;
                if (diferencia > 30) {
                    const confirmar = confirm(`La diferencia calculada es ${diferencia.toFixed(2)}. ¿Confirma que es correcta?`);
                    if (!confirmar) {
                        p1Fin?.focus();
                        return false;
                    }
                }
            }

            const fotos = Array.from(fotosMedidorSeleccionadas || []);
            if (fotos.length > 5) {
                alert('Máximo 5 fotos del medidor por inspección.');
                return false;
            }
            const noImagen = fotos.find(file => !file.type?.startsWith('image/'));
            if (noImagen) {
                alert('Solo se permiten imágenes en Fotografías del medidor.');
                return false;
            }

            return true;
        }

        async function uploadFotosMedidor(files, poliza) {
            if (!files || files.length === 0) return [];

            const safePoliza = (poliza || 'sin-poliza').replace(/[^a-zA-Z0-9_-]/g, '_');
            const timestamp = Date.now();
            const uploads = [];

            for (const file of files) {
                if (!file.type?.startsWith('image/')) continue;
                const cleanName = (file.name || 'foto-medidor').replace(/[^a-zA-Z0-9._-]/g, '_');
                const path = `inspecciones/${safePoliza}/medidor/${timestamp}_${cleanName}`;
                const fileRef = ref(storage, path);
                const snap = await uploadBytes(fileRef, file);
                const url = await getDownloadURL(snap.ref);
                uploads.push({
                    nombre: cleanName,
                    tipo: file.type,
                    tamano: file.size,
                    path,
                    url
                });
            }

            return uploads;
        }

        // 3. Sincronización P4 (EL CEREBRO DE LA GENERACIÓN DE TEXTO)
        function syncP4() {
            const p4Cont = document.getElementById('p4Contenedor');
            if (!p4Cont) return;

            p4Cont.innerHTML = '';

            // Defectos P2.1 (Checkboxes estáticos)
            const p21Checked = Array.from(document.querySelectorAll('.p21-def')).filter(i => i.checked);

            // Defectos P2.2 (Dinámicos)
            const equiposConDefectos = Object.entries(defectosPorEquipo).filter(([, defects]) => defects && defects.length > 0);

            if (p21Checked.length === 0 && equiposConDefectos.length === 0) {
                p4Cont.innerHTML = '<span class="muted">Seleccione defectos en la sección P2 para generar observaciones automáticas aquí.</span>';
                document.getElementById('precinto').classList.add('hidden');
                document.getElementById('precinto').required = false;
                document.getElementById('precintoLabel').classList.add('hidden');
                syncDatosExtras(false);
                expandSectionP4();
                return;
            }

            let hayCritico = false;

            // A. Renderizar Defectos IDA (P2.1)
            if (p21Checked.length > 0) {
                const box = document.createElement('div');
                box.className = 'defecto';
                box.innerHTML = `<strong>IDA (Instalación)</strong>`;
                p4Cont.appendChild(box);

                p21Checked.forEach(d => {
                    const esCritico = d.dataset.cat === 'crit';
                    if (esCritico) hayCritico = true;

                    const txt = d.parentNode.textContent.trim();
                    const row = document.createElement('div');
                    row.className = 'p4-row';

                    // Input de precinto solo si es crítico (individual)
                    const precintoHtml = esCritico ?
                        `<input type="text" class="precinto-input" placeholder="Precinto">` : `<div></div>`;

                    row.innerHTML = `
                <div>
                    <div style="font-weight:bold; font-size:11px; margin-bottom:2px;">${txt}</div>
                    <textarea rows="2">Se detecta ${txt.toLowerCase()}</textarea>
                </div>
                ${precintoHtml}
            `;
                    box.appendChild(row);
                });
            }



            // B. Renderizar Defectos Aparatos (P2.2)
            equiposConDefectos.forEach(([eqId, defects]) => {
                const eqInfo = EQUIPOS_ORDER.find(x => x.id === eqId);
                const eqName = eqInfo ? eqInfo.name : eqId;

                const box = document.createElement('div');
                box.className = 'defecto';
                box.innerHTML = `<strong>${eqName}</strong>`;
                p4Cont.appendChild(box);

                defects.forEach(defecto => {
                    // Lógica simple para determinar crítico en aparato (basado en códigos comunes)
                    const codesCriticos = ['(61)', '(62)', '(63)', '(67)', '(80)'];
                    const esCritico = codesCriticos.some(c => defecto.includes(c));
                    if (esCritico) hayCritico = true;

                    const row = document.createElement('div');
                    row.className = 'p4-row';

                    const precintoHtml = esCritico ?
                        `<input type="text" class="precinto-input" placeholder="Precinto">` : `<div></div>`;

                    row.innerHTML = `
                <div>
                     <div style="font-weight:bold; font-size:11px; margin-bottom:2px;">${defecto}</div>
                    <textarea rows="2">Se detecta ${defecto.toLowerCase()} en ${eqName.toLowerCase()}. Proceder según normativa.</textarea>
                </div>
                ${precintoHtml}
            `;
                    box.appendChild(row);
                });
            });

            // Mostrar/Ocultar precinto global según si hubo críticos
            const precintoGlobal = document.getElementById('precinto');
            const precintoLabel = document.getElementById('precintoLabel');
            if (hayCritico) {
                precintoGlobal.classList.remove('hidden');
                precintoGlobal.required = true;
                precintoLabel.classList.remove('hidden');
            } else {
                precintoGlobal.classList.add('hidden');
                precintoGlobal.required = false;
                precintoLabel.classList.add('hidden');
            }

            const fugaActiva = hasFugaSeleccionada(p21Checked, equiposConDefectos);
            syncDatosExtras(fugaActiva);
            expandSectionP4();
        }

        // 4. Recolectores de Datos Complejos (para Firebase)
        function getP21DefectosFromDOM() {
            const criticos = [];
            const secundarios = [];
            document.querySelectorAll('.p21-def').forEach(cb => {
                if (!cb.checked) return;
                const v = trimOrNull(cb.value);
                if (!v) return;
                if (cb.dataset.cat === "crit") criticos.push(v);
                else if (cb.dataset.cat === "sec") secundarios.push(v);
            });
            return {
                criticos: criticos.length ? criticos : null,
                secundarios: secundarios.length ? secundarios : null
            };
        }

        function getEquiposDataFromDOM() {
            const data = {};
            document.querySelectorAll('.qty').forEach(inp => {
                const eq = inp.dataset.eq;
                const cantidad = Number(inp.value || 0);
                if (cantidad <= 0) return;

                const coContainer = document.querySelector(`#co_${eq} input`);
                const co_ppm = coContainer && coContainer.value ? Number(coContainer.value) : null;

                const defects = defectosPorEquipo[eq];

                data[eq] = {
                    cantidad,
                    co_ppm,
                    defectos: defects && defects.length ? defects : null
                };
            });
            return Object.keys(data).length ? data : null;
        }

        function getP4GeneratedFromDOM() {
            const out = [];
            const p4Cont = document.getElementById('p4Contenedor');
            if (!p4Cont) return null;

            const filas = p4Cont.querySelectorAll('.p4-row');
            filas.forEach(f => {
                const ta = f.querySelector('textarea');
                const prec = f.querySelector('.precinto-input');
                const desc = ta ? trimOrNull(ta.value) : null;
                const precVal = prec ? trimOrNull(prec.value) : null;
                if (desc || precVal) {
                    out.push({
                        descripcion: desc,
                        precinto: precVal
                    });
                }
            });
            return out.length ? out : null;
        }


        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {

            // 1. Renderizar tabla vacía
            renderEquipos();
            document.getElementById('p1Ini') && (document.getElementById('p1Ini').required = true);
            document.getElementById('p1Fin') && (document.getElementById('p1Fin').required = true);
            document.getElementById('p1Duracion') && (document.getElementById('p1Duracion').required = true);
            syncDatosExtras(false);

            // 2. Listeners para Inputs/Botones de Cantidad (mostrar CO y botón defectos)
            document.addEventListener('input', e => {
                if (e.target.classList.contains('qty')) {
                    const eq = e.target.dataset.eq;
                    const qty = Math.max(0, Number(e.target.value || 0));
                    e.target.value = qty;
                    updateEquipoVisibility(eq, qty);
                }
            });

            document.addEventListener('click', e => {
                if (!e.target.classList.contains('qty-btn')) return;
                const eq = e.target.dataset.eq;
                const action = e.target.dataset.action;
                const qtyInput = document.querySelector(`.qty[data-eq="${eq}"]`);
                if (!qtyInput) return;

                const current = Math.max(0, Number(qtyInput.value || 0));
                const next = action === 'plus' ? current + 1 : Math.max(0, current - 1);
                qtyInput.value = next;
                updateEquipoVisibility(eq, next);
            });

            // 3. Listeners para checkboxes y reglas de visibilidad
            document.addEventListener('change', e => {
                if (e.target.classList.contains('p21-def')) {
                    syncP4();
                }

                if (e.target.matches('input[name="titularServicio"]')) {
                    syncExclusiveGroup('titularServicio', e.target);
                    updateTitularParentesco();
                }

                if (e.target.matches('input[name="tamborLitraje"]')) syncExclusiveGroup('tamborLitraje', e.target);
                if (e.target.matches('input[name="registroLitraje"]')) syncExclusiveGroup('registroLitraje', e.target);
                if (e.target.matches('input[name="pruebaLitraje"]')) {
                    syncExclusiveGroup('pruebaLitraje', e.target);
                    updatePruebaLitrajeUI();
                }
                if (e.target.matches('input[name="nivelAccesibilidad"]')) syncExclusiveGroup('nivelAccesibilidad', e.target);
            });

            const btnTomarFotoMedidor = document.getElementById('btnTomarFotoMedidor');
            const btnSubirFotoMedidor = document.getElementById('btnSubirFotoMedidor');
            const fotosMedidorCamara = document.getElementById('fotosMedidorCamara');
            const fotosMedidorArchivo = document.getElementById('fotosMedidorArchivo');

            btnTomarFotoMedidor?.addEventListener('click', () => fotosMedidorCamara?.click());
            btnSubirFotoMedidor?.addEventListener('click', () => {
                if (Array.isArray(fotosMedidorSeleccionadas) && fotosMedidorSeleccionadas.length > 0) {
                    const ver = confirm('Ya cargaste fotografías. ¿Deseas verlas?');
                    if (ver) {
                        document.getElementById('fotosMedidorLista')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        return;
                    }
                    const editar = confirm('¿Deseas editar/agregar más fotografías?');
                    if (!editar) return;
                }
                fotosMedidorArchivo?.click();
            });
            fotosMedidorCamara?.addEventListener('change', (e) => {
                addFotosMedidor(e.target.files);
                e.target.value = '';
            });
            fotosMedidorArchivo?.addEventListener('change', (e) => {
                addFotosMedidor(e.target.files);
                e.target.value = '';
            });

            renderFotosMedidorLista();
            updateTitularParentesco();
            updatePruebaLitrajeUI();

            // 4. Listener para Aviso CCAU
            document.getElementById('clienteAvisoCcau')?.addEventListener('change', function(e) {
                const esSi = e.target.value === 'si';
                const numInput = document.getElementById('numAvisoCcau');
                const label = document.getElementById('numAvisoLabel');
                if (esSi) {
                    numInput.classList.remove('hidden');
                    label.classList.remove('hidden');
                    numInput.required = true;
                } else {
                    numInput.classList.add('hidden');
                    label.classList.add('hidden');
                    numInput.required = false;
                    numInput.value = '';
                }
            });

            // 5. SUBMIT DEL FORMULARIO
            const form = document.getElementById('formODIS');
            if (!form) return;

            form.addEventListener('submit', async ev => {
                ev.preventDefault();

                if (!validateBusinessRules()) return;


                // A. Recopilar datos planos (para fallbacks)
                const flat = gatherFormFields(form);

                // B. Recopilar datos estructurados (Restaurado)
                const p21 = getP21DefectosFromDOM();
                const equipos = getEquiposDataFromDOM();
                const p4Generado = getP4GeneratedFromDOM();

                // Valores calculados
                const computed = {
                    lecturaInicial: trimOrNull(document.getElementById('p1Ini')?.value),
                    lecturaFinal: trimOrNull(document.getElementById('p1Fin')?.value),
                    diferencia: trimOrNull(document.getElementById('p1Diff')?.value),
                    duracionMinutos: trimOrNull(document.getElementById('p1Duracion')?.value),
                    flujoLitrosHora: trimOrNull(document.getElementById('p1Flujo')?.value),
                    horaSalida: trimOrNull(document.getElementById('horaSalida')?.value)
                };

                let fotosMedidor = [];
                try {
                    fotosMedidor = await uploadFotosMedidor(fotosMedidorSeleccionadas, flat.poliza);
                } catch (err) {
                    console.error(err);
                    alert("❌ Error al subir fotografías del medidor.");
                    return;
                }

                // C. Construir Objeto seccionado tal cual el cuestionario
                const pruebaLitrajeNo = document.querySelector('input[name="pruebaLitraje"][value="no"]')?.checked;
                const ccauVisible = !document.getElementById('sectionDatosExtras')?.classList.contains('hidden');

                const registro = {
                    createdAt: new Date().toISOString(),
                    cuestionario: {
                        datosCliente: {
                            poliza: flat.poliza,
                            nombre: flat.nombre,
                            telefono: flat.telefono,
                            celular: flat.celular,
                            fechaNacimiento: flat.fechaNacimiento,
                            email: flat.email,
                            identificacionPresentada: flat.identificacionCliente,
                            titularServicio: flat.titularServicio,
                            parentesco: flat.parentesco,
                            fechasReg: {
                                fechaSolicitud: flat.fechaSolicitud,
                                fechaRequerida: flat.fechaRequerida,
                                fechaVencimiento: flat.fechaVencimiento
                            }
                        },
                        datosMedidor: {
                            fechaInspeccion: flat.fechaInspeccion,
                            latlng: flat.latlng,
                            presenteTamborLitraje: flat.tamborLitraje,
                            registroLitraje: flat.registroLitraje,
                            nivelAccesibilidad: flat.nivelAccesibilidad,
                            pruebaLitraje: flat.pruebaLitraje,
                            lecturaActual: flat.lecturaActual,
                            fotografiasMedidor: fotosMedidor
                        },
                        p1PruebaLitrajeInicial: {
                            visible: !pruebaLitrajeNo,
                            lecturaInicial: computed.lecturaInicial,
                            lecturaFinal: computed.lecturaFinal,
                            diferencia: computed.diferencia,
                            duracionMinutos: computed.duracionMinutos,
                            flujoLitrosHora: computed.flujoLitrosHora
                        },
                        p2SeguimientoIDA: {
                            visible: !pruebaLitrajeNo,
                            p21DefectosIDA: p21,
                            p22AparatosConectados: equipos
                        },
                        p4DescripcionVerificacion: {
                            observacionesGlobales: flat.observacionesGlobal,
                            precintoGlobal: flat.precinto,
                            descripcionesGeneradas: p4Generado
                        },
                        ccau: {
                            visible: ccauVisible,
                            clienteAvisoCcau: flat.clienteAvisoCcau,
                            numeroAvisoCcau: flat.numAvisoCcau,
                            tipoRevision: flat.tipoRevision
                        },
                        tecnico: {
                            nombreTecnico: flat.nombreTecnico,
                            empresaColaboradora: flat.empresaTecnico,
                            numeroTecnico: flat.numTecnico,
                            horaSalida: computed.horaSalida
                        }
                    }
                };

                try {
                    await addDoc(collection(db, "Inspecciones"), registro);
                    alert("✅ Inspección guardada correctamente.");
                    if (confirm("¿Desea limpiar el formulario?")) {
                        location.reload();
                    }
                } catch (err) {
                    console.error(err);
                    alert("❌ Error al guardar. Revise la consola.");
                }
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            /* DIFERENCIA P1 */
            const ini = document.getElementById('p1Ini');
            const fin = document.getElementById('p1Fin');
            const duracion = document.getElementById('p1Duracion');
            const diff = document.getElementById('p1Diff');
            const diffLabel = document.getElementById('p1DiffLabel');
            const flujo = document.getElementById('p1Flujo');
            const flujoLabel = document.getElementById('p1FlujoLabel');
            let finEditadoManualmente = false;

            function calc() {
                const iniVal = Number(ini?.value || 0);
                const finVal = Number(fin?.value || 0);
                const diferencia = finVal - iniVal;
                const minutos = Number(duracion?.value || 0);
                const flujoHora = minutos > 0 ? (60 / minutos) * diferencia : 0;

                if (diff) diff.value = String(diferencia);
                if (flujo) flujo.value = String(flujoHora);
                if (diffLabel) diffLabel.textContent = Number.isFinite(diferencia) ? diferencia.toFixed(2) : '0.00';
                if (flujoLabel) flujoLabel.textContent = Number.isFinite(flujoHora) ? flujoHora.toFixed(2) : '0.00';
            }

            function syncLitrajeFinalDesdeInicial() {
                if (!ini || !fin) return;
                fin.min = ini.value || '0';
                if (!finEditadoManualmente || !fin.value) {
                    fin.value = ini.value || '';
                }
                if (fin.value && Number(fin.value) < Number(ini.value || 0)) {
                    fin.value = ini.value || '';
                }
            }

            ini?.addEventListener('input', () => {
                syncLitrajeFinalDesdeInicial();
                calc();
            });

            fin?.addEventListener('input', () => {
                finEditadoManualmente = true;
                if (fin.value && Number(fin.value) < Number(ini?.value || 0)) {
                    fin.value = ini?.value || '';
                }
                calc();
            });

            fin?.addEventListener('blur', () => {
                if (!fin.value) finEditadoManualmente = false;
            });

            duracion?.addEventListener('input', calc);
            syncLitrajeFinalDesdeInicial();
            calc();

            /* CALCULO FECHAS */
            function formatearFechaDDMMYYYY(date) {
                const pad = n => String(n).padStart(2, '0');
                return `${pad(date.getDate())}/${pad(date.getMonth() + 1)}/${date.getFullYear()}`;
            }

            function ponerFechaInspeccion() {
                const ahora = new Date();
                const input = document.getElementById('fechaInspeccion');
                if (input) {
                    input.value = formatearFechaDDMMYYYY(ahora);
                }
            }

            ponerFechaInspeccion();

            function toLocalInputFormat(date) {
                const pad = n => String(n).padStart(2, '0');
                return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
            }

            function calcularFechasIniciales() {
                const ahora = new Date();
                const requerida = new Date(ahora);
                requerida.setDate(requerida.getDate() + 7);
                const vencimiento = new Date(ahora);
                vencimiento.setMonth(vencimiento.getMonth() + 1);
                const salida = new Date(ahora);
                salida.setMinutes(salida.getMinutes() + 30);

                const fSol = document.getElementById('fechaSolicitud');
                if (fSol && !fSol.value) fSol.value = toLocalInputFormat(ahora); // Solo si esta vacio

                document.getElementById('fechaRequerida') && (document.getElementById('fechaRequerida').value = toLocalInputFormat(requerida));
                document.getElementById('fechaVencimiento') && (document.getElementById('fechaVencimiento').value = toLocalInputFormat(vencimiento));
                document.getElementById('horaSalida') && (document.getElementById('horaSalida').value = toLocalInputFormat(salida));
            }

            calcularFechasIniciales();

            /* AUTOLLENADO URL */
            function autocompletarDesdeURL() {
                const params = new URLSearchParams(window.location.search);
                const poliza = params.get("poliza");
                const nombre = params.get("nombre");
                const lat = params.get("lat");
                const lng = params.get("lng");

                if (poliza) {
                    const el = document.querySelector('[name="poliza"]');
                    if (el) {
                        el.value = poliza;
                        el.readOnly = true;
                        el.tabIndex = -1;
                    }
                }
                if (nombre) {
                    const el = document.querySelector('[name="nombre"]');
                    if (el) {
                        el.value = nombre;
                        el.readOnly = true;
                        el.tabIndex = -1;
                    }
                }
                if (lat && lng) {
                    const el = document.querySelector('[name="latlng"]');
                    if (el) {
                        el.value = `${lat}, ${lng}`;
                        el.readOnly = true;
                        el.tabIndex = -1;
                    }
                }
            }
            autocompletarDesdeURL();

            /* ACORDEON (Lógica Corregida) */
            document.querySelectorAll('.section.collapsible').forEach(section => {
                const header = section.querySelector('h2, h3');
                const content = section.querySelector('.section-content');
                if (!header || !content) return;
                // Inicializar altura
                content.style.maxHeight = content.scrollHeight + "px";

                header.addEventListener('click', () => {
                    section.classList.toggle('collapsed');
                    // Recalcular altura al clickear
                    if (section.classList.contains('collapsed')) {
                        content.style.maxHeight = "0px";
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                    }
                });
            });

            /* CANCELAR */
            document.getElementById('btnCancel')?.addEventListener('click', () => {
                if (confirm("¿Limpiar formulario?")) location.reload();
            });

        });
    </script>
</body>

</html>
