<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ODIS Incidencias - Formulario Completo (P2 Visible)</title>
<style>
*{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
body{margin:0;background:#f2f4f7;padding:16px}
h2,h3{margin:12px 0;color:#0b3356}
label{font-size:14px;margin-top:8px;display:block}
input,select,textarea{width:100%;padding:8px;margin-top:4px;border:1px solid #ccc;border-radius:6px}
textarea{resize:vertical}
.section{background:#fff;padding:16px;border-radius:8px;margin-bottom:16px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
.hidden{display:none}
.btn{padding:10px 16px;border:none;border-radius:6px;cursor:pointer}
.primary{background:#0b3356;color:#fff}
.secondary{background:#ddd}
.actions{display:flex;justify-content:flex-end;gap:10px}
.defecto{border:1px dashed #ccc;padding:8px;border-radius:6px;margin-top:6px}
.muted{color:#777;font-size:13px}
.equipo{border:1px solid #e6eef5;padding:10px;border-radius:8px;margin-bottom:8px}
.equipo-header{display:flex;align-items:center;gap:10px}
.group-title{font-weight:700;margin-top:8px}
.small{font-size:13px;color:#555}
.eq-box{font-size:13px}
.eq-header{display:flex;justify-content:space-between;align-items:center;gap:6px}
.eq-header input{width:65px}
.co-box{margin-top:4px}
.selected-list{margin-top:6px;font-size:12.5px;color:#333}
.selected-item{background:#eef3ff;padding:3px 6px;border-radius:4px;margin:2px 0;display:inline-block}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:1000}
.modal{background:#fff;width:90%;max-width:500px;border-radius:10px;padding:16px;max-height:80vh;overflow:auto}
.modal h3{margin-top:0}
.modal-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}
.modal label{display:block;margin:6px 0;font-size:13px}
@media(max-width:700px){body{padding:8px}}
</style>
</head>
<body>

<form id="formODIS">

<div class="section">
  <h2>Acta / Revisión Anual Preventiva</h2>
</div>

<div class="section">
  <h2>Datos del Cliente</h2>
  <label>Póliza</label><input type="number" name="poliza">
  <label>Nombre</label><input type="text" name="nombre">
  <label>Teléfono</label><input type="tel" name="telefono">
  <label>Celular</label><input type="tel" name="celular">
  <label>Fecha de nacimiento</label><input type="date" name="fechaNacimiento">
  <label>Correo electrónico</label><input type="email" name="email">
</div>

<div class="section">
  <h2>Datos del Medidor</h2>
  <label>Fecha y hora de inspección</label><input type="datetime-local" name="fechaInspeccion">
  <label>Latitud / Longitud</label><input type="text" name="latlng">
</div>

<div class="section">
  <h2>P1. Prueba de litraje inicial</h2>
  <label>Lectura inicial</label><input type="number" id="p1Ini">
  <label>Lectura final</label><input type="number" id="p1Fin">
  <label>Diferencia</label><input type="number" id="p1Diff" readonly>
</div>

<!-- P2 Mejorado - defectos siempre visibles (P2.1) -->
<div class="section">
  <h2>P2. Seguimiento de la IDA (Instalación de Aprovechamiento)</h2>
  <p class="small">P2.1 Detección de Defectos en IDA</p>
  <p class="small">P2.1 Detección de Defectos en IDA. Seleccione directamente los defectos aplicables, separados en Defectos Críticos / Precintado Total y Defectos Secundarios / Áreas de mejora.</p>

  <div id="p21Defectos">
  <div class="group-title">Defectos Críticos / Precintado Total</div>
  <label><input type="checkbox" class="p21-def" data-cat="crit" value="60B Exterior"> Fuga Visible (60B) Exterior</label>
  <label><input type="checkbox" class="p21-def" data-cat="crit" value="60B Fuga oculta"> (60B) Fuga oculta</label>
  <label><input type="checkbox" class="p21-def" data-cat="crit" value="60B Interior"> (60B) Interior</label>
  <label><input type="checkbox" class="p21-def" data-cat="crit" value="63 Fuga en válvula"> (63) Fuga en válvula</label>
  <label><input type="checkbox" class="p21-def" data-cat="crit" value="83 IDA fuera de norma"> (83) IDA fuera de norma</label>

  <div class="group-title" style="margin-top:10px">Defectos Secundarios / Áreas de mejora</div>
  <label><input type="checkbox" class="p21-def" data-cat="sec" value="1 Material fuera de norma"> (1) Material fuera de norma</label>
  <label><input type="checkbox" class="p21-def" data-cat="sec" value="16 Salida sin tapón"> (16) Salida sin tapón</label>
  <label><input type="checkbox" class="p21-def" data-cat="sec" value="3 IDA cercana a otros servicios"> (3) IDA cercana a otros servicios</label>
  <label><input type="checkbox" class="p21-def" data-cat="sec" value="4 Falta de sujeción"> (4) Falta de sujeción</label>
  <label><input type="checkbox" class="p21-def" data-cat="sec" value="5 Conexión de IDA dañada"> (5) Conexión de IDA dañada</label>
  <label><input type="checkbox" class="p21-def" data-cat="sec" value="87 IDA no identificada"> (87) IDA no identificada</label>
</div>

  <div id="p2Aparatos" style="margin-top:12px">
    <h3>P2.2 Detección de defectos en aparatos conectados</h3>
    <table class="three-col" id="tablaEquipos"></table>
  </div>

</div>

<div class="section">
  <h2>P4. Descripción de verificación</h2>
  <div id="p4Contenedor" class="muted">Seleccione defectos en P2 para generar esta sección.</div>
</div>

<div class="section actions">
  <button type="button" class="btn secondary" id="btnCancel">Cancelar</button>
  <button type="submit" class="btn primary">Guardar</button>
</div>

</form>

<!-- MODAL P2.2 -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <h3>Seleccionar defectos</h3>
    <div id="modalDefectos"></div>
    <div class="modal-actions">
      <button type="button" class="btn secondary" onclick="cerrarModal()">Cancelar</button>
      <button type="button" class="btn primary" onclick="guardarDefectos()">Guardar</button>
    </div>
  </div>
</div>

<script>
/* P1 diferencia */
const ini = document.getElementById('p1Ini');
const fin = document.getElementById('p1Fin');
const diff = document.getElementById('p1Diff');
function calc(){ diff.value = (Number(fin.value||0) - Number(ini.value||0)); }
ini.addEventListener('input', calc);
fin.addEventListener('input', calc);

/* Equipo y defectos (lista exacta) */
const P2_CRITICOS = [
  {code:'60B_ext', label:'(60B) Exterior'},
  {code:'60B_oculta', label:'(60B) Fuga oculta'},
  {code:'60B_int', label:'(60B) Interior'},
  {code:'63_valvula', label:'(63) Fuga en válvula'},
  {code:'83_fuera_norma', label:'(83) IDA fuera de norma'}
];
const P2_SECUNDARIOS = [
  {code:'1_material', label:'(1) Material fuera de norma'},
  {code:'16_sin_tapon', label:'(16) Salida sin tapón'},
  {code:'3_cercano', label:'(3) IDA cercana a otros servicios'},
  {code:'4_falta_sujecion', label:'(4) Falta de sujeción'},
  {code:'5_conexion_danada', label:'(5) Conexión de IDA dañada'},
  {code:'87_no_identificada', label:'(87) IDA no identificada'}
];

const EQUIPOS_ORDER = [
  {id:'CA', name:'CA - Calentador de Acumulación'},
  {id:'CP', name:'CP - Calentador de Paso'},
  {id:'ES', name:'ES - Estufa'},
  {id:'HO', name:'HO - Horno'},
  {id:'SE', name:'SE - Secador'},
  {id:'CL', name:'CL - Calentador'},
  {id:'VS', name:'VS - Válvula Sin Aparato'}
];

const DEFECTOS_APARATO = [
  '(10) Dificultad de cierre',
  '(13) Zona de ventilación permanente',
  '(14) Material fuera de norma aparato',
  '(17) Aparato fijo sin conexión fija',
  '(61) Fuga en manguera interior',
  '(62) Fuga en aparato',
  '(63) Fuga en válvula',
  '(64) Manguera dañada interior',
  '(65) Sin ventilación permanente primer piso',
  '(66) Sin conducto de evacuación de gases',
  '(67) Fuga en manguera exterior',
  '(68) Manguera dañada exterior',
  '(80) Monóxido de carbono (CO) ppm',
  '(85) Sin ventilación permanente por debajo del primer sótano',
  '(86) Elemento de cierre'
];

const p4Cont = document.getElementById('p4Contenedor');
const tablaEquipos = document.getElementById('tablaEquipos');
const modal = document.getElementById('modalOverlay');
const modalDefectos = document.getElementById('modalDefectos');
const defectosPorEquipo = {};
let equipoActivo = null;

function renderEquipos(){
  let row;
  EQUIPOS_ORDER.forEach((eq, i) => {
    if(i % 3 === 0) row = tablaEquipos.insertRow();
    const cell = row.insertCell();
    cell.className = 'eq-box';
    cell.innerHTML = `
      <div class="eq-header">
        <strong>${eq.name}</strong>
        <input type="number" min="0" value="0" data-eq="${eq.id}" class="qty">
      </div>
      <div id="co_${eq.id}" class="co-box hidden">
        <input type="number" min="0" placeholder="CO ppm">
      </div>
      <button type="button" class="btn secondary hidden" id="btn_${eq.id}" onclick="abrirModal('${eq.id}')">Defectos</button>
      <div class="selected-list" id="list_${eq.id}"></div>
    `;
  });
}

document.addEventListener('input',e=>{
  if(e.target.classList.contains('qty')){
    const eq = e.target.dataset.eq;
    const qty = Number(e.target.value || 0);
    const coBox = document.getElementById('co_' + eq);
    const btn = document.getElementById('btn_' + eq);
    const list = document.getElementById('list_' + eq);

    if(qty > 0){
      coBox.classList.remove('hidden');
      btn.classList.remove('hidden');
    } else {
      coBox.classList.add('hidden');
      btn.classList.add('hidden');
      list.innerHTML = '';
      defectosPorEquipo[eq] = [];
      syncP4();
    }
  }
});

function abrirModal(eq){
  equipoActivo = eq;
  const current = defectosPorEquipo[eq] || [];
  modal.style.display = 'flex';
  modalDefectos.innerHTML = DEFECTOS_APARATO.map(d=>{
    const checked = current.includes(d) ? 'checked' : '';
    return `<label><input type="checkbox" value="${d}" ${checked}> ${d}</label>`;
  }).join('');
}

function cerrarModal(){
  modal.style.display = 'none';
}

function guardarDefectos(){
  if(!equipoActivo) return;
  const checks = Array.from(modalDefectos.querySelectorAll('input:checked'));
  const selected = checks.map(c => c.value);
  defectosPorEquipo[equipoActivo] = selected;
  const list = document.getElementById('list_' + equipoActivo);
  list.innerHTML = selected.map(item => `<span class="selected-item">${item}</span>`).join('');
  cerrarModal();
  syncP4();
}

window.abrirModal = abrirModal;
window.cerrarModal = cerrarModal;
window.guardarDefectos = guardarDefectos;

// Delegate change on defect checkboxes
document.addEventListener('change', e=>{
  if(e.target && e.target.classList && e.target.classList.contains('def-checkbox')){
    syncP4();
  }
});

// Sync to P4 (pre-filled descriptions)
function syncP4(){
  p4Cont.innerHTML = '';
  const p21Checked = Array.from(document.querySelectorAll('.p21-def')).filter(i=>i.checked);
  const equiposConDefectos = Object.entries(defectosPorEquipo).filter(([, defects]) => defects.length > 0);
  if(p21Checked.length===0 && equiposConDefectos.length===0){ p4Cont.innerHTML = '<span class="muted">Sin defectos seleccionados.</span>'; return; }

  if(p21Checked.length>0){
    const box = document.createElement('div'); box.className='defecto';
    let inner = `<strong>IDA</strong>`;
    p21Checked.forEach(d=>{
      inner += `<div style="margin-top:6px"><em>${d.parentNode.textContent.trim()}</em><textarea rows="2">Se detecta ${d.parentNode.textContent.trim().toLowerCase()}. Proceder según normativa.</textarea></div>`;
    });
    box.innerHTML = inner; p4Cont.appendChild(box);
  }
  equiposConDefectos.forEach(([eq, defects]) => {
    const eqName = (EQUIPOS_ORDER.find(x=>x.id===eq)||{}).name || eq;
    const box = document.createElement('div'); box.className='defecto';
    let inner = `<strong>${eqName}</strong>`;
    defects.forEach(defecto=>{
      inner += `<div style="margin-top:6px"><em>${defecto}</em><textarea rows="2">Se detecta ${defecto.toLowerCase()} en ${eqName.toLowerCase()}. Proceder según normativa.</textarea></div>`;
    });
    box.innerHTML = inner; p4Cont.appendChild(box);
  });
}

renderEquipos();

// Cancel
document.getElementById('btnCancel').addEventListener('click', ()=>{ if(confirm('Limpiar formulario?')) location.reload(); });
</script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBLqVCqW2s7piZQUH0dHODjK4JXAv74TdA",
  authDomain: "asl-apk.firebaseapp.com",
  projectId: "asl-apk",
  storageBucket: "asl-apk.firebasestorage.app",
  messagingSenderId: "803053462437",
  appId: "1:803053462437:web:b2f4ccb8cd63c489c77e4c"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const ref = await addDoc(collection(db, "db"), {
  prueba_directa: "SI FUNCIONA",
  fecha: new Date()
});

console.log("ID creado:", ref.id);
alert("Intento realizado");
</script>

</body>
</html>
